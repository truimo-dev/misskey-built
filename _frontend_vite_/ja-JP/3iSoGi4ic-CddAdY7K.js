import{b as Q,Z as ve,a as p,c as P,w as ue,e as ce,H as _e,z as W,l as i,i as t,j as xe,p as f,S as be,t as C,C as x,E as h,f as F,q as fe,n as we,B as b,h as I,D as A,F as V,A as ee,o as Me,u as Ae,L as he,M as Te,G as Ce,T as Fe,v as Se}from"./3iSoGi4ic-D0mTJ0Mu.js";import{b5 as De,a0 as q,c0 as Ue,aa as oe,A as re,t as $e,u as Re,b as H,af as Ee,J as U,c1 as Le,a7 as ge,M as X,Q as de,aA as ne,ak as Ie,ab as Oe,L as J,C as ie,c2 as Ve,az as Be,R as pe,aH as ye,bP as Ne,b$ as He,h as Pe,aN as ze}from"./3iSoGi4ic-DV-GuiCp.js";import{X as ke}from"./3iSoGi4ic-D3TJKvmz.js";import{M as Ke}from"./3iSoGi4ic-DtDbNQ4_.js";import{M as le}from"./3iSoGi4ic-Cj3FgKaq.js";import{M as qe}from"./3iSoGi4ic-BDF7xMl0.js";import"./3iSoGi4ic-B1GPmOGN.js";import"./3iSoGi4ic-D98_HDRS.js";import"./3iSoGi4ic-DID2kkuO.js";import"./3iSoGi4ic-CS6W3O_2.js";const Je=["placeholder","readonly"],We=["disabled","title"],Xe={key:0,class:"ti ti-send"},Qe=Q({__name:"room.form",props:{user:{},room:{}},setup(w){const v=w,g=ve(),d=ve(),o=p(""),r=p(null),y=p(!1),u=p(!1);let M=null;const s=P(()=>o.value!=null&&o.value!==""||r.value!=null);function m(){return v.user?"user:"+v.user.id:"room:"+v.room?.id}ue([o,r],j);async function c(e){if(!e.clipboardData)return;const _="yyyy-MM-dd HH-mm-ss [{{number}}]",T=e.clipboardData.items;if(T.length===1){if(T[0].kind==="file"){const S=T[0].getAsFile();if(!S)return;const N=S.name.lastIndexOf("."),D=N>=0?S.name.slice(N):"",se=Ue(new Date(S.lastModified),_).replace(/{{number}}/g,"1")+D,ae=new File([S],se,{type:S.type});oe([ae],{multiple:!1}).then(n=>{r.value=n[0]})}}else T[0].kind==="file"&&re({type:"error",text:"メッセージに添付できるファイルはひとつです"})}function R(e){if(!e.dataTransfer)return;if(e.dataTransfer.items[0].kind==="file"||$e(e,["driveFiles"]))switch(e.preventDefault(),e.dataTransfer.effectAllowed){case"all":case"uninitialized":case"copy":case"copyLink":case"copyMove":e.dataTransfer.dropEffect="copy";break;case"linkMove":case"move":e.dataTransfer.dropEffect="move";break;default:e.dataTransfer.dropEffect="none";break}}function z(e){if(e.dataTransfer){if(e.dataTransfer.files.length===1){e.preventDefault(),oe([Array.from(e.dataTransfer.files)[0]],{multiple:!1});return}else if(e.dataTransfer.files.length>1){e.preventDefault(),re({type:"error",text:"メッセージに添付できるファイルはひとつです"});return}{const _=Re(e,"driveFiles");_!=null&&(r.value=_[0],e.preventDefault())}}}function te(e){e.key==="Enter"&&(H.s["chat.sendOnEnter"]?e.ctrlKey||e.metaKey||e.shiftKey||O():(e.ctrlKey||e.metaKey)&&O())}function B(e){Ee({anchorElement:e.currentTarget??e.target,multiple:!1,label:"ファイルを選択"}).then(_=>{r.value=_})}function K(){d.value==null||d.value.files==null||d.value.files[0]&&oe(Array.from(d.value.files),{multiple:!1}).then(e=>{r.value=e[0]})}function O(){s.value&&(y.value=!0,v.user?U("chat/messages/create-to-user",{toUserId:v.user.id,text:o.value?o.value:void 0,fileId:r.value?r.value.id:void 0}).then(e=>{Y()}).catch(e=>{console.error(e)}).then(()=>{y.value=!1}):v.room&&U("chat/messages/create-to-room",{toRoomId:v.room.id,text:o.value?o.value:void 0,fileId:r.value?r.value.id:void 0}).then(e=>{Y()}).catch(e=>{console.error(e)}).then(()=>{y.value=!1}))}function Y(){o.value="",r.value=null,G()}function j(){const e=JSON.parse(q.getItem("chatMessageDrafts")||"{}");e[m()]={updatedAt:new Date,data:{text:o.value,file:r.value}},q.setItem("chatMessageDrafts",JSON.stringify(e))}function G(){const e=JSON.parse(q.getItem("chatMessageDrafts")||"{}");delete e[m()],q.setItem("chatMessageDrafts",JSON.stringify(e))}async function Z(e){u.value=!0;const _=e.currentTarget??e.target;if(_==null)return;let L=g.value?.selectionStart??0,T=g.value?.selectionEnd??o.value.length;Le.show(_,S=>{const N=o.value.substring(0,L),D=o.value.substring(T);o.value=N+S+D,L+=S.length,T+=S.length},()=>{u.value=!1,we(()=>focus())})}return ce(()=>{g.value!=null&&(M=new De(g.value,o));const e=JSON.parse(q.getItem("chatMessageDrafts")||"{}")[m()];e&&(o.value=e.data.text,r.value=e.data.file)}),_e(()=>{M&&(M.detach(),M=null)}),(e,_)=>{const L=W("MkLoading");return t(),i("div",{class:"xM5nM",onDragover:fe(R,["stop"]),onDrop:fe(z,["stop"])},[xe(f("textarea",{ref_key:"textareaEl",ref:g,"onUpdate:modelValue":_[0]||(_[0]=T=>o.value=T),class:"xzc14 _acrylic",placeholder:"ここにメッセージを入力",readonly:u.value,onKeydown:te,onPaste:c},null,42,Je),[[be,o.value]]),f("footer",{class:"xsmkb"},[r.value?(t(),i("div",{key:0,class:"xwTSx",onClick:_[1]||(_[1]=T=>r.value=null)},h(r.value.name),3)):x("",!0),f("div",{class:"x7gN8"},[f("button",{class:"_button xbIF4",onClick:B},[..._[2]||(_[2]=[f("i",{class:"ti ti-photo-plus"},null,-1)])],2),f("button",{class:"_button xbIF4",onClick:Z},[..._[3]||(_[3]=[f("i",{class:"ti ti-mood-happy"},null,-1)])],2),f("button",{class:"_button xbIF4 xkHUc",disabled:!s.value||y.value,title:"送信",onClick:O},[y.value?x("",!0):(t(),i("i",Xe)),y.value?(t(),F(L,{key:1,em:!0})):x("",!0)],10,We)],2)],2),f("input",{ref_key:"fileEl",ref:d,style:{display:"none"},type:"file",onChange:K},null,544)],34)}}});const Ye={class:"_gaps"},je={key:0,class:"_gaps_s"},Ge=Q({__name:"room.search",props:{userId:{},roomId:{}},setup(w){const v=w,g=p(""),d=p(!1),o=p([]);async function r(){const y=await U("chat/messages/search",{query:g.value,roomId:v.roomId,userId:v.userId});o.value=y,d.value=!0}return(y,u)=>{const M=W("MkResult");return t(),i("div",Ye,[b(ge,{modelValue:g.value,"onUpdate:modelValue":u[0]||(u[0]=s=>g.value=s),placeholder:"メッセージを検索",type:"search",onEnter:u[1]||(u[1]=s=>r())},{prefix:I(()=>[...u[2]||(u[2]=[f("i",{class:"ti ti-search"},null,-1)])]),_:1},8,["modelValue","placeholder"]),b(X,{primary:"",rounded:"",onClick:r},{default:I(()=>[A(h("検索"),1)]),_:1}),d.value?(t(),F(Ke,{key:0},{header:I(()=>[A(h("検索結果"),1)]),default:I(()=>[o.value.length>0?(t(),i("div",je,[(t(!0),i(V,null,ee(o.value,s=>(t(),i("div",{key:s.id,class:"xr6lw"},[b(ke,{message:s,user:s.fromUser,isSearchResult:!0},null,8,["message","user"])],2))),128))])):(t(),F(M,{key:1,type:"notFound"}))]),_:1})):x("",!0)])}}});const Ze={class:"_gaps"},et={key:1},tt=Q({__name:"room.members",props:{room:{}},emits:["inviteUser"],setup(w,{emit:v}){const g=de(),d=w,o=v,r=P(()=>d.room.ownerId===g.id),y=p([]),u=p([]);return ce(async()=>{y.value=await U("chat/rooms/members",{roomId:d.room.id,limit:50}),r.value&&(u.value=await U("chat/rooms/invitations/outbox",{roomId:d.room.id,limit:50}))}),(M,s)=>{const m=W("MkA");return t(),i("div",Ze,[r.value?(t(),F(X,{key:0,primary:"",rounded:"",style:{margin:"0 auto"},onClick:s[0]||(s[0]=c=>o("inviteUser"))},{default:I(()=>[s[1]||(s[1]=f("i",{class:"ti ti-plus"},null,-1)),A(" "+h("ユーザーを招待"),1)]),_:1})):x("",!0),b(m,{class:"xeiFV",to:`${C(ne)(w.room.owner)}`},{default:I(()=>[b(le,{user:w.room.owner},null,8,["user"])]),_:1},8,["class","to"]),y.value.length>0?(t(),i("hr",et)):x("",!0),(t(!0),i(V,null,ee(y.value,c=>(t(),i("div",{key:c.id,class:"xzvWK"},[b(m,{class:"xeiFV",to:`${C(ne)(c.user)}`},{default:I(()=>[b(le,{user:c.user},null,8,["user"])]),_:2},1032,["class","to"])],2))),128)),r.value?(t(),i(V,{key:2},[s[2]||(s[2]=f("hr",null,null,-1)),f("div",null,h("送信した招待"),1),(t(!0),i(V,null,ee(u.value,c=>(t(),i("div",{key:c.id,class:"xbJfa"},[b(m,{class:"xsL9v",to:`${C(ne)(c.user)}`},{default:I(()=>[b(le,{user:c.user},null,8,["user"])]),_:2},1032,["class","to"])],2))),128))],64)):x("",!0)])}}});const st={class:"_gaps"},at=Q({__name:"room.info",props:{room:{}},setup(w){const v=Ie(),g=de(),d=w,o=P(()=>d.room.ownerId===g.id),r=p(d.room.name),y=p(d.room.description);function u(){J("chat/rooms/update",{roomId:d.room.id,name:r.value,description:y.value})}async function M(){const{canceled:m}=await ie({type:"warning",text:(({x})=>("「"+x+"」を削除しますか？"))({x:r.value})});m||(await J("chat/rooms/delete",{roomId:d.room.id}),v.push("/chat"))}const s=p(d.room.isMuted??!1);return ue(s,async()=>{await J("chat/rooms/mute",{roomId:d.room.id,mute:s.value})}),(m,c)=>(t(),i("div",st,[b(ge,{modelValue:r.value,"onUpdate:modelValue":c[0]||(c[0]=R=>r.value=R),disabled:!o.value},{label:I(()=>[A(h("名前"),1)]),_:1},8,["modelValue","disabled"]),b(qe,{modelValue:y.value,"onUpdate:modelValue":c[1]||(c[1]=R=>y.value=R),disabled:!o.value},{label:I(()=>[A(h("説明"),1)]),_:1},8,["modelValue","disabled"]),o.value?(t(),F(X,{key:0,primary:"",onClick:u},{default:I(()=>[A(h("保存"),1)]),_:1})):x("",!0),c[3]||(c[3]=f("hr",null,null,-1)),o.value||C(g).isAdmin||C(g).isModerator?(t(),F(X,{key:1,danger:"",onClick:M},{default:I(()=>[A(h("グループを削除"),1)]),_:1})):x("",!0),o.value?x("",!0):(t(),F(Oe,{key:2,modelValue:s.value,"onUpdate:modelValue":c[2]||(c[2]=R=>s.value=R)},{label:I(()=>[A(h("このグループをミュート"),1)]),_:1},8,["modelValue"]))]))}});function ot(w,v,g){const d=new MutationObserver(g);ue(w,o=>{o&&d.observe(o,v)},{immediate:!0}),Me(()=>{d.disconnect()})}const nt={key:0,class:"_spacer",style:{"--MI_SPACER-w":"700px"}},lt={class:"_gaps"},rt={key:0},it={key:1},ut={class:"_gaps",style:{"text-align":"center"}},ct={key:0},dt={key:1},mt={key:2},vt={key:3},ft={key:1},ht={key:0},pt={key:3},yt={key:1,class:"_spacer",style:{"--MI_SPACER-w":"700px"}},_t={key:2,class:"_spacer",style:{"--MI_SPACER-w":"700px"}},xt={key:3,class:"_spacer",style:{"--MI_SPACER-w":"700px"}},gt={class:"_gaps"},It=200,Et=Q({__name:"room",props:{userId:{},roomId:{}},setup(w){const v=de(),g=Ie(),d=w,o=p(!1),r=p(!1),y=p(!1),u=p([]),M=p(!1),s=p(null),m=p(null),c=p(null),R=p(!1),z=Ae("timelineEl"),te=Ve(u);ot(z,{subtree:!0,childList:!0,attributes:!1},()=>{const n=ze(z.value);-n.scrollTop<It&&n.scrollTo({top:0,behavior:"instant"})});function B(n){return{...n,fromUser:n.fromUser??(n.fromUserId===v.id?v:s.value),reactions:n.reactions.map(l=>({...l,user:l.user??(n.fromUserId===v.id?s.value:v)}))}}async function K(){if(!o.value){if(o.value=!0,r.value=!1,d.userId){const[l,k]=await Promise.all([U("users/show",{userId:d.userId}),U("chat/messages/user-timeline",{userId:d.userId,limit:20})]);s.value=l,u.value=k.map($=>B($)),u.value.length===20&&(M.value=!0),c.value=ye().useChannel("chatUser",{otherId:s.value.id}),c.value.on("message",j),c.value.on("deleted",G),c.value.on("react",Z),c.value.on("unreact",e)}else if(d.roomId){const[l,k]=await Promise.allSettled([U("chat/rooms/show",{roomId:d.roomId}),U("chat/messages/room-timeline",{roomId:d.roomId,limit:20})]);if(l.status==="rejected"){re({type:"error",text:"問題が発生しました"}),o.value=!1;return}const $=l.value;if($.invitationExists)if((await ie({type:"question",title:$.name,text:"あなたはこのグループの参加者ではありませんが、招待が届いています。参加するには、招待を承認してください。"+`
`+"招待を承認しますか？"})).canceled){o.value=!1,g.push("/chat");return}else{await J("chat/rooms/join",{roomId:$.id}),o.value=!1,K();return}const E=k.status==="fulfilled"?k.value:[];m.value=$,u.value=E.map(me=>B(me)),u.value.length===20&&(M.value=!0),c.value=ye().useChannel("chatRoom",{roomId:m.value.id}),c.value.on("message",j),c.value.on("deleted",G),c.value.on("react",Z),c.value.on("unreact",e)}window.document.addEventListener("visibilitychange",L),r.value=!0,o.value=!1}}let O=!0;he(()=>{O=!0}),Te(()=>{O=!1});async function Y(){y.value=!0;const l=d.userId?await U("chat/messages/user-timeline",{userId:s.value.id,limit:30,untilId:u.value[u.value.length-1].id}):await U("chat/messages/room-timeline",{roomId:m.value.id,limit:30,untilId:u.value[u.value.length-1].id});u.value.push(...l.map(k=>B(k))),M.value=l.length===30,y.value=!1}function j(n){Ne("chatMessage"),u.value.unshift(B(n)),n.fromUserId!==v.id&&!window.document.hidden&&O&&c.value?.send("read",{id:n.id}),n.fromUserId,v.id}function G(n){const l=u.value.findIndex(k=>k.id===n);l!==-1&&u.value.splice(l,1)}function Z(n){const l=u.value.find(k=>k.id===n.messageId);l&&(m.value==null?l.reactions.push({reaction:n.reaction,user:l.fromUserId===v.id?s.value:v}):l.reactions.push({reaction:n.reaction,user:n.user}))}function e(n){const l=u.value.find(k=>k.id===n.messageId);if(l){const k=l.reactions.findIndex($=>$.reaction===n.reaction&&$.user.id===n.user.id);k!==-1&&l.reactions.splice(k,1)}}function _(){R.value=!1}function L(){window.document.hidden}ce(()=>{K()}),he(()=>{r.value||K()}),_e(()=>{c.value?.dispose(),window.document.removeEventListener("visibilitychange",L)});async function T(){if(m.value==null)return;const n=await He({includeSelf:!1,localOnly:!0});J("chat/rooms/invitations/create",{roomId:m.value.id,userId:n.id})}async function S(){if(m.value==null)return;const{canceled:n}=await ie({type:"warning",text:"よろしいですか？"});n||(U("chat/rooms/leave",{roomId:m.value.id}),g.push("/chat"))}function N(n){const l=[];m.value&&(m.value.ownerId===v.id?l.push({text:"ユーザーを招待",icon:"ti ti-user-plus",action:()=>{T()}}):l.push({text:"グループから退出",icon:"ti ti-x",action:()=>{S()}})),Pe(l,n.currentTarget??n.target)}const D=p("chat"),se=P(()=>m.value?[{key:"chat",title:"メッセージ",icon:"ti ti-messages"},{key:"members",title:"メンバー",icon:"ti ti-users"},{key:"search",title:"検索",icon:"ti ti-search"},{key:"info",title:"情報",icon:"ti ti-info-circle"}]:[{key:"chat",title:"メッセージ",icon:"ti ti-messages"},{key:"search",title:"検索",icon:"ti ti-search"}]),ae=P(()=>[{icon:"ti ti-dots",handler:N}]);return Be(P(()=>r.value?s.value?{userName:s.value,title:s.value.name??s.value.username,avatar:s.value}:m.value?{title:m.value.name,icon:"ti ti-users"}:{title:"ダイレクトメッセージ"}:{title:"ダイレクトメッセージ"})),(n,l)=>{const k=W("MkLoading"),$=W("PageWithHeader");return t(),F($,{tab:D.value,"onUpdate:tab":l[0]||(l[0]=E=>D.value=E),reversed:D.value==="chat",tabs:se.value,actions:ae.value},{footer:I(()=>[D.value==="chat"?(t(),i("div",{key:0,class:"xBTrq"},[f("div",gt,[b(Fe,{name:"fade"},{default:I(()=>[xe(f("div",{class:"x2LHQ"},[f("button",{class:"_buttonPrimary xgwO6",onClick:_},[f("i",{class:"fas ti-fw fa-arrow-circle-down x9r5d"},null,2),A(h("新しいメッセージ"),1)],2)],2),[[Se,R.value]])]),_:1}),r.value?(t(),F(Qe,{key:0,user:s.value,room:m.value,class:"x7xcz"},null,8,["user","room","class"])):x("",!0)])],2)):x("",!0)]),default:I(()=>[D.value==="chat"?(t(),i("div",nt,[f("div",lt,[o.value?(t(),i("div",rt,[b(k)])):u.value.length===0?(t(),i("div",it,[f("div",ut,[f("div",null,h("まだメッセージはありません"),1),s.value?(t(),i(V,{key:0},[s.value.chatScope==="followers"?(t(),i("div",ct,h("このユーザーはフォロワーからのみメッセージを受け付けています。"),1)):s.value.chatScope==="following"?(t(),i("div",dt,h("このユーザーは、このユーザーがフォローしているユーザーからのみメッセージを受け付けています。"),1)):s.value.chatScope==="mutual"?(t(),i("div",mt,h("このユーザーは相互フォローのユーザーからのみメッセージを受け付けています。"),1)):s.value.chatScope==="none"?(t(),i("div",vt,h("このユーザーは誰からもメッセージを受け付けていません。"),1)):x("",!0)],64)):m.value?(t(),i("div",ft,h("ユーザーを招待してメッセージを送信しましょう"),1)):x("",!0)])])):(t(),i("div",{key:2,ref_key:"timelineEl",ref:z,class:"_gaps"},[M.value?(t(),i("div",ht,[b(X,{class:"x1nwv",wait:y.value,primary:"",rounded:"",onClick:Y},{default:I(()=>[A(h("もっと見る"),1)]),_:1},8,["class","wait"])])):x("",!0),b(Ce,{enterActiveClass:C(H).s.animation?"xqPVy":"",leaveActiveClass:C(H).s.animation?"xrrAm":"",enterFromClass:C(H).s.animation?"xAhmc":"",leaveToClass:C(H).s.animation?"xCmRK":"",moveClass:C(H).s.animation?"xAebt":"",tag:"div",class:"_gaps"},{default:I(()=>[(t(!0),i(V,null,ee(C(te).toReversed(),E=>(t(),i(V,{key:E.id},[E.type==="item"?(t(),F(ke,{key:0,message:E.data},null,8,["message"])):E.type==="date"?(t(),i("div",{key:1,class:"x6Wy7"},[f("span",null,[l[1]||(l[1]=f("i",{class:"ti ti-chevron-up"},null,-1)),A(" "+h(E.nextText),1)]),l[3]||(l[3]=f("span",{style:{height:"1em",width:"1px",background:"var(--MI_THEME-divider)"}},null,-1)),f("span",null,[A(h(E.prevText)+" ",1),l[2]||(l[2]=f("i",{class:"ti ti-chevron-down"},null,-1))])],2)):x("",!0)],64))),128))]),_:1},8,["enterActiveClass","leaveActiveClass","enterFromClass","leaveToClass","moveClass"])],512)),s.value&&(!s.value.canChat||s.value.host!==null)?(t(),i("div",pt,[b(pe,{warn:""},{default:I(()=>[A(h("相手のアカウントでダイレクトメッセージが使えない状態になっています。"),1)]),_:1})])):x("",!0),C(v).policies.chatAvailability!=="available"?(t(),F(pe,{key:4,warn:""},{default:I(()=>[A(h(C(v).policies.chatAvailability==="readonly"?"このサーバー、またはこのアカウントでダイレクトメッセージは読み取り専用となっています。新たに書き込んだり、グループを作成・参加したりすることはできません。":"このサーバー、またはこのアカウントでダイレクトメッセージは有効化されていません。"),1)]),_:1})):x("",!0)])])):D.value==="search"?(t(),i("div",yt,[b(Ge,{userId:w.userId,roomId:w.roomId},null,8,["userId","roomId"])])):D.value==="members"?(t(),i("div",_t,[m.value!=null?(t(),F(tt,{key:0,room:m.value,onInviteUser:T},null,8,["room"])):x("",!0)])):D.value==="info"?(t(),i("div",xt,[m.value!=null?(t(),F(at,{key:0,room:m.value},null,8,["room"])):x("",!0)])):x("",!0)]),_:1},8,["tab","reversed","tabs","actions"])}}});export{Et as default};
