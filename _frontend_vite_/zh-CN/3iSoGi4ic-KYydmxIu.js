import{T as i,u as R,a as n,A as c,b as u,p as q,c as B,N as _,d as $,e as S}from"./3iSoGi4ic-nJzNoieu.js";const D=55296,M=56319,U=56320,G=57343,W=/^[0-9a-fA-F]$/;function L(r,e=0){if(e<0||e>=r.length)return!1;const t=r.charCodeAt(e);return t>=D&&t<=M}function H(r,e=0){if(e<0||e>=r.length)return!1;const t=r.charCodeAt(e);return t>=U&&t<=G}function A(r,e=0){return L(r,e)&&H(r,e+1)}function V(r){let e="",t="string",s="";for(let a=0;a<r.length;a++){const l=r[a];switch(t){case"string":{l==="\\"?t="escape":e+=l;break}case"escape":{if(l!=="u")throw new SyntaxError("invalid escape sequence");t="digit";break}case"digit":{if(W.test(l))s+=l;else throw new SyntaxError("invalid escape sequence");s.length===4&&(e+=String.fromCharCode(Number.parseInt(s,16)),t="string",s="");break}}}if(t!=="string")throw new SyntaxError("invalid escape sequence");return e}class j{pages;firstPageIndex;lastPageIndex;pageIndex;address;_char;line;column;constructor(e,t){this.pages=new Map,this.pages.set(0,e),this.firstPageIndex=0,this.lastPageIndex=0,this.pageIndex=0,this.address=0,this.line=t?.line??0,this.column=t?.column??0,this.moveNext()}get eof(){return this.endOfPage&&this.isLastPage}get char(){if(this.eof)throw new Error("end of stream");return this._char}getPos(){return{line:this.line+1,column:this.column+1}}next(){!this.eof&&this._char===`
`?(this.line++,this.column=0):this.column+=this._char.length,this.incAddr(),this.moveNext()}prev(){if(this.movePrev(),this.decAddr(),!this.startOfFile&&this._char===`
`){this.line--;const e=this.pages.get(this.pageIndex),t=e.lastIndexOf(`
`,this.address-1),s=t>=0?t+1:0,a=e.slice(s,this.address);this.column=a.length}else this.column-=this._char.length}get isFirstPage(){return this.pageIndex<=this.firstPageIndex}get isLastPage(){return this.pageIndex>=this.lastPageIndex}get endOfPage(){const e=this.pages.get(this.pageIndex);return this.address>=e.length}get startOfFile(){return this.isFirstPage&&this.address===0}moveNext(){for(this.loadChar();;){if(!this.eof&&this._char==="\r"){this.incAddr(),this.loadChar();continue}break}}incAddr(){this.endOfPage?this.isLastPage||(this.pageIndex++,this.address=0):this.address+=this._char.length}movePrev(){for(this.loadPrevChar();!this.startOfFile&&this._char==="\r";)this.decAddr(),this.loadPrevChar()}decAddr(){if(this.address>0)this.address-=w(this.pages.get(this.pageIndex),this.address).length;else if(!this.isFirstPage){this.pageIndex--;const e=this.pages.get(this.pageIndex);this.address=e.length-w(e).length}}loadChar(){this.eof?this._char=void 0:this._char=X(this.pages.get(this.pageIndex),this.address)}loadPrevChar(){if(this.address>0)this._char=w(this.pages.get(this.pageIndex),this.address);else if(!this.isFirstPage){const e=this.pages.get(this.pageIndex-1);this._char=w(e)}}}function X(r,e=0){return A(r,e)?r.slice(e,e+2):r[e]}function w(r,e=r.length){return A(r,e-2)?r.slice(e-2,e):r[e-1]}const b=[" ","	"],P=["\r",`
`],E=/^[0-9]$/,z=/^[A-Za-z_]$/u,Z=/^[A-Za-z0-9_]$/u,J=/^[0-9a-fA-F]$/;class Q{stream;_tokens=[];constructor(e){typeof e=="string"?this.stream=new j(e):this.stream=e,this._tokens.push(this.readToken())}getToken(){return this._tokens[0]}is(e){return this.getTokenKind()===e}getTokenKind(){return this.getToken().kind}getTokenValue(){return this.getToken().value}getPos(){return this.getToken().pos}next(){this._tokens[0].kind!==i.EOF&&(this._tokens.shift(),this._tokens.length===0&&this._tokens.push(this.readToken()))}lookahead(e){for(;this._tokens.length<=e;)this._tokens.push(this.readToken());return this._tokens[e]}expect(e){if(!this.is(e))throw R(this.getTokenKind(),this.getPos())}readToken(){let e=!1;for(;;){if(this.stream.eof)return n(i.EOF,this.stream.getPos(),{hasLeftSpacing:e});if(b.includes(this.stream.char)){this.stream.next(),e=!0;continue}const t=this.stream.getPos();if(P.includes(this.stream.char))return this.skipEmptyLines(),n(i.NewLine,t,{hasLeftSpacing:e});switch(this.stream.char){case"!":return this.stream.next(),!this.stream.eof&&this.stream.char==="="?(this.stream.next(),n(i.NotEq,t,{hasLeftSpacing:e})):n(i.Not,t,{hasLeftSpacing:e});case'"':case"'":return this.readStringLiteral(e);case"#":if(this.stream.next(),!this.stream.eof&&this.stream.char==="#"){if(this.stream.next(),!this.stream.eof&&this.stream.char==="#")return this.stream.next(),n(i.Sharp3,t,{hasLeftSpacing:e});throw new c('invalid sequence of characters: "##"',t)}else return!this.stream.eof&&this.stream.char==="["?(this.stream.next(),n(i.OpenSharpBracket,t,{hasLeftSpacing:e})):n(i.Sharp,t,{hasLeftSpacing:e});case"%":return this.stream.next(),n(i.Percent,t,{hasLeftSpacing:e});case"&":{if(this.stream.next(),!this.stream.eof&&this.stream.char==="&")return this.stream.next(),n(i.And2,t,{hasLeftSpacing:e});throw new c('invalid character: "&"',t)}case"(":return this.stream.next(),n(i.OpenParen,t,{hasLeftSpacing:e});case")":return this.stream.next(),n(i.CloseParen,t,{hasLeftSpacing:e});case"*":return this.stream.next(),n(i.Asterisk,t,{hasLeftSpacing:e});case"+":return this.stream.next(),!this.stream.eof&&this.stream.char==="="?(this.stream.next(),n(i.PlusEq,t,{hasLeftSpacing:e})):n(i.Plus,t,{hasLeftSpacing:e});case",":return this.stream.next(),n(i.Comma,t,{hasLeftSpacing:e});case"-":return this.stream.next(),!this.stream.eof&&this.stream.char==="="?(this.stream.next(),n(i.MinusEq,t,{hasLeftSpacing:e})):n(i.Minus,t,{hasLeftSpacing:e});case".":return this.stream.next(),n(i.Dot,t,{hasLeftSpacing:e});case"/":if(this.stream.next(),!this.stream.eof&&this.stream.char==="*"){this.stream.next(),this.skipCommentRange();continue}else if(!this.stream.eof&&this.stream.char==="/"){this.stream.next(),this.skipCommentLine();continue}else return n(i.Slash,t,{hasLeftSpacing:e});case":":return this.stream.next(),!this.stream.eof&&this.stream.char===":"?(this.stream.next(),n(i.Colon2,t,{hasLeftSpacing:e})):n(i.Colon,t,{hasLeftSpacing:e});case";":return this.stream.next(),n(i.SemiColon,t,{hasLeftSpacing:e});case"<":return this.stream.next(),!this.stream.eof&&this.stream.char==="="?(this.stream.next(),n(i.LtEq,t,{hasLeftSpacing:e})):!this.stream.eof&&this.stream.char===":"?(this.stream.next(),n(i.Out,t,{hasLeftSpacing:e})):n(i.Lt,t,{hasLeftSpacing:e});case"=":return this.stream.next(),!this.stream.eof&&this.stream.char==="="?(this.stream.next(),n(i.Eq2,t,{hasLeftSpacing:e})):!this.stream.eof&&this.stream.char===">"?(this.stream.next(),n(i.Arrow,t,{hasLeftSpacing:e})):n(i.Eq,t,{hasLeftSpacing:e});case">":return this.stream.next(),!this.stream.eof&&this.stream.char==="="?(this.stream.next(),n(i.GtEq,t,{hasLeftSpacing:e})):n(i.Gt,t,{hasLeftSpacing:e});case"?":return this.stream.next(),n(i.Question,t,{hasLeftSpacing:e});case"@":return this.stream.next(),n(i.At,t,{hasLeftSpacing:e});case"[":return this.stream.next(),n(i.OpenBracket,t,{hasLeftSpacing:e});case"\\":{if(this.stream.next(),!this.stream.eof&&this.stream.char==="u"){this.stream.prev();const s=this.tryReadWord(e);if(s)return s}return n(i.BackSlash,t,{hasLeftSpacing:e})}case"]":return this.stream.next(),n(i.CloseBracket,t,{hasLeftSpacing:e});case"^":return this.stream.next(),n(i.Hat,t,{hasLeftSpacing:e});case"`":return this.readTemplate(e);case"{":return this.stream.next(),n(i.OpenBrace,t,{hasLeftSpacing:e});case"|":return this.stream.next(),!this.stream.eof&&this.stream.char==="|"?(this.stream.next(),n(i.Or2,t,{hasLeftSpacing:e})):n(i.Or,t,{hasLeftSpacing:e});case"}":return this.stream.next(),n(i.CloseBrace,t,{hasLeftSpacing:e});default:{const s=this.tryReadDigits(e);if(s)return s;const a=this.tryReadWord(e);if(a)return a;throw new c(`invalid character: "${this.stream.char}"`,t)}}}}tryReadWord(e){if(this.stream.eof)return;const t=this.stream.getPos();let s=this.tryReadIdentifierStart();if(s===void 0)return;for(;!this.stream.eof;){const l=this.tryReadIdentifierPart();if(l===void 0)break;s+=l}const a=V(s);if(a!==s)throw new c(`Invalid identifier: "${s}"`,t);switch(a){case"null":return n(i.NullKeyword,t,{hasLeftSpacing:e});case"true":return n(i.TrueKeyword,t,{hasLeftSpacing:e});case"false":return n(i.FalseKeyword,t,{hasLeftSpacing:e});case"each":return n(i.EachKeyword,t,{hasLeftSpacing:e});case"for":return n(i.ForKeyword,t,{hasLeftSpacing:e});case"loop":return n(i.LoopKeyword,t,{hasLeftSpacing:e});case"do":return n(i.DoKeyword,t,{hasLeftSpacing:e});case"while":return n(i.WhileKeyword,t,{hasLeftSpacing:e});case"break":return n(i.BreakKeyword,t,{hasLeftSpacing:e});case"continue":return n(i.ContinueKeyword,t,{hasLeftSpacing:e});case"match":return n(i.MatchKeyword,t,{hasLeftSpacing:e});case"case":return n(i.CaseKeyword,t,{hasLeftSpacing:e});case"default":return n(i.DefaultKeyword,t,{hasLeftSpacing:e});case"if":return n(i.IfKeyword,t,{hasLeftSpacing:e});case"elif":return n(i.ElifKeyword,t,{hasLeftSpacing:e});case"else":return n(i.ElseKeyword,t,{hasLeftSpacing:e});case"return":return n(i.ReturnKeyword,t,{hasLeftSpacing:e});case"eval":return n(i.EvalKeyword,t,{hasLeftSpacing:e});case"var":return n(i.VarKeyword,t,{hasLeftSpacing:e});case"let":return n(i.LetKeyword,t,{hasLeftSpacing:e});case"exists":return n(i.ExistsKeyword,t,{hasLeftSpacing:e});default:return n(i.Identifier,t,{hasLeftSpacing:e,value:a})}}tryReadIdentifierStart(){if(!this.stream.eof){if(z.test(this.stream.char)){const e=this.stream.char;return this.stream.next(),e}if(this.stream.char==="\\")return this.stream.next(),"\\"+this.readUnicodeEscapeSequence()}}tryReadIdentifierPart(){if(this.stream.eof)return;const e=this.tryReadIdentifierStart();if(e!==void 0)return e;if(Z.test(this.stream.char)){const t=this.stream.char;return this.stream.next(),t}}readUnicodeEscapeSequence(){if(this.stream.eof||this.stream.char!=="u")throw new c('character "u" expected',this.stream.getPos());this.stream.next();let e="";for(let t=0;t<4;t++){if(this.stream.eof||!J.test(this.stream.char))throw new c("hexadecimal digit expected",this.stream.getPos());e+=this.stream.char,this.stream.next()}return`u${e}`}tryReadDigits(e){let t="",s="";const a=this.stream.getPos();for(;!this.stream.eof&&E.test(this.stream.char);)t+=this.stream.char,this.stream.next();if(t.length===0)return;if(!this.stream.eof&&this.stream.char==="."){for(this.stream.next();!this.stream.eof&&E.test(this.stream.char);)s+=this.stream.char,this.stream.next();if(s.length===0)throw new c("digit expected",a)}let l;return s.length>0?l=t+"."+s:l=t,n(i.NumberLiteral,a,{hasLeftSpacing:e,value:l})}readStringLiteral(e){let t="";const s=this.stream.char;let a="string";const l=this.stream.getPos();for(this.stream.next();a!=="finish";)switch(a){case"string":{if(this.stream.eof)throw new u(l);if(this.stream.char==="\\"){this.stream.next(),a="escape";break}if(this.stream.char===s){this.stream.next(),a="finish";break}t+=this.stream.char,this.stream.next();break}case"escape":{if(this.stream.eof)throw new u(l);t+=this.stream.char,this.stream.next(),a="string";break}}return n(i.StringLiteral,l,{hasLeftSpacing:e,value:t})}readTemplate(e){const t=[];let s="",a=[],l="string",x=0;const d=this.stream.getPos();let f=d;for(this.stream.next();l!=="finish";)switch(l){case"string":{if(this.stream.eof)throw new u(d);if(this.stream.char==="\\"){this.stream.next(),l="escape";break}if(this.stream.char==="`"){this.stream.next(),s.length>0&&t.push(n(i.TemplateStringElement,f,{hasLeftSpacing:e,value:s})),l="finish";break}if(this.stream.char==="{"){this.stream.next(),s.length>0&&(t.push(n(i.TemplateStringElement,f,{hasLeftSpacing:e,value:s})),s=""),f=this.stream.getPos(),l="expr";break}s+=this.stream.char,this.stream.next();break}case"escape":{if(this.stream.eof)throw new u(d);s+=this.stream.char,this.stream.next(),l="string";break}case"expr":{if(this.stream.eof)throw new u(d);if(b.includes(this.stream.char)){this.stream.next();continue}if(this.stream.char==="{"&&x++,this.stream.char==="}"){if(x===0){t.push(n(i.TemplateExprElement,f,{hasLeftSpacing:e,children:a})),f=this.stream.getPos(),a.push(n(i.EOF,f)),a=[],l="string",this.stream.next();break}x--}const F=this.readToken();a.push(F);break}}return n(i.Template,d,{hasLeftSpacing:e,children:t})}skipEmptyLines(){for(;!this.stream.eof;){if(b.includes(this.stream.char)||P.includes(this.stream.char)){this.stream.next();continue}if(this.stream.char==="/")if(this.stream.next(),!this.stream.eof&&this.stream.char==="*"){this.stream.next(),this.skipCommentRange();continue}else if(!this.stream.eof&&this.stream.char==="/"){this.stream.next(),this.skipCommentLine();continue}else{this.stream.prev();break}break}}skipCommentLine(){for(;!(this.stream.eof||this.stream.char===`
`);)this.stream.next()}skipCommentRange(){for(;;){if(this.stream.eof)throw new u(this.stream.getPos());if(this.stream.char==="*"){if(this.stream.next(),this.stream.eof)throw new u(this.stream.getPos());if(this.stream.char==="/"){this.stream.next();break}continue}this.stream.next()}}}function Y(r){const e=[];for(;r.is(i.NewLine);)r.next();for(;!r.is(i.EOF);){switch(r.getTokenKind()){case i.Colon2:{e.push(K(r));break}case i.Sharp3:{e.push(ee(r));break}default:{e.push(q(r));break}}switch(r.getTokenKind()){case i.NewLine:case i.SemiColon:{for(;r.is(i.NewLine)||r.is(i.SemiColon);)r.next();break}case i.EOF:break;default:throw new c("Multiple statements cannot be placed on a single line.",r.getPos())}}return e}function K(r){const e=r.getPos();r.expect(i.Colon2),r.next(),r.expect(i.Identifier);const t=r.getTokenValue();r.next();const s=[];for(r.expect(i.OpenBrace),r.next();r.is(i.NewLine);)r.next();for(;!r.is(i.CloseBrace);){switch(r.getTokenKind()){case i.VarKeyword:case i.LetKeyword:case i.At:{s.push(S(r));break}case i.Colon2:{s.push(K(r));break}case i.OpenSharpBracket:{s.push($(r));break}}switch(r.getTokenKind()){case i.NewLine:case i.SemiColon:{for(;r.is(i.NewLine)||r.is(i.SemiColon);)r.next();break}case i.CloseBrace:break;case i.EOF:throw new u(r.getPos());default:throw new c("Multiple statements cannot be placed on a single line.",r.getPos())}}return r.expect(i.CloseBrace),r.next(),_("ns",{name:t,members:s},e,r.getPos())}function ee(r){const e=r.getPos();r.expect(i.Sharp3),r.next();let t=null;r.is(i.Identifier)&&(t=r.getTokenValue(),r.next());const s=B(r,!0);return _("meta",{name:t,value:s},e,s.loc.end)}function k(r,e){return h(r,e,[])}function h(r,e,t){const s=e(r,t);switch(t.push(r),s.type){case"def":{s.varType!=null&&(s.varType=h(s.varType,e,t)),s.attr=s.attr.map(a=>h(a,e,t)),s.expr=h(s.expr,e,t);break}case"return":{s.expr=h(s.expr,e,t);break}case"each":{s.items=h(s.items,e,t),s.for=h(s.for,e,t);break}case"for":{s.from!=null&&(s.from=h(s.from,e,t)),s.to!=null&&(s.to=h(s.to,e,t)),s.times!=null&&(s.times=h(s.times,e,t)),s.for=h(s.for,e,t);break}case"loop":{for(let a=0;a<s.statements.length;a++)s.statements[a]=h(s.statements[a],e,t);break}case"addAssign":case"subAssign":case"assign":{s.expr=h(s.expr,e,t),s.dest=h(s.dest,e,t);break}case"plus":{s.expr=h(s.expr,e,t);break}case"minus":{s.expr=h(s.expr,e,t);break}case"not":{s.expr=h(s.expr,e,t);break}case"if":{s.cond=h(s.cond,e,t),s.then=h(s.then,e,t);for(const a of s.elseif)a.cond=h(a.cond,e,t),a.then=h(a.then,e,t);s.else!=null&&(s.else=h(s.else,e,t));break}case"fn":{for(const a of s.params)a.default&&(a.default=h(a.default,e,t)),a.argType!=null&&(a.argType=h(a.argType,e,t));s.retType!=null&&(s.retType=h(s.retType,e,t));for(let a=0;a<s.children.length;a++)s.children[a]=h(s.children[a],e,t);break}case"match":{s.about=h(s.about,e,t);for(const a of s.qs)a.q=h(a.q,e,t),a.a=h(a.a,e,t);s.default!=null&&(s.default=h(s.default,e,t));break}case"block":{for(let a=0;a<s.statements.length;a++)s.statements[a]=h(s.statements[a],e,t);break}case"exists":{s.identifier=h(s.identifier,e,t);break}case"tmpl":{for(let a=0;a<s.tmpl.length;a++){const l=s.tmpl[a];typeof l!="string"&&(s.tmpl[a]=h(l,e,t))}break}case"obj":{for(const a of s.value)s.value.set(a[0],h(a[1],e,t));break}case"arr":{for(let a=0;a<s.value.length;a++)s.value[a]=h(s.value[a],e,t);break}case"call":{s.target=h(s.target,e,t);for(let a=0;a<s.args.length;a++)s.args[a]=h(s.args[a],e,t);break}case"index":{s.target=h(s.target,e,t),s.index=h(s.index,e,t);break}case"prop":{s.target=h(s.target,e,t);break}case"ns":{for(let a=0;a<s.members.length;a++)s.members[a]=h(s.members[a],e,t);break}case"pow":case"mul":case"div":case"rem":case"add":case"sub":case"lt":case"lteq":case"gt":case"gteq":case"eq":case"neq":case"and":case"or":{s.left=h(s.left,e,t),s.right=h(s.right,e,t);break}case"fnTypeSource":{for(let a=0;a<s.params.length;a++)s.params[a]=h(s.params[a],e,t);break}case"unionTypeSource":{for(let a=0;a<s.inners.length;a++)s.inners[a]=h(s.inners[a],e,t);break}}return t.pop(),s}function te(r,e){let t=r;for(let s=e.length-1;s>=0;s--){const a=e[s];if(a.type==="fn"&&!a.params.some(l=>l.default!=null&&l.default===t))return a;t=a}}function C(r,e){for(let t=r.length-1;t>=0;t--){const s=r[t];switch(s.type){case"loop":case"for":case"each":{if(e!=null&&e!==s.label)continue;return s}case"if":case"match":case"block":{if(e==null||e!==s.label)continue;return s}case"fn":return}}}function re(r,e){switch(r.type){case"return":{if(te(r,e)===void 0)throw new c("return must be inside function",r.loc.start);break}case"break":{const t=C(e,r.label);if(t==null)throw r.label!=null?new c(`label "${r.label}" is not defined`,r.loc.start):new c("unlabeled break must be inside for / each / while / do-while / loop",r.loc.start);switch(t.type){case"each":{if(e.includes(t.items))throw new c("break corresponding to each is not allowed in the target",r.loc.start);break}case"for":{if(t.times!=null&&e.includes(t.times))throw new c("break corresponding to for is not allowed in the count",r.loc.start);if(e.some(s=>s===t.from||s===t.to))throw new c("break corresponding to for is not allowed in the range",r.loc.start);break}case"if":{if(e.includes(t.cond)||t.elseif.some(({cond:s})=>e.includes(s)))throw new c("break corresponding to if is not allowed in the condition",r.loc.start);break}case"match":{if(e.includes(t.about))throw new c("break corresponding to match is not allowed in the target",r.loc.start);if(t.qs.some(({q:s})=>e.includes(s)))throw new c("break corresponding to match is not allowed in the pattern",r.loc.start);break}}if(r.expr!=null)switch(t.type){case"if":case"match":case"block":break;default:throw new c("break corresponding to statement cannot include value",r.loc.start)}break}case"continue":{const t=C(e,r.label);if(t==null)throw r.label!=null?new c(`label "${r.label}" is not defined`,r.loc.start):new c("continue must be inside for / each / while / do-while / loop",r.loc.start);switch(t.type){case"each":{if(e.includes(t.items))throw new c("continue corresponding to each is not allowed in the target",r.loc.start);break}case"for":{if(t.times!=null&&e.includes(t.times))throw new c("continue corresponding to for is not allowed in the count",r.loc.start);if(e.some(s=>s===t.from||s===t.to))throw new c("continue corresponding to for is not allowed in the range",r.loc.start);break}case"if":throw new c("cannot use continue for if",r.loc.start);case"match":throw new c("cannot use continue for match",r.loc.start);case"block":throw new c("cannot use continue for eval",r.loc.start)}break}}return r}function se(r){for(const e of r)k(e,re);return r}const ae=["null","true","false","each","for","loop","do","while","break","continue","match","case","default","if","elif","else","return","eval","var","let","exists","as","async","attr","attribute","await","catch","class","component","constructor","dictionary","enum","export","finally","fn","hash","in","interface","out","private","public","ref","static","struct","table","this","throw","trait","try","undefined","use","using","when","yield","import","is","meta","module","namespace","new"];function o(r,e){ae.includes(r)&&v(r,e)}function O(r,e){r!=="null"&&o(r,e)}function v(r,e){throw new c(`Reserved word "${r}" cannot be used as variable name.`,e)}function y(r){return k(r,e=>{switch(e.type){case"null":{v(e.type,e.loc.start);break}case"bool":{v(`${e.value}`,e.loc.start);break}case"identifier":{o(e.name,e.loc.start);break}}return e})}function I(r){for(const e of r.typeParams)O(e.name,r.loc.start)}function ie(r){switch(r.type){case"def":{y(r.dest);break}case"ns":case"attr":case"identifier":{o(r.name,r.loc.start);break}case"meta":{r.name!=null&&o(r.name,r.loc.start);break}case"each":{r.label!=null&&o(r.label,r.loc.start),y(r.var);break}case"for":{r.label!=null&&o(r.label,r.loc.start),r.var!=null&&o(r.var,r.loc.start);break}case"loop":{r.label!=null&&o(r.label,r.loc.start);break}case"break":{r.label!=null&&o(r.label,r.loc.start);break}case"continue":{r.label!=null&&o(r.label,r.loc.start);break}case"fn":{I(r);for(const e of r.params)y(e.dest);break}case"namedTypeSource":{O(r.name,r.loc.start);break}case"fnTypeSource":{I(r);break}}return r}function ne(r){for(const e of r)k(e,ie);return r}function N(r){return{type:"simple",name:r}}function he(r,e){return{type:"generic",name:r,inners:e}}function le(r,e){return{type:"fn",params:r,result:e}}function ce(r){return{type:"param",name:r}}function oe(r){return{type:"union",inners:r}}function g(r){switch(r.type){case"namedTypeSource":if(r.inner){const e=g(r.inner);return`${r.name}<${e}>`}else return r.name;case"fnTypeSource":{const e=r.params.map(s=>g(s)).join(", "),t=g(r.result);return`@(${e}) { ${t} }`}case"unionTypeSource":return r.inners.map(e=>m(e)).join(" | ")}}function m(r,e){if(r.type==="namedTypeSource"){const t=e?.find(s=>s.name===r.name);if(t!=null)return ce(t.name);switch(r.name){case"null":case"bool":case"num":case"str":case"error":case"never":case"any":case"void":{if(r.inner==null)return N(r.name);break}case"arr":case"obj":{let s;return r.inner!=null?s=m(r.inner,e):s=N("any"),he(r.name,[s])}}throw new c(`Unknown type: '${g(r)}'`,r.loc.start)}else if(r.type==="fnTypeSource"){let t=r.typeParams;e!=null&&(t=t.concat(e));const s=r.params.map(a=>m(a,t));return le(s,m(r.result,t))}else{const t=r.inners.map(s=>m(s,e));return oe(t)}}function T(r,e){const t=[];if(r.type==="fn"){const s=new Set;for(const a of r.typeParams){if(s.has(a.name))throw new Error(`type parameter name ${a.name} is duplicate`);s.add(a.name)}t.push(...r.typeParams)}for(let s=e.length-1;s>=0;s--){const a=e[s];a.type==="fn"&&t.push(...a.typeParams)}return t}function ue(r,e){switch(r.type){case"def":{r.varType!=null&&m(r.varType,T(r,e));break}case"fn":{for(const t of r.params)t.argType!=null&&m(t.argType,T(r,e));r.retType!=null&&m(r.retType,T(r,e));break}}return r}function me(r){for(const e of r)k(e,ue);return r}class p{static instance;plugins;constructor(){this.plugins={validate:[ne,me,se],transform:[]}}static parse(e){return p.instance==null&&(p.instance=new p),p.instance.parse(e)}addPlugin(e,t){switch(e){case"validate":this.plugins.validate.push(t);break;case"transform":this.plugins.transform.push(t);break;default:throw new Error("unknown plugin type")}}parse(e){let t;const s=new Q(e);t=Y(s);for(const a of this.plugins.validate)t=a(t);for(const a of this.plugins.transform)t=a(t);return t}}export{p as P,Q as S};
