import{i as $,u as V,C as T,c as L}from"./3iSoGi4ic-CqmhgU-Q.js";import{J as N,U as P,av as B,$ as Y,i as O,aS as M,b7 as W,x as A,ag as S}from"./3iSoGi4ic-DV-GuiCp.js";import{M as j}from"./3iSoGi4ic-BWBLHwGQ.js";import{_ as z}from"./3iSoGi4ic-atZAPWr2.js";import{M as C}from"./3iSoGi4ic-DtDbNQ4_.js";import{_ as J}from"./3iSoGi4ic-8TpncZSx.js";import{a as K}from"./3iSoGi4ic-BPp9MNgd.js";import{b as H,u as I,e as U,l as q,i as R,c as E,B as c,f as X,C as G,h as v,p as o,t as d,R as w,D}from"./3iSoGi4ic-D0mTJ0Mu.js";import"./3iSoGi4ic-B1GPmOGN.js";import"./3iSoGi4ic-D98_HDRS.js";import"./3iSoGi4ic-y3_HjM0O.js";import"./3iSoGi4ic-C7_f0Ypu.js";const Q=H({__name:"MkRetentionLineChart",setup(F){$();const p=I("chartEl"),{handler:g}=V(),x=n=>{const i=n.getFullYear().toString().padStart(2,"0"),y=(n.getMonth()+1).toString().padStart(2,"0"),m=n.getDate().toString().padStart(2,"0");return`${i}/${y}/${m}`},f=n=>{const[i,y,m]=n.split("-").map(u=>parseInt(u,10));return new Date(i,y+1,m,0,0,0,0)};return U(async()=>{let n=await N("retention",{});const i=P.s.darkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",m=B(getComputedStyle(window.document.documentElement).getPropertyValue("--MI_THEME-accent")).toHex();p.value!=null&&new T(p.value,{type:"line",data:{labels:[],datasets:n.map((t,u)=>({label:x(new Date(t.createdAt)),pointRadius:0,borderWidth:2,borderJoinStyle:"round",borderColor:K(m,Math.min(1,(n.length-(u-1))/n.length)),fill:!1,tension:.4,data:[{x:"0",y:100,d:x(new Date(t.createdAt))},...Object.entries(t.data).sort((b,_)=>f(b[0])>f(_[0])?1:-1).map(([b,_],s)=>({x:(s+1).toString(),y:_/t.users*100,d:x(new Date(t.createdAt))}))]}))},options:{aspectRatio:2.5,layout:{padding:{left:0,right:0,top:0,bottom:0}},scales:{x:{title:{display:!0,text:"Days later"}},y:{title:{display:!0,text:"Rate (%)"},ticks:{callback:(t,u,b)=>t+"%"},min:0}},interaction:{intersect:!1},plugins:{legend:{display:!1},tooltip:{enabled:!1,callbacks:{title(t){return`${t[0].dataset.data[t[0].dataIndex].x} days later`},label(t){const u=t.dataset.data[t.dataIndex],b=Math.round(u.y)+"%";return`${u.d} ${b}`}},mode:"index",animation:{duration:0},external:g}}},plugins:[L(i)]})}),(n,i)=>(R(),q("canvas",{ref_key:"chartEl",ref:p},null,512))}}),Z={class:"selects"},ee={class:"chart _panel"},te={class:"pies"},ae={class:"sub"},se={class:"pub"},le=500,_e=H({__name:"MkInstanceStats",setup(F){$();const p=E(()=>O.federation!=="none"||Y?.isModerator),{model:g,def:x}=M({items:[{value:"hour",label:"orario"},{value:"day",label:"giornaliero"}],initialValue:"hour"}),{model:f,def:n}=M({items:E(()=>{const s=[];p.value&&s.push({type:"group",label:"Federazione",items:[{value:"federation",label:"Federazione"},{value:"ap-request",label:"Richieste"}]}),s.push({type:"group",label:"Profili",items:[{value:"users",label:"Variazione del numero di utenti"},{value:"users-total",label:"Numero totale di utenti"},{value:"active-users",label:"Numero di utenti attivi"}]});const e=[{value:"notes",label:"Variazione del numero di note"},{value:"local-notes",label:"Variazione del numero di note locali"}];return p.value&&e.push({value:"remote-notes",label:"Variazione del numero di note distanti"}),e.push({value:"notes-total",label:"Numero di note in totale"}),s.push({type:"group",label:"Note",items:e}),s.push({type:"group",label:"Drive",items:[{value:"drive-files",label:"Variazione del numero dei file"},{value:"drive",label:"Variazione dell'utilizzo dell'immagazzinamento"}]}),s}),initialValue:"active-users"}),{model:i,def:y}=M({items:E(()=>[{value:"active-users",label:"Active Users"},{value:"notes",label:"Notes"},...p.value?[{value:"ap-requests-inbox-received",label:"AP Requests: inboxReceived"},{value:"ap-requests-deliver-succeeded",label:"AP Requests: deliverSucceeded"},{value:"ap-requests-deliver-failed",label:"AP Requests: deliverFailed"}]:[]]),initialValue:"active-users"}),m=I("subDoughnutEl"),t=I("pubDoughnutEl"),{handler:u}=V({position:"middle"}),{handler:b}=V({position:"middle"});function _(s,e,l){const r=new T(s,{type:"doughnut",data:{labels:l.map(h=>h.name),datasets:[{backgroundColor:l.map(h=>h.color),borderColor:getComputedStyle(window.document.documentElement).getPropertyValue("--MI_THEME-panel"),borderWidth:2,hoverOffset:0,data:l.map(h=>h.value)}]},options:{maintainAspectRatio:!1,layout:{padding:{left:16,right:16,top:16,bottom:16}},onClick:h=>{if(h.native==null)return;const k=r.getElementsAtEventForMode(h.native,"nearest",{intersect:!0},!1)[0];k&&l[k.index].onClick&&l[k.index].onClick()},plugins:{legend:{display:!1},tooltip:{enabled:!1,mode:"index",animation:{duration:0},external:e}}}});return r}return U(()=>{W("federation/stats",{limit:30}).then(s=>{const e=s.topSubInstances.map(r=>({name:r.host,color:r.themeColor,value:r.followersCount,onClick:()=>{A(`/instance-info/${r.host}`)}}));e.push({name:"(other)",color:"#80808080",value:s.otherFollowersCount}),_(m.value,u,e);const l=s.topPubInstances.map(r=>({name:r.host,color:r.themeColor,value:r.followingCount,onClick:()=>{A(`/instance-info/${r.host}`)}}));l.push({name:"(other)",color:"#80808080",value:s.otherFollowingCount}),_(t.value,b,l)})}),(s,e)=>(R(),q("div",{class:"xjUmo"},[c(C,{class:"item"},{header:v(()=>[...e[3]||(e[3]=[D("Chart",-1)])]),default:v(()=>[o("div",{class:"xAsEh"},[o("div",Z,[c(S,{modelValue:d(f),"onUpdate:modelValue":e[0]||(e[0]=l=>w(f)?f.value=l:null),items:d(n),style:{margin:"0",flex:"1"}},null,8,["modelValue","items"]),c(S,{modelValue:d(g),"onUpdate:modelValue":e[1]||(e[1]=l=>w(g)?g.value=l:null),items:d(x),style:{margin:"0 0 0 10px"}},null,8,["modelValue","items"])]),o("div",ee,[c(j,{src:d(f),span:d(g),limit:le,detailed:!0},null,8,["src","span"])])],2)]),_:1}),c(C,{class:"item"},{header:v(()=>[...e[4]||(e[4]=[D("Active users heatmap",-1)])]),default:v(()=>[c(S,{modelValue:d(i),"onUpdate:modelValue":e[2]||(e[2]=l=>w(i)?i.value=l:null),items:d(y),style:{margin:"0 0 12px 0"}},null,8,["modelValue","items"]),o("div",{class:"_panel xCLf6"},[c(z,{src:d(i),label:"Read & Write"},null,8,["src"])],2)]),_:1}),c(C,{class:"item"},{header:v(()=>[...e[5]||(e[5]=[D("Retention rate",-1)])]),default:v(()=>[o("div",{class:"_panel xeXlR"},[c(J)],2),o("div",{class:"_panel xrOzK"},[c(Q)],2)]),_:1}),p.value?(R(),X(C,{key:0,class:"item"},{header:v(()=>[...e[6]||(e[6]=[D("Federation",-1)])]),default:v(()=>[o("div",{class:"xDi80"},[o("div",te,[o("div",ae,[e[7]||(e[7]=o("div",{class:"title"},"Sub",-1)),o("canvas",{ref_key:"subDoughnutEl",ref:m},null,512)]),o("div",se,[e[8]||(e[8]=o("div",{class:"title"},"Pub",-1)),o("canvas",{ref_key:"pubDoughnutEl",ref:t},null,512)])])],2)]),_:1})):G("",!0)],2))}});export{_e as default};
