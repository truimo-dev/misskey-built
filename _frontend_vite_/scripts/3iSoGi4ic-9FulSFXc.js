import{s as Il}from"./3iSoGi4ic-C0O4p9AH.js";import{K as Je}from"./3iSoGi4ic-nJzNoieu.js";import"./3iSoGi4ic-DV-GuiCp.js";import"./3iSoGi4ic-D0mTJ0Mu.js";import"./3iSoGi4ic-B1GPmOGN.js";import"./3iSoGi4ic-Dty8GuTz.js";import"./3iSoGi4ic-D98_HDRS.js";import"./3iSoGi4ic-Ddz4upM5.js";import"./3iSoGi4ic-ke9ZaMpT.js";function Q(s,n,e){let o=e.value;return{configurable:!0,get(){const g=o.bind(this);return Object.defineProperty(this,n,{configurable:!0,writable:!0,value:g}),g},set(g){o=g}}}class Oe extends Error{name="AiScript";info;constructor(n,e){super(n),this.info=e,Error.captureStackTrace&&Error.captureStackTrace(this,Oe)}}class hs extends Oe{name="Internal";constructor(n){super(n.message??`${n}`,n)}}class je extends Oe{name="Syntax";constructor(n,e){super(n,e)}}class Dl extends Oe{name="Type";constructor(n,e){super(n,e)}}class F extends Oe{name="Runtime";constructor(n,e){super(n,e)}}class Vr extends F{constructor(n,e){super(n,e)}}class ps extends F{name="";constructor(n,e){super(n,e)}}const Ei=Object.freeze(Object.defineProperty({__proto__:null,AiScriptError:Oe,AiScriptIndexOutOfRangeError:Vr,AiScriptRuntimeError:F,AiScriptSyntaxError:je,AiScriptTypeError:Dl,AiScriptUserError:ps,NonAiScriptError:hs},Symbol.toStringTag,{value:"Module"}));var _e=(function(s,n,e,o){var g=arguments.length,$=g<3?n:o===null?o=Object.getOwnPropertyDescriptor(n,e):o,S;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")$=Reflect.decorate(s,n,e,o);else for(var U=s.length-1;U>=0;U--)(S=s[U])&&($=(g<3?S($):g>3?S(n,e,$):S(n,e))||$);return g>3&&$&&Object.defineProperty(n,e,$),$});class ie{parent;layerdStates;name;opts={};nsName;constructor(n=[],e,o,g){this.layerdStates=n,this.parent=e,this.name=o||(n.length===1?"<root>":"<anonymous>"),this.nsName=g}log(n,e){this.parent?this.parent.log(n,e):this.opts.log&&this.opts.log(n,e)}onUpdated(n,e){this.parent?this.parent.onUpdated(n,e):this.opts.onUpdated&&this.opts.onUpdated(n,e)}createChildScope(n=new Map,e){const o=[n,...this.layerdStates];return new ie(o,this,e)}createChildNamespaceScope(n,e=new Map,o){const g=[e,...this.layerdStates];return new ie(g,this,o,n)}get(n){for(const e of this.layerdStates)if(e.has(n)){const o=e.get(n).value;return this.log("read",{var:n,val:o}),o}throw new F(`No such variable '${n}' in scope '${this.name}'`,{scope:this.layerdStates})}exists(n){for(const e of this.layerdStates)if(e.has(n))return this.log("exists",{var:n}),!0;return this.log("not exists",{var:n}),!1}getAll(){const n=this.layerdStates.reduce((e,o)=>[...e,...o],[]);return new Map(n)}add(n,e){this.log("add",{var:n,val:e});const o=this.layerdStates[0];if(o.has(n))throw new F(`Variable '${n}' already exists in scope '${this.name}'`,{scope:this.layerdStates});o.set(n,e),this.parent==null?this.onUpdated(n,e.value):this.nsName!=null&&this.parent.add(this.nsName+":"+n,e)}assign(n,e){let o=1;for(const g of this.layerdStates){if(g.has(n)){const $=g.get(n);if(!$.isMutable)throw new F(`Cannot assign to an immutable variable ${n}.`);$.value=e,this.log("assign",{var:n,val:e}),o===this.layerdStates.length&&this.onUpdated(n,e);return}o++}throw new F(`No such variable '${n}' in scope '${this.name}'`,{scope:this.layerdStates})}}_e([Q],ie.prototype,"log",null);_e([Q],ie.prototype,"onUpdated",null);_e([Q],ie.prototype,"createChildScope",null);_e([Q],ie.prototype,"createChildNamespaceScope",null);_e([Q],ie.prototype,"get",null);_e([Q],ie.prototype,"exists",null);_e([Q],ie.prototype,"getAll",null);_e([Q],ie.prototype,"add",null);_e([Q],ie.prototype,"assign",null);let xr;const Ul=new Uint8Array(16);function Fl(){if(!xr&&(xr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!xr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return xr(Ul)}const ee=[];for(let s=0;s<256;++s)ee.push((s+256).toString(16).slice(1));function Ll(s,n=0){return ee[s[n+0]]+ee[s[n+1]]+ee[s[n+2]]+ee[s[n+3]]+"-"+ee[s[n+4]]+ee[s[n+5]]+"-"+ee[s[n+6]]+ee[s[n+7]]+"-"+ee[s[n+8]]+ee[s[n+9]]+"-"+ee[s[n+10]]+ee[s[n+11]]+ee[s[n+12]]+ee[s[n+13]]+ee[s[n+14]]+ee[s[n+15]]}const Hl=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),us={randomUUID:Hl};function ql(s,n,e){if(us.randomUUID&&!s)return us.randomUUID();s=s||{};const o=s.random||(s.rng||Fl)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Ll(o)}const R={type:"null"},K={type:"bool",value:!0},X={type:"bool",value:!1},_=s=>({type:"num",value:s}),D=s=>({type:"str",value:s}),Ne=s=>({type:"bool",value:s}),rr=s=>({type:"obj",value:s}),V=s=>({type:"arr",value:s}),vs=(s,n,e)=>({type:"fn",args:s,statements:n,scope:e}),b=s=>({type:"fn",native:s}),gs=s=>({type:"return",value:s}),ds=()=>({type:"break",value:null}),ws=()=>({type:"continue",value:null}),ys=s=>s.type==="return"?s.value:s,kr=(s,n)=>({type:"error",value:s,info:n}),Ti=Object.freeze(Object.defineProperty({__proto__:null,ARR:V,BOOL:Ne,BREAK:ds,CONTINUE:ws,ERROR:kr,FALSE:X,FN:vs,FN_NATIVE:b,NULL:R,NUM:_,OBJ:rr,RETURN:gs,STR:D,TRUE:K,unWrapRet:ys},Symbol.toStringTag,{value:"Module"}));function te(s){if(s==null)throw new F("Expect anything, but got nothing.")}function Y(s){if(s==null)throw new F("Expect boolean, but got nothing.");if(s.type!=="bool")throw new F(`Expect boolean, but got ${s.type}.`)}function ce(s){if(s==null)throw new F("Expect function, but got nothing.");if(s.type!=="fn")throw new F(`Expect function, but got ${s.type}.`)}function q(s){if(s==null)throw new F("Expect string, but got nothing.");if(s.type!=="str")throw new F(`Expect string, but got ${s.type}.`)}function x(s){if(s==null)throw new F("Expect number, but got nothing.");if(s.type!=="num")throw new F(`Expect number, but got ${s.type}.`)}function oe(s){if(s==null)throw new F("Expect object, but got nothing.");if(s.type!=="obj")throw new F(`Expect object, but got ${s.type}.`)}function Pe(s){if(s==null)throw new F("Expect array, but got nothing.");if(s.type!=="arr")throw new F(`Expect array, but got ${s.type}.`)}function Vl(s){return s.type==="bool"}function Bl(s){return s.type==="fn"}function zl(s){return s.type==="str"}function Jl(s){return s.type==="num"}function Ar(s){return s.type==="obj"}function tr(s){return s.type==="arr"}function Le(s,n){return s.type==="fn"||n.type==="fn"?!1:s.type==="null"&&n.type==="null"?!0:s.type==="null"||n.type==="null"?!1:s.value===n.value}function $s(s,n=!1){if(n){if(s.type==="num")return s.value.toString();if(s.type==="bool")return s.value?"true":"false";if(s.type==="str")return`"${s.value}"`;if(s.type==="arr")return`[${s.value.map(o=>$s(o,!0)).join(", ")}]`;if(s.type==="null")return"(null)"}const e=s.type==="num"||s.type==="bool"?s.value:s.type==="str"?`"${s.value}"`:s.type==="fn"||s.type==="obj"?"...":s.type==="null"?"":null;return`${s.type}<${e}>`}function Mr(s){switch(s.type){case"fn":return"<function>";case"arr":return s.value.map(n=>Mr(n));case"bool":return s.value;case"null":return null;case"num":return s.value;case"obj":{const n={};for(const[e,o]of s.value.entries())n[e]=Mr(o);return n}case"str":return s.value;default:throw new Error(`Unrecognized value type: ${s.type}`)}}function Sr(s){if(s===null)return R;if(typeof s=="boolean")return Ne(s);if(typeof s=="string")return D(s);if(typeof s=="number")return _(s);if(Array.isArray(s))return V(s.map(n=>Sr(n)));if(typeof s=="object"){const n=new Map;for(const[e,o]of Object.entries(s))n.set(e,Sr(o));return rr(n)}return R}function Ql(s){const n=/^\s*\/\/\/\s*@\s*([A-Z0-9_.-]+)(?:[\r\n][\s\S]*)?$/i.exec(s);return n!=null?n[1]:null}function He(s,n=!1,e=new Set){if((s.type==="arr"||s.type==="obj")&&e.has(s.value))return"...";if(n&&s.type==="str")return'"'+s.value.replace(/["\\\r\n]/g,o=>`\\${o}`)+'"';if(s.type==="str")return s.value;if(s.type==="num")return s.value.toString();if(s.type==="arr"){e.add(s.value);const o=[];for(const g of s.value)o.push(He(g,!0,e));return"[ "+o.join(", ")+" ]"}if(s.type==="obj"){e.add(s.value);const o=[];for(const[g,$]of s.value)o.push(`${g}: ${He($,!0,e)}`);return"{ "+o.join(", ")+" }"}return s.type==="bool"?s.value.toString():s.type==="null"?"null":s.type==="fn"?`@( ${(s.args??[]).join(", ")} ) { ... }`:"?"}const Ni=Object.freeze(Object.defineProperty({__proto__:null,assertArray:Pe,assertBoolean:Y,assertFunction:ce,assertNumber:x,assertObject:oe,assertString:q,eq:Le,expectAny:te,getLangVersion:Ql,isArray:tr,isBoolean:Vl,isFunction:Bl,isNumber:Jl,isObject:Ar,isString:zl,jsToVal:Sr,reprValue:He,valToJs:Mr,valToString:$s},Symbol.toStringTag,{value:"Module"})),Zl={version:"0.19.0"},Gl=Zl.version,Wl=new TextEncoder,Kl=new TextDecoder,Xl={help:D("SEE: https://github.com/syuilo/aiscript/blob/master/docs/get-started.md"),"Core:v":D(Gl),"Core:ai":D("kawaii"),"Core:not":b(([s])=>(Y(s),s.value?X:K)),"Core:eq":b(([s,n])=>(te(s),te(n),Le(s,n)?K:X)),"Core:neq":b(([s,n])=>(te(s),te(n),Le(s,n)?X:K)),"Core:and":b(([s,n])=>(Y(s),s.value?(Y(n),n.value?K:X):X)),"Core:or":b(([s,n])=>(Y(s),s.value?K:(Y(n),n.value?K:X))),"Core:add":b(([s,n])=>(x(s),x(n),_(s.value+n.value))),"Core:sub":b(([s,n])=>(x(s),x(n),_(s.value-n.value))),"Core:mul":b(([s,n])=>(x(s),x(n),_(s.value*n.value))),"Core:pow":b(([s,n])=>{x(s),x(n);const e=s.value**n.value;if(isNaN(e))throw new F("Invalid operation.");return _(e)}),"Core:div":b(([s,n])=>{x(s),x(n);const e=s.value/n.value;if(isNaN(e))throw new F("Invalid operation.");return _(e)}),"Core:mod":b(([s,n])=>(x(s),x(n),_(s.value%n.value))),"Core:gt":b(([s,n])=>(x(s),x(n),s.value>n.value?K:X)),"Core:lt":b(([s,n])=>(x(s),x(n),s.value<n.value?K:X)),"Core:gteq":b(([s,n])=>(x(s),x(n),s.value>=n.value?K:X)),"Core:lteq":b(([s,n])=>(x(s),x(n),s.value<=n.value?K:X)),"Core:type":b(([s])=>(te(s),D(s.type))),"Core:to_str":b(([s])=>(te(s),D(He(s)))),"Core:range":b(([s,n])=>(x(s),x(n),s.value<n.value?V(Array.from({length:n.value-s.value+1},(e,o)=>_(o+s.value))):s.value>n.value?V(Array.from({length:s.value-n.value+1},(e,o)=>_(s.value-o))):V([s]))),"Core:sleep":b(async([s])=>(x(s),await new Promise(n=>setTimeout(n,s.value)),R)),"Core:abort":b(async([s])=>{throw q(s),new ps(s.value)}),"Util:uuid":b(()=>D(ql())),"Json:stringify":b(([s])=>(te(s),D(JSON.stringify(Mr(s))))),"Json:parse":b(([s])=>{q(s);try{return Sr(JSON.parse(s.value))}catch{return kr("not_json")}}),"Json:parsable":b(([s])=>{q(s);try{JSON.parse(s.value)}catch{return Ne(!1)}return Ne(!0)}),"Date:now":b(()=>_(Date.now())),"Date:year":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getFullYear()))),"Date:month":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getMonth()+1))),"Date:day":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getDate()))),"Date:hour":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getHours()))),"Date:minute":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getMinutes()))),"Date:second":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getSeconds()))),"Date:millisecond":b(([s])=>(s&&x(s),_(new Date(s?.value??Date.now()).getMilliseconds()))),"Date:parse":b(([s])=>(q(s),_(new Date(s.value).getTime()))),"Date:to_iso_str":b(([s,n])=>{s&&x(s);const e=new Date(s?.value??Date.now());n&&x(n);const o=n?.value??-e.getTimezoneOffset();let g;if(o===0)g="Z";else{const W=Math.sign(o),re=Math.floor(Math.abs(o)/60),Re=Math.abs(o)%60;e.setUTCHours(e.getUTCHours()+W*re),e.setUTCMinutes(e.getUTCMinutes()+W*Re);const ue=o>0?"+":"-",ne=re.toString().padStart(2,"0"),Ie=Re.toString().padStart(2,"0");g=`${ue}${ne}:${Ie}`}const $=e.getUTCFullYear().toString().padStart(4,"0"),S=(e.getUTCMonth()+1).toString().padStart(2,"0"),U=e.getUTCDate().toString().padStart(2,"0"),B=e.getUTCHours().toString().padStart(2,"0"),I=e.getUTCMinutes().toString().padStart(2,"0"),N=e.getUTCSeconds().toString().padStart(2,"0"),Z=e.getUTCMilliseconds().toString().padStart(3,"0");return D(`${$}-${S}-${U}T${B}:${I}:${N}.${Z}${g}`)}),"Math:Infinity":_(1/0),"Math:E":_(Math.E),"Math:LN2":_(Math.LN2),"Math:LN10":_(Math.LN10),"Math:LOG2E":_(Math.LOG2E),"Math:LOG10E":_(Math.LOG10E),"Math:PI":_(Math.PI),"Math:SQRT1_2":_(Math.SQRT1_2),"Math:SQRT2":_(Math.SQRT2),"Math:abs":b(([s])=>(x(s),_(Math.abs(s.value)))),"Math:acos":b(([s])=>(x(s),_(Math.acos(s.value)))),"Math:acosh":b(([s])=>(x(s),_(Math.acosh(s.value)))),"Math:asin":b(([s])=>(x(s),_(Math.asin(s.value)))),"Math:asinh":b(([s])=>(x(s),_(Math.asinh(s.value)))),"Math:atan":b(([s])=>(x(s),_(Math.atan(s.value)))),"Math:atanh":b(([s])=>(x(s),_(Math.atanh(s.value)))),"Math:atan2":b(([s,n])=>(x(s),x(n),_(Math.atan2(s.value,n.value)))),"Math:cbrt":b(([s])=>(x(s),_(Math.cbrt(s.value)))),"Math:ceil":b(([s])=>(x(s),_(Math.ceil(s.value)))),"Math:clz32":b(([s])=>(x(s),_(Math.clz32(s.value)))),"Math:cos":b(([s])=>(x(s),_(Math.cos(s.value)))),"Math:cosh":b(([s])=>(x(s),_(Math.cosh(s.value)))),"Math:exp":b(([s])=>(x(s),_(Math.exp(s.value)))),"Math:expm1":b(([s])=>(x(s),_(Math.expm1(s.value)))),"Math:floor":b(([s])=>(x(s),_(Math.floor(s.value)))),"Math:fround":b(([s])=>(x(s),_(Math.fround(s.value)))),"Math:hypot":b(([s])=>{Pe(s);const n=[];for(const e of s.value)x(e),n.push(e.value);return _(Math.hypot(...n))}),"Math:imul":b(([s,n])=>(x(s),x(n),_(Math.imul(s.value,n.value)))),"Math:log":b(([s])=>(x(s),_(Math.log(s.value)))),"Math:log1p":b(([s])=>(x(s),_(Math.log1p(s.value)))),"Math:log10":b(([s])=>(x(s),_(Math.log10(s.value)))),"Math:log2":b(([s])=>(x(s),_(Math.log2(s.value)))),"Math:max":b(([s,n])=>(x(s),x(n),_(Math.max(s.value,n.value)))),"Math:min":b(([s,n])=>(x(s),x(n),_(Math.min(s.value,n.value)))),"Math:pow":b(([s,n])=>(x(s),x(n),_(Math.pow(s.value,n.value)))),"Math:round":b(([s])=>(x(s),_(Math.round(s.value)))),"Math:sign":b(([s])=>(x(s),_(Math.sign(s.value)))),"Math:sin":b(([s])=>(x(s),_(Math.sin(s.value)))),"Math:sinh":b(([s])=>(x(s),_(Math.sinh(s.value)))),"Math:sqrt":b(([s])=>{x(s);const n=Math.sqrt(s.value);if(isNaN(n))throw new F("Invalid operation.");return _(n)}),"Math:tan":b(([s])=>(x(s),_(Math.tan(s.value)))),"Math:tanh":b(([s])=>(x(s),_(Math.tanh(s.value)))),"Math:trunc":b(([s])=>(x(s),_(Math.trunc(s.value)))),"Math:rnd":b(([s,n])=>s&&s.type==="num"&&n&&n.type==="num"?_(Math.floor(Math.random()*(Math.floor(n.value)-Math.ceil(s.value)+1)+Math.ceil(s.value))):_(Math.random())),"Math:gen_rng":b(([s])=>{if(te(s),s.type!=="num"&&s.type!=="str")return R;const n=Il(s.value.toString());return b(([e,o])=>e&&e.type==="num"&&o&&o.type==="num"?_(Math.floor(n()*(Math.floor(o.value)-Math.ceil(e.value)+1)+Math.ceil(e.value))):_(n()))}),"Num:to_hex":b(([s])=>(x(s),D(s.value.toString(16)))),"Num:from_hex":b(([s])=>(q(s),_(parseInt(s.value,16)))),"Str:lf":D(`
`),"Str:lt":b(([s,n])=>(q(s),q(n),s.value<n.value?_(-1):s.value===n.value?_(0):_(1))),"Str:gt":b(([s,n])=>(q(s),q(n),s.value>n.value?_(-1):s.value===n.value?_(0):_(1))),"Str:from_codepoint":b(([s])=>(x(s),D(String.fromCodePoint(s.value)))),"Str:from_unicode_codepoints":b(([s])=>(Pe(s),D(Array.from(s.value.map(n=>(x(n),String.fromCodePoint(n.value)))).join("")))),"Str:from_utf8_bytes":b(([s])=>(Pe(s),D(Kl.decode(Uint8Array.from(s.value.map(n=>(x(n),n.value))))))),"Uri:encode_full":b(([s])=>(q(s),D(encodeURI(s.value)))),"Uri:encode_component":b(([s])=>(q(s),D(encodeURIComponent(s.value)))),"Uri:decode_full":b(([s])=>(q(s),D(decodeURI(s.value)))),"Uri:decode_component":b(([s])=>(q(s),D(decodeURIComponent(s.value)))),"Arr:create":b(([s,n])=>{x(s);try{return V(Array(s.value).fill(n??R))}catch(e){throw s.value<0?new F("Arr:create expected non-negative number, got negative"):Number.isInteger(s.value)?e:new F("Arr:create expected integer, got non-integer")}}),"Obj:keys":b(([s])=>(oe(s),V(Array.from(s.value.keys()).map(n=>D(n))))),"Obj:vals":b(([s])=>(oe(s),V(Array.from(s.value.values())))),"Obj:kvs":b(([s])=>(oe(s),V(Array.from(s.value.entries()).map(([n,e])=>V([D(n),e]))))),"Obj:get":b(([s,n])=>(oe(s),q(n),s.value.get(n.value)??R)),"Obj:set":b(([s,n,e])=>(oe(s),q(n),te(e),s.value.set(n.value,e),R)),"Obj:has":b(([s,n])=>(oe(s),q(n),Ne(s.value.has(n.value)))),"Obj:copy":b(([s])=>(oe(s),rr(new Map(s.value)))),"Obj:merge":b(([s,n])=>(oe(s),oe(n),rr(new Map([...s.value,...n.value])))),"Error:create":b(([s,n])=>(q(s),kr(s.value,n))),"Async:interval":b(async([s,n,e],o)=>{x(s),ce(n),e&&(Y(e),e.value&&o.call(n,[]));const g=setInterval(()=>{o.topCall(n,[])},s.value),$=()=>{clearInterval(g)};return o.registerAbortHandler($),b(([],S)=>{clearInterval(g),S.unregisterAbortHandler($)})}),"Async:timeout":b(async([s,n],e)=>{x(s),ce(n);const o=setTimeout(()=>{e.topCall(n,[])},s.value),g=()=>{clearTimeout(o)};return e.registerAbortHandler(g),b(([],$)=>{clearTimeout(o),$.unregisterAbortHandler(g)})})},fs={num:{to_str:s=>b(async(n,e)=>D(s.value.toString()))},str:{to_num:s=>b(async(n,e)=>{const o=parseInt(s.value,10);return isNaN(o)?R:_(o)}),to_arr:s=>b(async(n,e)=>V(Je.toArray(s.value).map(o=>D(o)))),to_unicode_arr:s=>b(async(n,e)=>V([...s.value].map(o=>D(o)))),to_unicode_codepoint_arr:s=>b(async(n,e)=>V([...s.value].map(o=>{const g=o.codePointAt(0);return _(g??o.charCodeAt(0))}))),to_char_arr:s=>b(async(n,e)=>V(s.value.split("").map(o=>D(o)))),to_charcode_arr:s=>b(async(n,e)=>V(s.value.split("").map(o=>_(o.charCodeAt(0))))),to_utf8_byte_arr:s=>b(async(n,e)=>V(Array.from(Wl.encode(s.value)).map(o=>_(o)))),len:s=>_(Je.length(s.value)),replace:s=>b(async([n,e],o)=>(q(n),q(e),D(s.value.split(n.value).join(e.value)))),index_of:s=>b(async([n,e],o)=>{q(n),e&&x(e);const g=e?e.value<0?s.value.length+e.value:e.value:void 0;return _(Je.indexOf(s.value,n.value,g))}),incl:s=>b(async([n],e)=>(q(n),s.value.includes(n.value)?K:X)),trim:s=>b(async(n,e)=>D(s.value.trim())),upper:s=>b(async(n,e)=>D(s.value.toUpperCase())),lower:s=>b(async(n,e)=>D(s.value.toLowerCase())),split:s=>b(async([n],e)=>(n&&q(n),V(n?s.value.split(n?n.value:"").map(o=>D(o)):Je.toArray(s.value).map(o=>D(o))))),slice:s=>b(async([n,e],o)=>(x(n),x(e),D(Je.substring(s.value,n.value,e.value)))),pick:s=>b(async([n],e)=>{x(n);const g=Je.toArray(s.value)[n.value];return g?D(g):R}),charcode_at:s=>b(([n],e)=>{x(n);const o=s.value.charCodeAt(n.value);return Number.isNaN(o)?R:_(o)}),codepoint_at:s=>b(([n],e)=>{x(n);const o=s.value.codePointAt(n.value)??s.value.charCodeAt(n.value);return Number.isNaN(o)?R:_(o)}),starts_with:s=>b(async([n,e],o)=>{if(q(n),!n.value)return K;e&&x(e);const g=e?.value??0;if(g<-s.value.length||g>s.value.length)return X;const $=g>=0?g:s.value.length+g;return s.value.startsWith(n.value,$)?K:X}),ends_with:s=>b(async([n,e],o)=>{if(q(n),!n.value)return K;e&&x(e);const g=e?.value??s.value.length;if(g<-s.value.length||g>s.value.length)return X;const $=g>=0?g:s.value.length+g;return s.value.endsWith(n.value,$)?K:X}),pad_start:s=>b(([n,e],o)=>{x(n);const g=e?(q(e),e.value):" ";return D(s.value.padStart(n.value,g))}),pad_end:s=>b(([n,e],o)=>{x(n);const g=e?(q(e),e.value):" ";return D(s.value.padEnd(n.value,g))})},arr:{len:s=>_(s.value.length),push:s=>b(async([n],e)=>(te(n),s.value.push(n),s)),unshift:s=>b(async([n],e)=>(te(n),s.value.unshift(n),s)),pop:s=>b(async(n,e)=>s.value.pop()??R),shift:s=>b(async(n,e)=>s.value.shift()??R),concat:s=>b(async([n],e)=>(Pe(n),V(s.value.concat(n.value)))),slice:s=>b(async([n,e],o)=>(x(n),x(e),V(s.value.slice(n.value,e.value)))),join:s=>b(async([n],e)=>(n&&q(n),D(s.value.map(o=>o.type==="str"?o.value:"").join(n?n.value:"")))),map:s=>b(async([n],e)=>{ce(n);const o=s.value.map(async(g,$)=>await e.call(n,[g,_($)]));return V(await Promise.all(o))}),filter:s=>b(async([n],e)=>{ce(n);const o=[];for(let g=0;g<s.value.length;g++){const $=s.value[g],S=await e.call(n,[$,_(g)]);Y(S),S.value&&o.push($)}return V(o)}),reduce:s=>b(async([n,e],o)=>{ce(n);const g=e!=null;if(!g&&s.value.length===0)throw new F("Reduce of empty array without initial value");let $=g?e:s.value[0];for(let S=g?0:1;S<s.value.length;S++){const U=s.value[S];$=await o.call(n,[$,U,_(S)])}return $}),find:s=>b(async([n],e)=>{ce(n);for(let o=0;o<s.value.length;o++){const g=s.value[o],$=await e.call(n,[g,_(o)]);if(Y($),$.value)return g}return R}),incl:s=>b(async([n],e)=>(te(n),s.value.some(o=>Le(n,o))?K:X)),index_of:s=>b(async([n,e],o)=>{if(te(n),e){x(e);const g=s.value.slice(0,e.value).length,$=s.value.slice(e.value).findIndex(S=>Le(S,n));return _($<0?$:$+g)}else return _(s.value.findIndex(g=>Le(g,n)))}),reverse:s=>b(async(n,e)=>(s.value.reverse(),R)),copy:s=>b(async(n,e)=>V([...s.value])),sort:s=>b(async([n],e)=>{const o=async($,S)=>{if($.length<=1)return $;const U=Math.floor($.length/2),B=o($.slice(0,U),S),I=o($.slice(U),S),[N,Z]=await Promise.all([B,I]);return g(N,Z,S)},g=async($,S,U)=>{const B=[];let I=0,N=0;for(;I<$.length&&N<S.length;){const Z=$[I],W=S[N],re=await e.call(U,[Z,W]);x(re),re.value<0?(B.push($[I]),I++):(B.push(S[N]),N++)}return B.concat($.slice(I)).concat(S.slice(N))};return ce(n),Pe(s),s.value=await o(s.value,n),s}),fill:s=>b(async([n,e,o],g)=>{const $=n??R,S=e&&(x(e),e.value),U=o&&(x(o),o.value);return s.value.fill($,S,U),s}),repeat:s=>b(async([n],e)=>{x(n);try{return V(Array(n.value).fill(s.value).flat())}catch(o){throw n.value<0?new F("arr.repeat expected non-negative number, got negative"):Number.isInteger(n.value)?o:new F("arr.repeat expected integer, got non-integer")}}),splice:s=>b(async([n,e,o],g)=>{x(n);const $=n.value<-s.value.length?0:n.value<0?s.value.length+n.value:n.value>=s.value.length?s.value.length:n.value,S=e!=null?(x(e),e.value):s.value.length-$,U=o!=null?(Pe(o),o.value):[],B=s.value.splice($,S,...U);return V(B)}),flat:s=>b(async([n],e)=>{if(n=n??_(1),x(n),!Number.isInteger(n.value))throw new F("arr.flat expected integer, got non-integer");if(n.value<0)throw new F("arr.flat expected non-negative number, got negative");const o=($,S,U)=>{if(S===0){U.push(...$);return}for(const B of $)tr(B)?o(B.value,S-1,U):U.push(B)},g=[];return o(s.value,n.value,g),V(g)}),flat_map:s=>b(async([n],e)=>{ce(n);const o=s.value.map(async($,S)=>{const U=await e.call(n,[$,_(S)]);return tr(U)?U.value:U}),g=await Promise.all(o);return V(g.flat())}),every:s=>b(async([n],e)=>{ce(n);for(let o=0;o<s.value.length;o++){const g=s.value[o],$=await e.call(n,[g,_(o)]);if(Y($),!$.value)return X}return K}),some:s=>b(async([n],e)=>{ce(n);for(let o=0;o<s.value.length;o++){const g=s.value[o],$=await e.call(n,[g,_(o)]);if(Y($),$.value)return K}return X}),insert:s=>b(async([n,e],o)=>(x(n),te(e),s.value.splice(n.value,0,e),R)),remove:s=>b(async([n],e)=>(x(n),s.value.splice(n.value,1)[0]??R)),at:s=>b(async([n,e],o)=>(x(n),s.value.at(n.value)??e??R))},error:{name:s=>D(s.value),info:s=>s.info??R}};function Yl(s,n){if(Object.hasOwn(fs,s.type)){const e=fs[s.type];if(Object.hasOwn(e,n))return e[n](s);throw new F(`No such prop (${n}) in ${s.type}.`)}else throw new F(`Cannot read prop of ${s.type}. (reading ${n})`)}const ei={mut(s){return{isMutable:!0,value:s}},const(s){return{isMutable:!1,value:s}}};var se=(function(s,n,e,o){var g=arguments.length,$=g<3?n:o===null?o=Object.getOwnPropertyDescriptor(n,e):o,S;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")$=Reflect.decorate(s,n,e,o);else for(var U=s.length-1;U>=0;U--)(S=s[U])&&($=(g<3?S($):g>3?S(n,e,$):S(n,e))||$);return g>3&&$&&Object.defineProperty(n,e,$),$});const ms=300,ri=ms-1;class ae{opts;stepCount=0;stop=!1;scope;abortHandlers=[];vars={};constructor(n,e={}){this.opts=e;const o={print:b(([g])=>{te(g),this.opts.out&&this.opts.out(g)}),readline:b(async g=>{const $=g[0];if(q($),this.opts.in==null)return R;const S=await this.opts.in($.value);return D(S)})};this.vars=Object.fromEntries(Object.entries({...n,...Xl,...o}).map(([g,$])=>[g,ei.const($)])),this.scope=new ie([new Map(Object.entries(this.vars))]),this.scope.opts.log=(g,$)=>{switch(g){case"add":this.log("var:add",$);break;case"read":this.log("var:read",$);break;case"write":this.log("var:write",$);break}}}async exec(n){if(!(n==null||n.length===0))try{await this.collectNs(n);const e=await this._run(n,this.scope);this.log("end",{val:e})}catch(e){this.handleError(e)}}async execFn(n,e){return await this._fn(n,e).catch(o=>(this.handleError(o),kr("func_failed")))}execFnSimple(n,e){return this._fn(n,e)}static collectMetadata(n){if(n==null||n.length===0)return;function e(g){switch(g.type){case"arr":return g.value.map($=>e($));case"bool":return g.value;case"null":return null;case"num":return g.value;case"obj":{const $={};for(const[S,U]of g.value.entries())$[S]=e(U);return $}case"str":return g.value;default:return}}const o=new Map;for(const g of n)switch(g.type){case"meta":{o.set(g.name,e(g.value));break}}return o}handleError(n){if(!this.opts.err)throw n;if(this.opts.abortOnError){if(this.stop)return;this.abort()}n instanceof Oe?this.opts.err(n):this.opts.err(new hs(n))}log(n,e){this.opts.log&&this.opts.log(n,e)}async collectNs(n,e=this.scope){for(const o of n)switch(o.type){case"ns":{await this.collectNsMember(o,e);break}}}async collectNsMember(n,e=this.scope){const o=e.createChildNamespaceScope(n.name);await this.collectNs(n.members,o);for(const g of n.members)switch(g.type){case"def":{if(g.mut)throw new Error("Namespaces cannot include mutable variable: "+g.name);const $={isMutable:g.mut,value:await this._eval(g.expr,o)};o.add(g.name,$);break}case"ns":break;default:throw new Error("invalid ns member type: "+g.type)}}async _fn(n,e){if(n.native)return n.native(e,{call:this.execFnSimple,topCall:this.execFn,registerAbortHandler:this.registerAbortHandler,unregisterAbortHandler:this.unregisterAbortHandler})??R;{const o=new Map;for(let $=0;$<(n.args??[]).length;$++)o.set(n.args[$],{isMutable:!0,value:e[$]??R});const g=n.scope.createChildScope(o);return ys(await this._run(n.statements,g))}}async _eval(n,e){if(this.stop)return R;if(this.stepCount%ms===ri&&await new Promise(o=>setTimeout(o,5)),this.stepCount++,this.opts.maxStep&&this.stepCount>this.opts.maxStep)throw new F("max step exceeded");switch(n.type){case"call":{const o=await this._eval(n.target,e);ce(o);const g=await Promise.all(n.args.map($=>this._eval($,e)));return this._fn(o,g)}case"if":{const o=await this._eval(n.cond,e);if(Y(o),o.value)return this._eval(n.then,e);if(n.elseif&&n.elseif.length>0){for(const g of n.elseif){const $=await this._eval(g.cond,e);if(Y($),$.value)return this._eval(g.then,e)}if(n.else)return this._eval(n.else,e)}else if(n.else)return this._eval(n.else,e);return R}case"match":{const o=await this._eval(n.about,e);for(const g of n.qs){const $=await this._eval(g.q,e);if(Le(o,$))return await this._eval(g.a,e)}return n.default?await this._eval(n.default,e):R}case"loop":{for(;;){const o=await this._run(n.statements,e.createChildScope());if(o.type==="break")break;if(o.type==="return")return o}return R}case"for":{if(n.times){const o=await this._eval(n.times,e);x(o);for(let g=0;g<o.value;g++){const $=await this._eval(n.for,e);if($.type==="break")break;if($.type==="return")return $}}else{const o=await this._eval(n.from,e),g=await this._eval(n.to,e);x(o),x(g);for(let $=o.value;$<o.value+g.value;$++){const S=await this._eval(n.for,e.createChildScope(new Map([[n.var,{isMutable:!1,value:_($)}]])));if(S.type==="break")break;if(S.type==="return")return S}}return R}case"each":{const o=await this._eval(n.items,e);Pe(o);for(const g of o.value){const $=await this._eval(n.for,e.createChildScope(new Map([[n.var,{isMutable:!1,value:g}]])));if($.type==="break")break;if($.type==="return")return $}return R}case"def":{const o=await this._eval(n.expr,e);if(n.attr.length>0){const g=[];for(const $ of n.attr)g.push({name:$.name,value:await this._eval($.value,e)});o.attr=g}return e.add(n.name,{isMutable:n.mut,value:o}),R}case"identifier":return e.get(n.name);case"assign":{const o=await this._eval(n.expr,e);return await this.assign(e,n.dest,o),R}case"addAssign":{const o=await this._eval(n.dest,e);x(o);const g=await this._eval(n.expr,e);return x(g),await this.assign(e,n.dest,_(o.value+g.value)),R}case"subAssign":{const o=await this._eval(n.dest,e);x(o);const g=await this._eval(n.expr,e);return x(g),await this.assign(e,n.dest,_(o.value-g.value)),R}case"null":return R;case"bool":return Ne(n.value);case"num":return _(n.value);case"str":return D(n.value);case"arr":return V(await Promise.all(n.value.map(o=>this._eval(o,e))));case"obj":{const o=new Map;for(const g of n.value.keys())o.set(g,await this._eval(n.value.get(g),e));return rr(o)}case"prop":{const o=await this._eval(n.target,e);return Ar(o)?o.value.has(n.name)?o.value.get(n.name):R:Yl(o,n.name)}case"index":{const o=await this._eval(n.target,e),g=await this._eval(n.index,e);if(tr(o)){x(g);const $=o.value[g.value];if($===void 0)throw new Vr(`Index out of range. index: ${g.value} max: ${o.value.length-1}`);return $}else{if(Ar(o))return q(g),o.value.has(g.value)?o.value.get(g.value):R;throw new F(`Cannot read prop (${He(g)}) of ${o.type}.`)}}case"not":{const o=await this._eval(n.expr,e);return Y(o),Ne(!o.value)}case"fn":return vs(n.args.map(o=>o.name),n.children,e);case"block":return this._run(n.statements,e.createChildScope());case"exists":return Ne(e.exists(n.identifier.name));case"tmpl":{let o="";for(const g of n.tmpl)if(typeof g=="string")o+=g;else{const $=await this._eval(g,e);o+=He($)}return D(o)}case"return":{const o=await this._eval(n.expr,e);return this.log("block:return",{scope:e.name,val:o}),gs(o)}case"break":return this.log("block:break",{scope:e.name}),ds();case"continue":return this.log("block:continue",{scope:e.name}),ws();case"ns":return R;case"meta":return R;case"and":{const o=await this._eval(n.left,e);if(Y(o),o.value){const g=await this._eval(n.right,e);return Y(g),g}else return o}case"or":{const o=await this._eval(n.left,e);if(Y(o),o.value)return o;{const g=await this._eval(n.right,e);return Y(g),g}}default:throw new Error("invalid node type")}}async _run(n,e){this.log("block:enter",{scope:e.name});let o=R;for(let g=0;g<n.length;g++){const $=n[g];if(o=await this._eval($,e),o.type==="return")return this.log("block:return",{scope:e.name,val:o.value}),o;if(o.type==="break")return this.log("block:break",{scope:e.name}),o;if(o.type==="continue")return this.log("block:continue",{scope:e.name}),o}return this.log("block:leave",{scope:e.name,val:o}),o}registerAbortHandler(n){this.abortHandlers.push(n)}unregisterAbortHandler(n){this.abortHandlers=this.abortHandlers.filter(e=>e!==n)}abort(){this.stop=!0;for(const n of this.abortHandlers)n();this.abortHandlers=[]}async assign(n,e,o){if(e.type==="identifier")n.assign(e.name,o);else if(e.type==="index"){const g=await this._eval(e.target,n),$=await this._eval(e.index,n);if(tr(g)){if(x($),g.value[$.value]===void 0)throw new Vr(`Index out of range. index: ${$.value} max: ${g.value.length-1}`);g.value[$.value]=o}else if(Ar(g))q($),g.value.set($.value,o);else throw new F(`Cannot read prop (${He($)}) of ${g.type}.`)}else if(e.type==="prop"){const g=await this._eval(e.target,n);oe(g),g.value.set(e.name,o)}else if(e.type==="arr")Pe(o),await Promise.all(e.value.map((g,$)=>this.assign(n,g,o.value[$]??R)));else if(e.type==="obj")oe(o),await Promise.all([...e.value].map(([g,$])=>this.assign(n,$,o.value.get(g)??R)));else throw new F("The left-hand side of an assignment expression must be a variable or a property/index access.")}}se([Q],ae.prototype,"exec",null);se([Q],ae.prototype,"execFn",null);se([Q],ae.prototype,"execFnSimple",null);se([Q],ae.prototype,"handleError",null);se([Q],ae.prototype,"log",null);se([Q],ae.prototype,"collectNs",null);se([Q],ae.prototype,"collectNsMember",null);se([Q],ae.prototype,"_fn",null);se([Q],ae.prototype,"_eval",null);se([Q],ae.prototype,"_run",null);se([Q],ae.prototype,"registerAbortHandler",null);se([Q],ae.prototype,"unregisterAbortHandler",null);se([Q],ae.prototype,"abort",null);se([Q],ae.prototype,"assign",null);se([Q],ae,"collectMetadata",null);function ti(s,n){function e(){this.constructor=s}e.prototype=n.prototype,s.prototype=new e}function qe(s,n,e,o){var g=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(g,qe.prototype),g.expected=n,g.found=e,g.location=o,g.name="SyntaxError",g}ti(qe,Error);function Lr(s,n,e){return e=e||" ",s.length>n?s:(n-=s.length,e+=e.repeat(n),s+e.slice(0,n))}qe.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var e=null,o;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){e=s[o].text.split(/\r\n|\n|\r/g);break}var g=this.location.start,$=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(g):g,S=this.location.source+":"+$.line+":"+$.column;if(e){var U=this.location.end,B=Lr("",$.line.toString().length," "),I=e[g.line-1],N=g.line===U.line?U.column:I.length+1,Z=N-g.column||1;n+=`
 --> `+S+`
`+B+` |
`+$.line+" | "+I+`
`+B+" | "+Lr("",g.column-1," ")+Lr("",Z,"^")}else n+=`
 at `+S}return n};qe.buildMessage=function(s,n){var e={literal:function(I){return'"'+g(I.text)+'"'},class:function(I){var N=I.parts.map(function(Z){return Array.isArray(Z)?$(Z[0])+"-"+$(Z[1]):$(Z)});return"["+(I.inverted?"^":"")+N.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(I){return I.description}};function o(I){return I.charCodeAt(0).toString(16).toUpperCase()}function g(I){return I.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(N){return"\\x0"+o(N)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(N){return"\\x"+o(N)})}function $(I){return I.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(N){return"\\x0"+o(N)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(N){return"\\x"+o(N)})}function S(I){return e[I.type](I)}function U(I){var N=I.map(S),Z,W;if(N.sort(),N.length>0){for(Z=1,W=1;Z<N.length;Z++)N[Z-1]!==N[Z]&&(N[W]=N[Z],W++);N.length=W}switch(N.length){case 1:return N[0];case 2:return N[0]+" or "+N[1];default:return N.slice(0,-1).join(", ")+", or "+N[N.length-1]}}function B(I){return I?'"'+g(I)+'"':"end of input"}return"Expected "+U(s)+" but "+B(n)+" found."};function os(s,n){n=n!==void 0?n:{};var e={},o=n.grammarSource,g={Preprocess:Ht,Main:Yn},$=Ht,S="//",U="/*",B="*/",I="(",N=")",Z="::",W="{",re="}",Re="###",ue="let",ne=":",Ie="=",zr="var",Jr="<:",Qr="#[",sr="]",ar="each",be=",",ke="for",Zr="return",Gr="loop",Wr="break",Kr="continue",Xr="+=",Yr="-=",et="\\",rt="||",tt="&&",st="==",at="!=",nt="<=",lt=">=",_s="!",Er="[",Tr=".",it="if",ut="elif",ft="else",ot="match",Me="=>",ks="*",ct="eval",ht="exists",nr="`",lr='"',ir="'",pt='\\"',vt="\\'",gt="true",dt="false",wt="null",Ms="@",ur="@(",Ss="<",Es=">",yt=`\r
`,xe=/^[A-Z0-9_:]/i,Ts=/^[%*-+\-\/<>\^]/,Ns=/^[^`{]/,js=/^[{}`]/,fr=/^[+\-]/,$t=/^[1-9]/,ge=/^[0-9]/,or=/^[,;]/,Os=/^[A-Z_]/i,mt=/^[A-Z0-9_]/i,Rs=/^[\r\n]/,Is=/^[ \t\r\n]/,Ds=/^[ \t]/,de=Zn(),Us=E("//",!1),Fs=E("/*",!1),Nr=E("*/",!1),Ve=E("(",!1),Se=E(")",!1),Ls=E("::",!1),we=E("{",!1),ye=E("}",!1),bt=E("###",!1),Ze=E("let",!1),he=E(":",!1),Ge=E("=",!1),Hs=E("var",!1),qs=E("<:",!1),Vs=E("#[",!1),cr=E("]",!1),xt=E("each",!1),Ae=E(",",!1),hr=E("for",!1),Bs=E("return",!1),Ce=le([["A","Z"],["0","9"],"_",":"],!1,!0),zs=E("loop",!1),Js=E("break",!1),Qs=E("continue",!1),Zs=E("+=",!1),Gs=E("-=",!1),At=E("\\",!1),Ws=E("||",!1),Ks=E("&&",!1),Xs=E("==",!1),Ys=E("!=",!1),ea=E("<=",!1),ra=E(">=",!1),ta=le(["%",["*","+"],"-","/","<",">","^"],!1,!1),sa=E("!",!1),jr=E("[",!1),Or=E(".",!1),aa=E("if",!1),na=E("elif",!1),la=E("else",!1),ia=E("match",!1),pr=E("=>",!1),ua=E("*",!1),fa=E("eval",!1),oa=E("exists",!1),vr=E("`",!1),ca=le(["`","{"],!0,!1),ha=le(["{","}","`"],!1,!1),gr=E('"',!1),dr=E("'",!1),pa=E('\\"',!1),va=E("\\'",!1),wr=le(["+","-"],!1,!1),Ct=le([["1","9"]],!1,!1),$e=le([["0","9"]],!1,!1),ga=E("true",!1),da=E("false",!1),wa=E("null",!1),yr=le([",",";"],!1,!1),ya=E("@",!1),Pt=E("@(",!1),$a=E("<",!1),ma=E(">",!1),ba=le([["A","Z"],"_"],!1,!0),_t=le([["A","Z"],["0","9"],"_"],!1,!0),xa=E(`\r
`,!1),Aa=le(["\r",`
`],!1,!1),Ca=le([" ","	","\r",`
`],!1,!1),Pa=le([" ","	"],!1,!1),_a=function(r){return r.join("")},ka=function(){return ve()},Ma=function(){return ve()},Sa=function(){return" ".repeat(ve().length)},Ea=function(){return ve().replace(/[^\n]/g," ")},Ta=function(r){return r??[]},kt=function(r,l){return l},Na=function(r,l){return[r,...l]},Mt=function(r,l){return l},ja=function(r,l){return[r,...l]},St=function(r,l){return l},Oa=function(r,l){return[r,...l]},Ra=function(r){return r},Ia=function(r,l){return T("ns",{name:r,members:l})},Da=function(r,l){return T("meta",{name:r,value:l})},Ua=function(r){return T("meta",{name:null,value:r})},Fa=function(r,l,f){return T("def",{name:r,varType:l,expr:f,mut:!1,attr:[]})},La=function(r,l,f){return T("def",{name:r,varType:l,expr:f,mut:!0,attr:[]})},Ha=function(r){return T("identifier",{name:"print",chain:[T("callChain",{args:[r]})]})},qa=function(r,l){return T("attr",{name:r,value:l??T("bool",{value:!0})})},Va=function(r,l,f){return T("each",{var:r,items:l,for:f})},Ba=function(r,l,f){return T("each",{var:r,items:l,for:f})},za=function(r,l){return l},Ja=function(r,l,f,a){return T("for",{var:r,from:l??T("num",{value:0}),to:f,for:a})},Qa=function(r,l){return l},Za=function(r,l,f,a){return T("for",{var:r,from:l??T("num",{value:0}),to:f,for:a})},Ga=function(r,l){return T("for",{times:r,for:l})},Wa=function(r,l){return T("for",{times:r,for:l})},Ka=function(r){return T("return",{expr:r})},Xa=function(r){return T("loop",{statements:r})},Ya=function(){return T("break",{})},en=function(){return T("continue",{})},rn=function(r,l,f){return l==="+="?T("addAssign",{dest:r,expr:f}):l==="-="?T("subAssign",{dest:r,expr:f}):T("assign",{dest:r,expr:f})},Et=function(r,l,f){return{op:l,term:f}},tn=function(r,l){return T("infix",{operands:[r,...l.map(f=>f.term)],operators:l.map(f=>f.op.value),operatorLocs:l.map(f=>f.op.loc)})},sn=function(){const r=Ft();return{value:ve(),loc:{start:r.start.offset,end:r.end.offset-1}}},an=function(r){return T("not",{expr:r})},nn=function(r,l){return r.chain?{...r,chain:[...r.chain,...l]}:{...r,chain:l}},ln=function(r){return T("callChain",{args:r??[]})},Tt=function(r,l){return l},un=function(r,l){return[r,...l]},fn=function(r){return T("indexChain",{index:r})},on=function(r){return T("propChain",{name:r})},cn=function(r,l,f,a){return T("if",{cond:r,then:l,elseif:f??[],else:a})},hn=function(r,l){return[r,...l]},pn=function(r,l){return{cond:r,then:l}},vn=function(r){return r},Nt=function(r,l,f){return{q:l,a:f}},gn=function(r,l,f){return T("match",{about:r,qs:l??[],default:f})},dn=function(r){return T("block",{statements:r})},wn=function(r){return T("exists",{identifier:r})},yn=function(r){return T("identifier",{name:r})},$n=function(r){return T("tmpl",{tmpl:r})},mn=function(r){return r.join("")},jt=function(r){return r},bn=function(r){return T("str",{value:r.join("")})},Ot=function(r){return r},xn=function(r){return T("str",{value:r.join("")})},An=function(){return'"'},Cn=function(){return"'"},Pn=function(){return T("num",{value:parseFloat(ve())})},_n=function(){return T("num",{value:parseFloat(ve())})},kn=function(){return T("num",{value:parseInt(ve(),10)})},Mn=function(){return T("num",{value:parseInt(ve(),10)})},Sn=function(){return T("bool",{value:!0})},En=function(){return T("bool",{value:!1})},Tn=function(){return T("null",{})},Rt=function(r,l){return{k:r,v:l}},Nn=function(r){const l=new Map;for(const f of r)l.set(f.k,f.v);return T("obj",{value:l})},It=function(r){return r},jn=function(r){return T("arr",{value:r})},On=function(r,l){return{name:r,argType:l}},Rn=function(r,l){return[r,...l]},In=function(r,l,f,a,u,i){return(r.length>0||f.length>0)&&Qn("Cannot use spaces before or after the function name."),T("def",{name:l,expr:T("fn",{args:a??[],retType:u},i??[]),mut:!1,attr:[]})},Dn=function(r,l,f){return T("fn",{args:r??[],retType:l},f??[])},Dt=function(r){return r},Un=function(r){return T("arr",{value:r})},Ut=function(r,l){return{k:r,v:l}},Fn=function(r){const l=new Map;for(const f of r)l.set(f.k,f.v);return T("obj",{value:l})},Ln=function(r,l){return T("fnTypeSource",{args:r??[],result:l})},Hn=function(r,l){return[r,...l]},qn=function(r,l){return T("namedTypeSource",{name:r,inner:l})},Vn=function(r){return T("namedTypeSource",{name:r,inner:null})},Bn=function(){return ve()},zn=function(){return ve()},Jn=function(r){return T("block",{statements:r??[]})},t=n.peg$currPos|0,C=t,Be=[{line:1,column:1}],pe=t,$r=n.peg$maxFailExpected||[],v=n.peg$silentFails|0,m={},We;if(n.startRule){if(!(n.startRule in g))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');$=g[n.startRule]}function ve(){return s.substring(C,t)}function Ft(){return mr(C,t)}function Qn(r,l){throw l=l!==void 0?l:mr(C,t),Wn(r,l)}function E(r,l){return{type:"literal",text:r,ignoreCase:l}}function le(r,l,f){return{type:"class",parts:r,inverted:l,ignoreCase:f}}function Zn(){return{type:"any"}}function Gn(){return{type:"end"}}function Lt(r){var l=Be[r],f;if(l)return l;if(r>=Be.length)f=Be.length-1;else for(f=r;!Be[--f];);for(l=Be[f],l={line:l.line,column:l.column};f<r;)s.charCodeAt(f)===10?(l.line++,l.column=1):l.column++,f++;return Be[r]=l,l}function mr(r,l,f){var a=Lt(r),u=Lt(l),i={source:o,start:{offset:r,line:a.line,column:a.column},end:{offset:l,line:u.line,column:u.column}};return i}function d(r){t<pe||(t>pe&&(pe=t,$r=[]),$r.push(r))}function Wn(r,l){return new qe(r,null,null,l)}function Kn(r,l,f){return new qe(qe.buildMessage(r,l),r,l,f)}function Ht(){var r,l,f,a=t*77+0,u=m[a];if(u)return t=u.nextPos,u.result;for(r=t,l=[],f=qt();f!==e;)l.push(f),f=qt();return C=r,l=_a(l),r=l,m[a]={nextPos:t,result:r},r}function qt(){var r,l,f=t*77+1,a=m[f];return a?(t=a.nextPos,a.result):(r=t,l=Kt(),l!==e&&(C=r,l=ka()),r=l,r===e&&(r=t,l=Ur(),l!==e&&(C=r,l=Ma()),r=l,r===e&&(r=Xn(),r===e&&(s.length>t?(r=s.charAt(t),t++):(r=e,v===0&&d(de))))),m[f]={nextPos:t,result:r},r)}function Xn(){var r,l,f,a,u,i,p=t*77+2,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.substr(t,2)===S?(l=S,t+=2):(l=e,v===0&&d(Us)),l!==e){for(f=[],a=t,u=t,v++,i=is(),v--,i===e?u=void 0:(t=u,u=e),u!==e?(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de)),i!==e?(u=[u,i],a=u):(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=t,v++,i=is(),v--,i===e?u=void 0:(t=u,u=e),u!==e?(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de)),i!==e?(u=[u,i],a=u):(t=a,a=e)):(t=a,a=e);C=r,r=Sa()}else t=r,r=e;if(r===e)if(r=t,s.substr(t,2)===U?(l=U,t+=2):(l=e,v===0&&d(Fs)),l!==e){for(f=[],a=t,u=t,v++,s.substr(t,2)===B?(i=B,t+=2):(i=e,v===0&&d(Nr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de)),i!==e?(u=[u,i],a=u):(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=t,v++,s.substr(t,2)===B?(i=B,t+=2):(i=e,v===0&&d(Nr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de)),i!==e?(u=[u,i],a=u):(t=a,a=e)):(t=a,a=e);s.substr(t,2)===B?(a=B,t+=2):(a=e,v===0&&d(Nr)),a!==e?(C=r,r=Ea()):(t=r,r=e)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function Yn(){var r,l,f,a,u,i=t*77+3,p=m[i];if(p)return t=p.nextPos,p.result;for(r=t,l=[],f=h();f!==e;)l.push(f),f=h();for(f=el(),f===e&&(f=null),a=[],u=h();u!==e;)a.push(u),u=h();return C=r,r=Ta(f),m[i]={nextPos:t,result:r},r}function el(){var r,l,f,a,u,i,p,c,y=t*77+4,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,l=Rr(),l!==e){for(f=[],a=t,u=[],i=H();i!==e;)u.push(i),i=H();if(i=Te(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=Rr(),c!==e?(C=a,a=kt(l,c)):(t=a,a=e)}else t=a,a=e;for(;a!==e;){for(f.push(a),a=t,u=[],i=H();i!==e;)u.push(i),i=H();if(i=Te(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=Rr(),c!==e?(C=a,a=kt(l,c)):(t=a,a=e)}else t=a,a=e}C=r,r=Na(l,f)}else t=r,r=e;return m[y]={nextPos:t,result:r},r}function rl(){var r,l,f,a,u,i,p,c,y=t*77+5,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,l=Ir(),l!==e){for(f=[],a=t,u=[],i=H();i!==e;)u.push(i),i=H();if(i=Te(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=Ir(),c!==e?(C=a,a=Mt(l,c)):(t=a,a=e)}else t=a,a=e;for(;a!==e;){for(f.push(a),a=t,u=[],i=H();i!==e;)u.push(i),i=H();if(i=Te(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=Ir(),c!==e?(C=a,a=Mt(l,c)):(t=a,a=e)}else t=a,a=e}C=r,r=ja(l,f)}else t=r,r=e;return m[y]={nextPos:t,result:r},r}function Ke(){var r,l,f,a,u,i,p,c,y=t*77+6,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,l=Xe(),l!==e){for(f=[],a=t,u=[],i=H();i!==e;)u.push(i),i=H();if(i=Te(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=Xe(),c!==e?(C=a,a=St(l,c)):(t=a,a=e)}else t=a,a=e;for(;a!==e;){for(f.push(a),a=t,u=[],i=H();i!==e;)u.push(i),i=H();if(i=Te(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=Xe(),c!==e?(C=a,a=St(l,c)):(t=a,a=e)}else t=a,a=e}C=r,r=Oa(l,f)}else t=r,r=e;return m[y]={nextPos:t,result:r},r}function Rr(){var r,l=t*77+7,f=m[l];return f?(t=f.nextPos,f.result):(r=Bt(),r===e&&(r=tl(),r===e&&(r=Xe())),m[l]={nextPos:t,result:r},r)}function Ir(){var r,l=t*77+8,f=m[l];return f?(t=f.nextPos,f.result):(r=zt(),r===e&&(r=ls(),r===e&&(r=Bt())),m[l]={nextPos:t,result:r},r)}function Xe(){var r,l=t*77+9,f=m[l];return f?(t=f.nextPos,f.result):(r=zt(),r===e&&(r=ls(),r===e&&(r=sl(),r===e&&(r=il(),r===e&&(r=al(),r===e&&(r=nl(),r===e&&(r=ll(),r===e&&(r=ul(),r===e&&(r=fl(),r===e&&(r=ol(),r===e&&(r=cl(),r===e&&(r=L()))))))))))),m[l]={nextPos:t,result:r},r)}function L(){var r,l=t*77+10,f=m[l];return f?(t=f.nextPos,f.result):(r=hl(),r===e&&(r=br()),m[l]={nextPos:t,result:r},r)}function br(){var r,l=t*77+11,f=m[l];return f?(t=f.nextPos,f.result):(r=dl(),r===e&&(r=Sl(),r===e&&(r=vl(),r===e&&(r=Vt()))),m[l]={nextPos:t,result:r},r)}function Vt(){var r,l,f,a,u,i,p=t*77+12,c=m[p];if(c)return t=c.nextPos,c.result;if(r=$l(),r===e&&(r=ml(),r===e&&(r=bl(),r===e&&(r=Kt(),r===e&&(r=Ur(),r===e&&(r=ts(),r===e&&(r=ss(),r===e&&(r=as(),r===e&&(r=kl(),r===e&&(r=Ml(),r===e&&(r=pl(),r===e&&(r=Wt(),r===e))))))))))))if(r=t,s.charCodeAt(t)===40?(l=I,t++):(l=e,v===0&&d(Ve)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=L(),a!==e){for(u=[],i=h();i!==e;)u.push(i),i=h();s.charCodeAt(t)===41?(i=N,t++):(i=e,v===0&&d(Se)),i!==e?(C=r,r=Ra(a)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function De(){var r,l=t*77+13,f=m[l];return f?(t=f.nextPos,f.result):(r=ts(),r===e&&(r=Ur(),r===e&&(r=ss(),r===e&&(r=El(),r===e&&(r=Tl(),r===e&&(r=as()))))),m[l]={nextPos:t,result:r},r)}function Bt(){var r,l,f,a,u,i,p,c,y,w,P=t*77+14,A=m[P];if(A)return t=A.nextPos,A.result;if(r=t,s.substr(t,2)===Z?(l=Z,t+=2):(l=e,v===0&&d(Ls)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(a=G(),a!==e){if(u=[],i=h(),i!==e)for(;i!==e;)u.push(i),i=h();else u=e;if(u!==e)if(s.charCodeAt(t)===123?(i=W,t++):(i=e,v===0&&d(we)),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(c=rl(),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();s.charCodeAt(t)===125?(w=re,t++):(w=e,v===0&&d(ye)),w!==e?(C=r,r=Ia(a,c)):(t=r,r=e)}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;return m[P]={nextPos:t,result:r},r}function tl(){var r,l,f,a,u,i,p=t*77+15,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.substr(t,3)===Re?(l=Re,t+=3):(l=e,v===0&&d(bt)),l!==e){for(f=[],a=H();a!==e;)f.push(a),a=H();if(a=G(),a!==e){for(u=[],i=h();i!==e;)u.push(i),i=h();i=De(),i!==e?(C=r,r=Da(a,i)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;if(r===e)if(r=t,s.substr(t,3)===Re?(l=Re,t+=3):(l=e,v===0&&d(bt)),l!==e){for(f=[],a=H();a!==e;)f.push(a),a=H();a=De(),a!==e?(C=r,r=Ua(a)):(t=r,r=e)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function zt(){var r,l,f,a,u,i,p,c,y,w=t*77+16,P=m[w];if(P)return t=P.nextPos,P.result;if(r=t,s.substr(t,3)===ue?(l=ue,t+=3):(l=e,v===0&&d(Ze)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(a=G(),a!==e){for(u=t,i=[],p=h();p!==e;)i.push(p),p=h();if(s.charCodeAt(t)===58?(p=ne,t++):(p=e,v===0&&d(he)),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();y=me(),y!==e?u=y:(t=u,u=e)}else t=u,u=e;for(u===e&&(u=null),i=[],p=h();p!==e;)i.push(p),p=h();if(s.charCodeAt(t)===61?(p=Ie,t++):(p=e,v===0&&d(Ge)),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();y=L(),y!==e?(C=r,r=Fa(a,u,y)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;if(r===e)if(r=t,s.substr(t,3)===zr?(l=zr,t+=3):(l=e,v===0&&d(Hs)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(a=G(),a!==e){for(u=t,i=[],p=h();p!==e;)i.push(p),p=h();if(s.charCodeAt(t)===58?(p=ne,t++):(p=e,v===0&&d(he)),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();y=me(),y!==e?u=y:(t=u,u=e)}else t=u,u=e;for(u===e&&(u=null),i=[],p=h();p!==e;)i.push(p),p=h();if(s.charCodeAt(t)===61?(p=Ie,t++):(p=e,v===0&&d(Ge)),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();y=L(),y!==e?(C=r,r=La(a,u,y)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;return m[w]={nextPos:t,result:r},r}function sl(){var r,l,f,a,u=t*77+17,i=m[u];if(i)return t=i.nextPos,i.result;if(r=t,s.substr(t,2)===Jr?(l=Jr,t+=2):(l=e,v===0&&d(qs)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();a=L(),a!==e?(C=r,r=Ha(a)):(t=r,r=e)}else t=r,r=e;return m[u]={nextPos:t,result:r},r}function al(){var r,l,f,a,u,i,p,c=t*77+18,y=m[c];if(y)return t=y.nextPos,y.result;if(r=t,s.substr(t,2)===Qr?(l=Qr,t+=2):(l=e,v===0&&d(Vs)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=G(),a!==e){for(u=t,i=[],p=h();p!==e;)i.push(p),p=h();for(p=De(),p!==e?u=p:(t=u,u=e),u===e&&(u=null),i=[],p=h();p!==e;)i.push(p),p=h();s.charCodeAt(t)===93?(p=sr,t++):(p=e,v===0&&d(cr)),p!==e?(C=r,r=qa(a,u)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;return m[c]={nextPos:t,result:r},r}function nl(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j,M=t*77+19,z=m[M];if(z)return t=z.nextPos,z.result;if(r=t,s.substr(t,4)===ar?(l=ar,t+=4):(l=e,v===0&&d(xt)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(s.charCodeAt(t)===40?(a=I,t++):(a=e,v===0&&d(Ve)),a!==e)if(s.substr(t,3)===ue?(u=ue,t+=3):(u=e,v===0&&d(Ze)),u!==e){if(i=[],p=h(),p!==e)for(;p!==e;)i.push(p),p=h();else i=e;if(i!==e)if(p=G(),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();for(s.charCodeAt(t)===44?(y=be,t++):(y=e,v===0&&d(Ae)),y===e&&(y=null),w=[],P=h();P!==e;)w.push(P),P=h();if(P=L(),P!==e)if(s.charCodeAt(t)===41?(A=N,t++):(A=e,v===0&&d(Se)),A!==e){for(k=[],j=h();j!==e;)k.push(j),j=h();j=fe(),j!==e?(C=r,r=Va(p,P,j)):(t=r,r=e)}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;if(r===e)if(r=t,s.substr(t,4)===ar?(l=ar,t+=4):(l=e,v===0&&d(xt)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(s.substr(t,3)===ue?(a=ue,t+=3):(a=e,v===0&&d(Ze)),a!==e){if(u=[],i=h(),i!==e)for(;i!==e;)u.push(i),i=h();else u=e;if(u!==e)if(i=G(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(s.charCodeAt(t)===44?(c=be,t++):(c=e,v===0&&d(Ae)),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();if(w=L(),w!==e){if(P=[],A=h(),A!==e)for(;A!==e;)P.push(A),A=h();else P=e;P!==e?(A=fe(),A!==e?(C=r,r=Ba(i,w,A)):(t=r,r=e)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;return m[M]={nextPos:t,result:r},r}function ll(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j,M,z=t*77+20,J=m[z];if(J)return t=J.nextPos,J.result;if(r=t,s.substr(t,3)===ke?(l=ke,t+=3):(l=e,v===0&&d(hr)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(s.charCodeAt(t)===40?(a=I,t++):(a=e,v===0&&d(Ve)),a!==e)if(s.substr(t,3)===ue?(u=ue,t+=3):(u=e,v===0&&d(Ze)),u!==e){if(i=[],p=h(),p!==e)for(;p!==e;)i.push(p),p=h();else i=e;if(i!==e)if(p=G(),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();if(y=t,s.charCodeAt(t)===61?(w=Ie,t++):(w=e,v===0&&d(Ge)),w!==e){for(P=[],A=h();A!==e;)P.push(A),A=h();A=L(),A!==e?(C=y,y=za(p,A)):(t=y,y=e)}else t=y,y=e;for(y===e&&(y=null),s.charCodeAt(t)===44?(w=be,t++):(w=e,v===0&&d(Ae)),w===e&&(w=null),P=[],A=h();A!==e;)P.push(A),A=h();if(A=L(),A!==e)if(s.charCodeAt(t)===41?(k=N,t++):(k=e,v===0&&d(Se)),k!==e){for(j=[],M=h();M!==e;)j.push(M),M=h();M=fe(),M!==e?(C=r,r=Ja(p,y,A,M)):(t=r,r=e)}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;if(r===e){if(r=t,s.substr(t,3)===ke?(l=ke,t+=3):(l=e,v===0&&d(hr)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(s.substr(t,3)===ue?(a=ue,t+=3):(a=e,v===0&&d(Ze)),a!==e){if(u=[],i=h(),i!==e)for(;i!==e;)u.push(i),i=h();else u=e;if(u!==e)if(i=G(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();if(c=t,s.charCodeAt(t)===61?(y=Ie,t++):(y=e,v===0&&d(Ge)),y!==e){for(w=[],P=h();P!==e;)w.push(P),P=h();P=L(),P!==e?(C=c,c=Qa(i,P)):(t=c,c=e)}else t=c,c=e;for(c===e&&(c=null),s.charCodeAt(t)===44?(y=be,t++):(y=e,v===0&&d(Ae)),y===e&&(y=null),w=[],P=h();P!==e;)w.push(P),P=h();if(P=L(),P!==e){if(A=[],k=h(),k!==e)for(;k!==e;)A.push(k),k=h();else A=e;A!==e?(k=fe(),k!==e?(C=r,r=Za(i,c,P,k)):(t=r,r=e)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;if(r===e){if(r=t,s.substr(t,3)===ke?(l=ke,t+=3):(l=e,v===0&&d(hr)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(s.charCodeAt(t)===40?(a=I,t++):(a=e,v===0&&d(Ve)),a!==e)if(u=L(),u!==e)if(s.charCodeAt(t)===41?(i=N,t++):(i=e,v===0&&d(Se)),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();c=fe(),c!==e?(C=r,r=Ga(u,c)):(t=r,r=e)}else t=r,r=e;else t=r,r=e;else t=r,r=e}else t=r,r=e;if(r===e)if(r=t,s.substr(t,3)===ke?(l=ke,t+=3):(l=e,v===0&&d(hr)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(a=L(),a!==e){if(u=[],i=h(),i!==e)for(;i!==e;)u.push(i),i=h();else u=e;u!==e?(i=fe(),i!==e?(C=r,r=Wa(a,i)):(t=r,r=e)):(t=r,r=e)}else t=r,r=e;else t=r,r=e}else t=r,r=e}}return m[z]={nextPos:t,result:r},r}function il(){var r,l,f,a,u,i=t*77+21,p=m[i];if(p)return t=p.nextPos,p.result;if(r=t,s.substr(t,6)===Zr?(l=Zr,t+=6):(l=e,v===0&&d(Bs)),l!==e)if(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e){for(a=[],u=h();u!==e;)a.push(u),u=h();u=L(),u!==e?(C=r,r=Ka(u)):(t=r,r=e)}else t=r,r=e;else t=r,r=e;return m[i]={nextPos:t,result:r},r}function ul(){var r,l,f,a,u,i,p,c,y=t*77+22,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,s.substr(t,4)===Gr?(l=Gr,t+=4):(l=e,v===0&&d(zs)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(s.charCodeAt(t)===123?(a=W,t++):(a=e,v===0&&d(we)),a!==e){for(u=[],i=h();i!==e;)u.push(i),i=h();if(i=Ke(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();s.charCodeAt(t)===125?(c=re,t++):(c=e,v===0&&d(ye)),c!==e?(C=r,r=Xa(i)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e;return m[y]={nextPos:t,result:r},r}function fl(){var r,l,f,a,u=t*77+23,i=m[u];return i?(t=i.nextPos,i.result):(r=t,s.substr(t,5)===Wr?(l=Wr,t+=5):(l=e,v===0&&d(Js)),l!==e?(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e?(C=r,r=Ya()):(t=r,r=e)):(t=r,r=e),m[u]={nextPos:t,result:r},r)}function ol(){var r,l,f,a,u=t*77+24,i=m[u];return i?(t=i.nextPos,i.result):(r=t,s.substr(t,8)===Kr?(l=Kr,t+=8):(l=e,v===0&&d(Qs)),l!==e?(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e?(C=r,r=en()):(t=r,r=e)):(t=r,r=e),m[u]={nextPos:t,result:r},r)}function cl(){var r,l,f,a,u,i,p=t*77+25,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,l=L(),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(s.substr(t,2)===Xr?(a=Xr,t+=2):(a=e,v===0&&d(Zs)),a===e&&(s.substr(t,2)===Yr?(a=Yr,t+=2):(a=e,v===0&&d(Gs)),a===e&&(s.charCodeAt(t)===61?(a=Ie,t++):(a=e,v===0&&d(Ge)))),a!==e){for(u=[],i=h();i!==e;)u.push(i),i=h();i=L(),i!==e?(C=r,r=rn(l,a,i)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function hl(){var r,l,f,a,u,i,p,c,y=t*77+26,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,l=br(),l!==e){for(f=[],a=t,u=[],i=Ee();i!==e;)u.push(i),i=Ee();if(i=Jt(),i!==e){for(p=[],c=Ee();c!==e;)p.push(c),c=Ee();c=br(),c!==e?(C=a,a=Et(l,i,c)):(t=a,a=e)}else t=a,a=e;if(a!==e)for(;a!==e;){for(f.push(a),a=t,u=[],i=Ee();i!==e;)u.push(i),i=Ee();if(i=Jt(),i!==e){for(p=[],c=Ee();c!==e;)p.push(c),c=Ee();c=br(),c!==e?(C=a,a=Et(l,i,c)):(t=a,a=e)}else t=a,a=e}else f=e;f!==e?(C=r,r=tn(l,f)):(t=r,r=e)}else t=r,r=e;return m[y]={nextPos:t,result:r},r}function Ee(){var r,l,f,a=t*77+27,u=m[a];return u?(t=u.nextPos,u.result):(r=t,s.charCodeAt(t)===92?(l=et,t++):(l=e,v===0&&d(At)),l!==e?(f=Te(),f!==e?(l=[l,f],r=l):(t=r,r=e)):(t=r,r=e),r===e&&(r=H()),m[a]={nextPos:t,result:r},r)}function Jt(){var r,l,f=t*77+28,a=m[f];return a?(t=a.nextPos,a.result):(r=t,s.substr(t,2)===rt?(l=rt,t+=2):(l=e,v===0&&d(Ws)),l===e&&(s.substr(t,2)===tt?(l=tt,t+=2):(l=e,v===0&&d(Ks)),l===e&&(s.substr(t,2)===st?(l=st,t+=2):(l=e,v===0&&d(Xs)),l===e&&(s.substr(t,2)===at?(l=at,t+=2):(l=e,v===0&&d(Ys)),l===e&&(s.substr(t,2)===nt?(l=nt,t+=2):(l=e,v===0&&d(ea)),l===e&&(s.substr(t,2)===lt?(l=lt,t+=2):(l=e,v===0&&d(ra)),l===e&&(l=s.charAt(t),Ts.test(l)?t++:(l=e,v===0&&d(ta)))))))),l!==e&&(C=r,l=sn()),r=l,m[f]={nextPos:t,result:r},r)}function pl(){var r,l,f,a=t*77+29,u=m[a];return u?(t=u.nextPos,u.result):(r=t,s.charCodeAt(t)===33?(l=_s,t++):(l=e,v===0&&d(sa)),l!==e?(f=L(),f!==e?(C=r,r=an(f)):(t=r,r=e)):(t=r,r=e),m[a]={nextPos:t,result:r},r)}function vl(){var r,l,f,a,u=t*77+30,i=m[u];if(i)return t=i.nextPos,i.result;if(r=t,l=Vt(),l!==e){if(f=[],a=Qt(),a===e&&(a=Zt(),a===e&&(a=Gt())),a!==e)for(;a!==e;)f.push(a),a=Qt(),a===e&&(a=Zt(),a===e&&(a=Gt()));else f=e;f!==e?(C=r,r=nn(l,f)):(t=r,r=e)}else t=r,r=e;return m[u]={nextPos:t,result:r},r}function Qt(){var r,l,f,a,u,i,p=t*77+31,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.charCodeAt(t)===40?(l=I,t++):(l=e,v===0&&d(Ve)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();for(a=gl(),a===e&&(a=null),u=[],i=h();i!==e;)u.push(i),i=h();s.charCodeAt(t)===41?(i=N,t++):(i=e,v===0&&d(Se)),i!==e?(C=r,r=ln(a)):(t=r,r=e)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function gl(){var r,l,f,a,u,i,p=t*77+32,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,l=L(),l!==e){for(f=[],a=t,u=ze(),u!==e?(i=L(),i!==e?(C=a,a=Tt(l,i)):(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=ze(),u!==e?(i=L(),i!==e?(C=a,a=Tt(l,i)):(t=a,a=e)):(t=a,a=e);C=r,r=un(l,f)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function Zt(){var r,l,f,a,u,i,p=t*77+33,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.charCodeAt(t)===91?(l=Er,t++):(l=e,v===0&&d(jr)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=L(),a!==e){for(u=[],i=h();i!==e;)u.push(i),i=h();s.charCodeAt(t)===93?(i=sr,t++):(i=e,v===0&&d(cr)),i!==e?(C=r,r=fn(a)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function Gt(){var r,l,f,a=t*77+34,u=m[a];return u?(t=u.nextPos,u.result):(r=t,s.charCodeAt(t)===46?(l=Tr,t++):(l=e,v===0&&d(Or)),l!==e?(f=G(),f!==e?(C=r,r=on(f)):(t=r,r=e)):(t=r,r=e),m[a]={nextPos:t,result:r},r)}function dl(){var r,l,f,a,u,i,p,c,y,w,P=t*77+35,A=m[P];if(A)return t=A.nextPos,A.result;if(r=t,s.substr(t,2)===it?(l=it,t+=2):(l=e,v===0&&d(aa)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;if(f!==e)if(a=L(),a!==e){if(u=[],i=h(),i!==e)for(;i!==e;)u.push(i),i=h();else u=e;if(u!==e)if(i=fe(),i!==e){if(p=t,c=[],y=h(),y!==e)for(;y!==e;)c.push(y),y=h();else c=e;if(c!==e?(y=wl(),y!==e?p=y:(t=p,p=e)):(t=p,p=e),p===e&&(p=null),c=t,y=[],w=h(),w!==e)for(;w!==e;)y.push(w),w=h();else y=e;y!==e?(w=yl(),w!==e?c=w:(t=c,c=e)):(t=c,c=e),c===e&&(c=null),C=r,r=cn(a,i,p,c)}else t=r,r=e;else t=r,r=e}else t=r,r=e;else t=r,r=e}else t=r,r=e;return m[P]={nextPos:t,result:r},r}function wl(){var r,l,f,a,u,i,p=t*77+36,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,l=Dr(),l!==e){for(f=[],a=t,u=[],i=h();i!==e;)u.push(i),i=h();for(i=Dr(),i!==e?a=i:(t=a,a=e);a!==e;){for(f.push(a),a=t,u=[],i=h();i!==e;)u.push(i),i=h();i=Dr(),i!==e?a=i:(t=a,a=e)}C=r,r=hn(l,f)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function Dr(){var r,l,f,a,u,i,p,c=t*77+37,y=m[c];if(y)return t=y.nextPos,y.result;if(r=t,s.substr(t,4)===ut?(l=ut,t+=4):(l=e,v===0&&d(na)),l!==e)if(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e){for(a=[],u=h();u!==e;)a.push(u),u=h();if(u=L(),u!==e){for(i=[],p=h();p!==e;)i.push(p),p=h();p=fe(),p!==e?(C=r,r=pn(u,p)):(t=r,r=e)}else t=r,r=e}else t=r,r=e;else t=r,r=e;return m[c]={nextPos:t,result:r},r}function yl(){var r,l,f,a,u,i=t*77+38,p=m[i];if(p)return t=p.nextPos,p.result;if(r=t,s.substr(t,4)===ft?(l=ft,t+=4):(l=e,v===0&&d(la)),l!==e)if(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e){for(a=[],u=h();u!==e;)a.push(u),u=h();u=fe(),u!==e?(C=r,r=vn(u)):(t=r,r=e)}else t=r,r=e;else t=r,r=e;return m[i]={nextPos:t,result:r},r}function $l(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j,M,z,J,Ye=t*77+39,Ue=m[Ye];if(Ue)return t=Ue.nextPos,Ue.result;if(r=t,s.substr(t,5)===ot?(l=ot,t+=5):(l=e,v===0&&d(ia)),l!==e)if(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e){for(a=[],u=h();u!==e;)a.push(u),u=h();if(u=L(),u!==e){for(i=[],p=h();p!==e;)i.push(p),p=h();if(s.charCodeAt(t)===123?(p=W,t++):(p=e,v===0&&d(we)),p!==e){for(c=[],y=h();y!==e;)c.push(y),y=h();if(y=[],w=t,P=L(),P!==e){for(A=[],k=h();k!==e;)A.push(k),k=h();if(s.substr(t,2)===Me?(k=Me,t+=2):(k=e,v===0&&d(pr)),k!==e){for(j=[],M=h();M!==e;)j.push(M),M=h();if(M=fe(),M!==e){for(z=[],J=h();J!==e;)z.push(J),J=h();C=w,w=Nt(u,P,M)}else t=w,w=e}else t=w,w=e}else t=w,w=e;if(w!==e)for(;w!==e;)if(y.push(w),w=t,P=L(),P!==e){for(A=[],k=h();k!==e;)A.push(k),k=h();if(s.substr(t,2)===Me?(k=Me,t+=2):(k=e,v===0&&d(pr)),k!==e){for(j=[],M=h();M!==e;)j.push(M),M=h();if(M=fe(),M!==e){for(z=[],J=h();J!==e;)z.push(J),J=h();C=w,w=Nt(u,P,M)}else t=w,w=e}else t=w,w=e}else t=w,w=e;else y=e;if(y!==e){if(w=t,s.charCodeAt(t)===42?(P=ks,t++):(P=e,v===0&&d(ua)),P!==e){for(A=[],k=h();k!==e;)A.push(k),k=h();if(s.substr(t,2)===Me?(k=Me,t+=2):(k=e,v===0&&d(pr)),k!==e){for(j=[],M=h();M!==e;)j.push(M),M=h();if(M=fe(),M!==e){for(z=[],J=h();J!==e;)z.push(J),J=h();w=M}else t=w,w=e}else t=w,w=e}else t=w,w=e;for(w===e&&(w=null),P=[],A=h();A!==e;)P.push(A),A=h();s.charCodeAt(t)===125?(A=re,t++):(A=e,v===0&&d(ye)),A!==e?(C=r,r=gn(u,y,w)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e}else t=r,r=e;else t=r,r=e;return m[Ye]={nextPos:t,result:r},r}function ml(){var r,l,f,a,u,i,p,c,y=t*77+40,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,s.substr(t,4)===ct?(l=ct,t+=4):(l=e,v===0&&d(fa)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(s.charCodeAt(t)===123?(a=W,t++):(a=e,v===0&&d(we)),a!==e){for(u=[],i=h();i!==e;)u.push(i),i=h();if(i=Ke(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();s.charCodeAt(t)===125?(c=re,t++):(c=e,v===0&&d(ye)),c!==e?(C=r,r=dn(i)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e;return m[y]={nextPos:t,result:r},r}function bl(){var r,l,f,a,u=t*77+41,i=m[u];if(i)return t=i.nextPos,i.result;if(r=t,s.substr(t,6)===ht?(l=ht,t+=6):(l=e,v===0&&d(oa)),l!==e){if(f=[],a=h(),a!==e)for(;a!==e;)f.push(a),a=h();else f=e;f!==e?(a=Wt(),a!==e?(C=r,r=wn(a)):(t=r,r=e)):(t=r,r=e)}else t=r,r=e;return m[u]={nextPos:t,result:r},r}function Wt(){var r,l,f=t*77+42,a=m[f];return a?(t=a.nextPos,a.result):(r=t,l=Rl(),l!==e&&(C=r,l=yn(l)),r=l,m[f]={nextPos:t,result:r},r)}function Kt(){var r,l,f,a,u,i,p=t*77+43,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.charCodeAt(t)===96?(l=nr,t++):(l=e,v===0&&d(vr)),l!==e){for(f=[],a=t,u=t,v++,s.charCodeAt(t)===96?(i=nr,t++):(i=e,v===0&&d(vr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(i=Xt(),i!==e?a=i:(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=t,v++,s.charCodeAt(t)===96?(i=nr,t++):(i=e,v===0&&d(vr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(i=Xt(),i!==e?a=i:(t=a,a=e)):(t=a,a=e);s.charCodeAt(t)===96?(a=nr,t++):(a=e,v===0&&d(vr)),a!==e?(C=r,r=$n(f)):(t=r,r=e)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function Xt(){var r,l,f,a,u,i,p=t*77+44,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.charCodeAt(t)===123?(l=W,t++):(l=e,v===0&&d(we)),l!==e){for(f=[],a=H();a!==e;)f.push(a),a=H();if(a=L(),a!==e){for(u=[],i=H();i!==e;)u.push(i),i=H();s.charCodeAt(t)===125?(i=re,t++):(i=e,v===0&&d(ye)),i!==e?r=a:(t=r,r=e)}else t=r,r=e}else t=r,r=e;if(r===e){if(r=t,l=[],f=Yt(),f!==e)for(;f!==e;)l.push(f),f=Yt();else l=e;l!==e&&(C=r,l=mn(l)),r=l}return m[p]={nextPos:t,result:r},r}function Yt(){var r,l=t*77+45,f=m[l];return f?(t=f.nextPos,f.result):(r=xl(),r===e&&(r=s.charAt(t),Ns.test(r)?t++:(r=e,v===0&&d(ca))),m[l]={nextPos:t,result:r},r)}function xl(){var r,l,f,a=t*77+46,u=m[a];return u?(t=u.nextPos,u.result):(r=t,s.charCodeAt(t)===92?(l=et,t++):(l=e,v===0&&d(At)),l!==e?(f=s.charAt(t),js.test(f)?t++:(f=e,v===0&&d(ha)),f!==e?r=f:(t=r,r=e)):(t=r,r=e),m[a]={nextPos:t,result:r},r)}function Ur(){var r,l,f,a,u,i,p=t*77+47,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.charCodeAt(t)===34?(l=lr,t++):(l=e,v===0&&d(gr)),l!==e){for(f=[],a=t,u=t,v++,s.charCodeAt(t)===34?(i=lr,t++):(i=e,v===0&&d(gr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(i=es(),i===e&&(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de))),i!==e?(C=a,a=jt(i)):(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=t,v++,s.charCodeAt(t)===34?(i=lr,t++):(i=e,v===0&&d(gr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(i=es(),i===e&&(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de))),i!==e?(C=a,a=jt(i)):(t=a,a=e)):(t=a,a=e);s.charCodeAt(t)===34?(a=lr,t++):(a=e,v===0&&d(gr)),a!==e?(C=r,r=bn(f)):(t=r,r=e)}else t=r,r=e;if(r===e)if(r=t,s.charCodeAt(t)===39?(l=ir,t++):(l=e,v===0&&d(dr)),l!==e){for(f=[],a=t,u=t,v++,s.charCodeAt(t)===39?(i=ir,t++):(i=e,v===0&&d(dr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(i=rs(),i===e&&(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de))),i!==e?(C=a,a=Ot(i)):(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=t,v++,s.charCodeAt(t)===39?(i=ir,t++):(i=e,v===0&&d(dr)),v--,i===e?u=void 0:(t=u,u=e),u!==e?(i=rs(),i===e&&(s.length>t?(i=s.charAt(t),t++):(i=e,v===0&&d(de))),i!==e?(C=a,a=Ot(i)):(t=a,a=e)):(t=a,a=e);s.charCodeAt(t)===39?(a=ir,t++):(a=e,v===0&&d(dr)),a!==e?(C=r,r=xn(f)):(t=r,r=e)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function es(){var r,l,f=t*77+48,a=m[f];return a?(t=a.nextPos,a.result):(r=t,s.substr(t,2)===pt?(l=pt,t+=2):(l=e,v===0&&d(pa)),l!==e&&(C=r,l=An()),r=l,m[f]={nextPos:t,result:r},r)}function rs(){var r,l,f=t*77+49,a=m[f];return a?(t=a.nextPos,a.result):(r=t,s.substr(t,2)===vt?(l=vt,t+=2):(l=e,v===0&&d(va)),l!==e&&(C=r,l=Cn()),r=l,m[f]={nextPos:t,result:r},r)}function ts(){var r,l=t*77+50,f=m[l];return f?(t=f.nextPos,f.result):(r=Al(),r===e&&(r=Cl()),m[l]={nextPos:t,result:r},r)}function Al(){var r,l,f,a,u,i,p,c=t*77+51,y=m[c];if(y)return t=y.nextPos,y.result;if(r=t,l=s.charAt(t),fr.test(l)?t++:(l=e,v===0&&d(wr)),l===e&&(l=null),f=s.charAt(t),$t.test(f)?t++:(f=e,v===0&&d(Ct)),f!==e){if(a=[],u=s.charAt(t),ge.test(u)?t++:(u=e,v===0&&d($e)),u!==e)for(;u!==e;)a.push(u),u=s.charAt(t),ge.test(u)?t++:(u=e,v===0&&d($e));else a=e;if(a!==e)if(s.charCodeAt(t)===46?(u=Tr,t++):(u=e,v===0&&d(Or)),u!==e){if(i=[],p=s.charAt(t),ge.test(p)?t++:(p=e,v===0&&d($e)),p!==e)for(;p!==e;)i.push(p),p=s.charAt(t),ge.test(p)?t++:(p=e,v===0&&d($e));else i=e;i!==e?(C=r,r=Pn()):(t=r,r=e)}else t=r,r=e;else t=r,r=e}else t=r,r=e;if(r===e)if(r=t,l=s.charAt(t),fr.test(l)?t++:(l=e,v===0&&d(wr)),l===e&&(l=null),f=s.charAt(t),ge.test(f)?t++:(f=e,v===0&&d($e)),f!==e)if(s.charCodeAt(t)===46?(a=Tr,t++):(a=e,v===0&&d(Or)),a!==e){if(u=[],i=s.charAt(t),ge.test(i)?t++:(i=e,v===0&&d($e)),i!==e)for(;i!==e;)u.push(i),i=s.charAt(t),ge.test(i)?t++:(i=e,v===0&&d($e));else u=e;u!==e?(C=r,r=_n()):(t=r,r=e)}else t=r,r=e;else t=r,r=e;return m[c]={nextPos:t,result:r},r}function Cl(){var r,l,f,a,u,i=t*77+52,p=m[i];if(p)return t=p.nextPos,p.result;if(r=t,l=s.charAt(t),fr.test(l)?t++:(l=e,v===0&&d(wr)),l===e&&(l=null),f=s.charAt(t),$t.test(f)?t++:(f=e,v===0&&d(Ct)),f!==e){if(a=[],u=s.charAt(t),ge.test(u)?t++:(u=e,v===0&&d($e)),u!==e)for(;u!==e;)a.push(u),u=s.charAt(t),ge.test(u)?t++:(u=e,v===0&&d($e));else a=e;a!==e?(C=r,r=kn()):(t=r,r=e)}else t=r,r=e;return r===e&&(r=t,l=s.charAt(t),fr.test(l)?t++:(l=e,v===0&&d(wr)),l===e&&(l=null),f=s.charAt(t),ge.test(f)?t++:(f=e,v===0&&d($e)),f!==e?(C=r,r=Mn()):(t=r,r=e)),m[i]={nextPos:t,result:r},r}function ss(){var r,l=t*77+53,f=m[l];return f?(t=f.nextPos,f.result):(r=Pl(),r===e&&(r=_l()),m[l]={nextPos:t,result:r},r)}function Pl(){var r,l,f,a,u=t*77+54,i=m[u];return i?(t=i.nextPos,i.result):(r=t,s.substr(t,4)===gt?(l=gt,t+=4):(l=e,v===0&&d(ga)),l!==e?(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e?(C=r,r=Sn()):(t=r,r=e)):(t=r,r=e),m[u]={nextPos:t,result:r},r)}function _l(){var r,l,f,a,u=t*77+55,i=m[u];return i?(t=i.nextPos,i.result):(r=t,s.substr(t,5)===dt?(l=dt,t+=5):(l=e,v===0&&d(da)),l!==e?(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e?(C=r,r=En()):(t=r,r=e)):(t=r,r=e),m[u]={nextPos:t,result:r},r)}function as(){var r,l,f,a,u=t*77+56,i=m[u];return i?(t=i.nextPos,i.result):(r=t,s.substr(t,4)===wt?(l=wt,t+=4):(l=e,v===0&&d(wa)),l!==e?(f=t,v++,a=s.charAt(t),xe.test(a)?t++:(a=e,v===0&&d(Ce)),v--,a===e?f=void 0:(t=f,f=e),f!==e?(C=r,r=Tn()):(t=r,r=e)):(t=r,r=e),m[u]={nextPos:t,result:r},r)}function kl(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j,M=t*77+57,z=m[M];if(z)return t=z.nextPos,z.result;if(r=t,s.charCodeAt(t)===123?(l=W,t++):(l=e,v===0&&d(we)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=[],u=t,i=G(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();if(s.charCodeAt(t)===58?(c=ne,t++):(c=e,v===0&&d(he)),c!==e){if(y=[],w=h(),w!==e)for(;w!==e;)y.push(w),w=h();else y=e;if(y!==e)if(w=L(),w!==e){for(P=[],A=h();A!==e;)P.push(A),A=h();for(A=s.charAt(t),or.test(A)?t++:(A=e,v===0&&d(yr)),A===e&&(A=null),k=[],j=h();j!==e;)k.push(j),j=h();C=u,u=Rt(i,w)}else t=u,u=e;else t=u,u=e}else t=u,u=e}else t=u,u=e;for(;u!==e;)if(a.push(u),u=t,i=G(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();if(s.charCodeAt(t)===58?(c=ne,t++):(c=e,v===0&&d(he)),c!==e){if(y=[],w=h(),w!==e)for(;w!==e;)y.push(w),w=h();else y=e;if(y!==e)if(w=L(),w!==e){for(P=[],A=h();A!==e;)P.push(A),A=h();for(A=s.charAt(t),or.test(A)?t++:(A=e,v===0&&d(yr)),A===e&&(A=null),k=[],j=h();j!==e;)k.push(j),j=h();C=u,u=Rt(i,w)}else t=u,u=e;else t=u,u=e}else t=u,u=e}else t=u,u=e;s.charCodeAt(t)===125?(u=re,t++):(u=e,v===0&&d(ye)),u!==e?(C=r,r=Nn(a)):(t=r,r=e)}else t=r,r=e;return m[M]={nextPos:t,result:r},r}function Ml(){var r,l,f,a,u,i,p,c,y,w,P=t*77+58,A=m[P];if(A)return t=A.nextPos,A.result;if(r=t,s.charCodeAt(t)===91?(l=Er,t++):(l=e,v===0&&d(jr)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=[],u=t,i=L(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(s.charCodeAt(t)===44?(c=be,t++):(c=e,v===0&&d(Ae)),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();C=u,u=It(i)}else t=u,u=e;for(;u!==e;)if(a.push(u),u=t,i=L(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(s.charCodeAt(t)===44?(c=be,t++):(c=e,v===0&&d(Ae)),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();C=u,u=It(i)}else t=u,u=e;for(u=[],i=h();i!==e;)u.push(i),i=h();s.charCodeAt(t)===93?(i=sr,t++):(i=e,v===0&&d(cr)),i!==e?(C=r,r=jn(a)):(t=r,r=e)}else t=r,r=e;return m[P]={nextPos:t,result:r},r}function Fr(){var r,l,f,a,u,i,p,c=t*77+59,y=m[c];if(y)return t=y.nextPos,y.result;if(r=t,l=G(),l!==e){for(f=t,a=[],u=h();u!==e;)a.push(u),u=h();if(s.charCodeAt(t)===58?(u=ne,t++):(u=e,v===0&&d(he)),u!==e){for(i=[],p=h();p!==e;)i.push(p),p=h();p=me(),p!==e?f=p:(t=f,f=e)}else t=f,f=e;f===e&&(f=null),C=r,r=On(l,f)}else t=r,r=e;return m[c]={nextPos:t,result:r},r}function ns(){var r,l,f,a,u,i,p=t*77+60,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,l=Fr(),l!==e){for(f=[],a=t,u=ze(),u!==e?(i=Fr(),i!==e?a=i:(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=ze(),u!==e?(i=Fr(),i!==e?a=i:(t=a,a=e)):(t=a,a=e);C=r,r=Rn(l,f)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function ls(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j,M,z,J,Ye=t*77+61,Ue=m[Ye];if(Ue)return t=Ue.nextPos,Ue.result;if(r=t,s.charCodeAt(t)===64?(l=Ms,t++):(l=e,v===0&&d(ya)),l!==e){for(f=[],a=H();a!==e;)f.push(a),a=H();if(a=G(),a!==e){for(u=[],i=H();i!==e;)u.push(i),i=H();if(s.charCodeAt(t)===40?(i=I,t++):(i=e,v===0&&d(Ve)),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(c=ns(),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();if(s.charCodeAt(t)===41?(w=N,t++):(w=e,v===0&&d(Se)),w!==e){for(P=t,A=[],k=h();k!==e;)A.push(k),k=h();if(s.charCodeAt(t)===58?(k=ne,t++):(k=e,v===0&&d(he)),k!==e){for(j=[],M=h();M!==e;)j.push(M),M=h();M=me(),M!==e?P=M:(t=P,P=e)}else t=P,P=e;for(P===e&&(P=null),A=[],k=h();k!==e;)A.push(k),k=h();if(s.charCodeAt(t)===123?(k=W,t++):(k=e,v===0&&d(we)),k!==e){for(j=[],M=h();M!==e;)j.push(M),M=h();for(M=Ke(),M===e&&(M=null),z=[],J=h();J!==e;)z.push(J),J=h();s.charCodeAt(t)===125?(J=re,t++):(J=e,v===0&&d(ye)),J!==e?(C=r,r=In(f,a,u,c,P,M)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e}else t=r,r=e}else t=r,r=e;return m[Ye]={nextPos:t,result:r},r}function Sl(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j=t*77+62,M=m[j];if(M)return t=M.nextPos,M.result;if(r=t,s.substr(t,2)===ur?(l=ur,t+=2):(l=e,v===0&&d(Pt)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();for(a=ns(),a===e&&(a=null),u=[],i=h();i!==e;)u.push(i),i=h();if(s.charCodeAt(t)===41?(i=N,t++):(i=e,v===0&&d(Se)),i!==e){for(p=t,c=[],y=h();y!==e;)c.push(y),y=h();if(s.charCodeAt(t)===58?(y=ne,t++):(y=e,v===0&&d(he)),y!==e){for(w=[],P=h();P!==e;)w.push(P),P=h();P=me(),P!==e?p=P:(t=p,p=e)}else t=p,p=e;for(p===e&&(p=null),c=[],y=h();y!==e;)c.push(y),y=h();if(s.charCodeAt(t)===123?(y=W,t++):(y=e,v===0&&d(we)),y!==e){for(w=[],P=h();P!==e;)w.push(P),P=h();for(P=Ke(),P===e&&(P=null),A=[],k=h();k!==e;)A.push(k),k=h();s.charCodeAt(t)===125?(k=re,t++):(k=e,v===0&&d(ye)),k!==e?(C=r,r=Dn(a,p,P)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e;return m[j]={nextPos:t,result:r},r}function El(){var r,l,f,a,u,i,p,c,y,w,P=t*77+63,A=m[P];if(A)return t=A.nextPos,A.result;if(r=t,s.charCodeAt(t)===91?(l=Er,t++):(l=e,v===0&&d(jr)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=[],u=t,i=De(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(s.charCodeAt(t)===44?(c=be,t++):(c=e,v===0&&d(Ae)),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();C=u,u=Dt(i)}else t=u,u=e;for(;u!==e;)if(a.push(u),u=t,i=De(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();for(s.charCodeAt(t)===44?(c=be,t++):(c=e,v===0&&d(Ae)),c===e&&(c=null),y=[],w=h();w!==e;)y.push(w),w=h();C=u,u=Dt(i)}else t=u,u=e;for(u=[],i=h();i!==e;)u.push(i),i=h();s.charCodeAt(t)===93?(i=sr,t++):(i=e,v===0&&d(cr)),i!==e?(C=r,r=Un(a)):(t=r,r=e)}else t=r,r=e;return m[P]={nextPos:t,result:r},r}function Tl(){var r,l,f,a,u,i,p,c,y,w,P,A,k,j,M=t*77+64,z=m[M];if(z)return t=z.nextPos,z.result;if(r=t,s.charCodeAt(t)===123?(l=W,t++):(l=e,v===0&&d(we)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();if(a=[],u=t,i=G(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();if(s.charCodeAt(t)===58?(c=ne,t++):(c=e,v===0&&d(he)),c!==e){if(y=[],w=h(),w!==e)for(;w!==e;)y.push(w),w=h();else y=e;if(y!==e)if(w=De(),w!==e){for(P=[],A=h();A!==e;)P.push(A),A=h();for(A=s.charAt(t),or.test(A)?t++:(A=e,v===0&&d(yr)),A===e&&(A=null),k=[],j=h();j!==e;)k.push(j),j=h();C=u,u=Ut(i,w)}else t=u,u=e;else t=u,u=e}else t=u,u=e}else t=u,u=e;for(;u!==e;)if(a.push(u),u=t,i=G(),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();if(s.charCodeAt(t)===58?(c=ne,t++):(c=e,v===0&&d(he)),c!==e){if(y=[],w=h(),w!==e)for(;w!==e;)y.push(w),w=h();else y=e;if(y!==e)if(w=De(),w!==e){for(P=[],A=h();A!==e;)P.push(A),A=h();for(A=s.charAt(t),or.test(A)?t++:(A=e,v===0&&d(yr)),A===e&&(A=null),k=[],j=h();j!==e;)k.push(j),j=h();C=u,u=Ut(i,w)}else t=u,u=e;else t=u,u=e}else t=u,u=e}else t=u,u=e;s.charCodeAt(t)===125?(u=re,t++):(u=e,v===0&&d(ye)),u!==e?(C=r,r=Fn(a)):(t=r,r=e)}else t=r,r=e;return m[M]={nextPos:t,result:r},r}function me(){var r,l=t*77+65,f=m[l];return f?(t=f.nextPos,f.result):(r=Nl(),r===e&&(r=Ol()),m[l]={nextPos:t,result:r},r)}function Nl(){var r,l,f,a,u,i,p,c,y,w,P=t*77+66,A=m[P];if(A)return t=A.nextPos,A.result;if(r=t,s.substr(t,2)===ur?(l=ur,t+=2):(l=e,v===0&&d(Pt)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();for(a=jl(),a===e&&(a=null),u=[],i=h();i!==e;)u.push(i),i=h();if(s.charCodeAt(t)===41?(i=N,t++):(i=e,v===0&&d(Se)),i!==e){for(p=[],c=h();c!==e;)p.push(c),c=h();if(s.substr(t,2)===Me?(c=Me,t+=2):(c=e,v===0&&d(pr)),c!==e){for(y=[],w=h();w!==e;)y.push(w),w=h();w=me(),w!==e?(C=r,r=Ln(a,w)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e;return m[P]={nextPos:t,result:r},r}function jl(){var r,l,f,a,u,i,p=t*77+67,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,l=me(),l!==e){for(f=[],a=t,u=ze(),u!==e?(i=me(),i!==e?a=i:(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,u=ze(),u!==e?(i=me(),i!==e?a=i:(t=a,a=e)):(t=a,a=e);C=r,r=Hn(l,f)}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function Ol(){var r,l,f,a,u,i,p,c,y=t*77+68,w=m[y];if(w)return t=w.nextPos,w.result;if(r=t,l=G(),l!==e){for(f=[],a=H();a!==e;)f.push(a),a=H();if(s.charCodeAt(t)===60?(a=Ss,t++):(a=e,v===0&&d($a)),a!==e){for(u=[],i=H();i!==e;)u.push(i),i=H();if(i=me(),i!==e){for(p=[],c=H();c!==e;)p.push(c),c=H();s.charCodeAt(t)===62?(c=Es,t++):(c=e,v===0&&d(ma)),c!==e?(C=r,r=qn(l,i)):(t=r,r=e)}else t=r,r=e}else t=r,r=e}else t=r,r=e;return r===e&&(r=t,l=G(),l!==e&&(C=r,l=Vn(l)),r=l),m[y]={nextPos:t,result:r},r}function G(){var r,l,f,a,u=t*77+69,i=m[u];if(i)return t=i.nextPos,i.result;if(r=t,l=s.charAt(t),Os.test(l)?t++:(l=e,v===0&&d(ba)),l!==e){for(f=[],a=s.charAt(t),mt.test(a)?t++:(a=e,v===0&&d(_t));a!==e;)f.push(a),a=s.charAt(t),mt.test(a)?t++:(a=e,v===0&&d(_t));C=r,r=Bn()}else t=r,r=e;return m[u]={nextPos:t,result:r},r}function Rl(){var r,l,f,a,u,i,p=t*77+70,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,l=G(),l!==e){for(f=[],a=t,s.charCodeAt(t)===58?(u=ne,t++):(u=e,v===0&&d(he)),u!==e?(i=G(),i!==e?(u=[u,i],a=u):(t=a,a=e)):(t=a,a=e);a!==e;)f.push(a),a=t,s.charCodeAt(t)===58?(u=ne,t++):(u=e,v===0&&d(he)),u!==e?(i=G(),i!==e?(u=[u,i],a=u):(t=a,a=e)):(t=a,a=e);C=r,r=zn()}else t=r,r=e;return m[p]={nextPos:t,result:r},r}function ze(){var r,l,f,a,u,i=t*77+71,p=m[i];if(p)return t=p.nextPos,p.result;for(r=t,l=[],f=h();f!==e;)l.push(f),f=h();if(s.charCodeAt(t)===44?(f=be,t++):(f=e,v===0&&d(Ae)),f!==e){for(a=[],u=h();u!==e;)a.push(u),u=h();l=[l,f,a],r=l}else t=r,r=e;if(r===e)if(r=[],l=h(),l!==e)for(;l!==e;)r.push(l),l=h();else r=e;return m[i]={nextPos:t,result:r},r}function fe(){var r,l,f,a,u,i,p=t*77+72,c=m[p];if(c)return t=c.nextPos,c.result;if(r=t,s.charCodeAt(t)===123?(l=W,t++):(l=e,v===0&&d(we)),l!==e){for(f=[],a=h();a!==e;)f.push(a),a=h();for(a=Ke(),a===e&&(a=null),u=[],i=h();i!==e;)u.push(i),i=h();s.charCodeAt(t)===125?(i=re,t++):(i=e,v===0&&d(ye)),i!==e?(C=r,r=Jn(a)):(t=r,r=e)}else t=r,r=e;return r===e&&(r=Xe()),m[p]={nextPos:t,result:r},r}function Te(){var r,l=t*77+73,f=m[l];return f?(t=f.nextPos,f.result):(s.substr(t,2)===yt?(r=yt,t+=2):(r=e,v===0&&d(xa)),r===e&&(r=s.charAt(t),Rs.test(r)?t++:(r=e,v===0&&d(Aa))),m[l]={nextPos:t,result:r},r)}function is(){var r,l,f=t*77+74,a=m[f];return a?(t=a.nextPos,a.result):(r=t,v++,s.length>t?(l=s.charAt(t),t++):(l=e,v===0&&d(de)),v--,l===e?r=void 0:(t=r,r=e),r===e&&(r=Te()),m[f]={nextPos:t,result:r},r)}function h(){var r,l=t*77+75,f=m[l];return f?(t=f.nextPos,f.result):(r=s.charAt(t),Is.test(r)?t++:(r=e,v===0&&d(Ca)),m[l]={nextPos:t,result:r},r)}function H(){var r,l=t*77+76,f=m[l];return f?(t=f.nextPos,f.result):(r=s.charAt(t),Ds.test(r)?t++:(r=e,v===0&&d(Pa)),m[l]={nextPos:t,result:r},r)}function T(r,l,f){const a={type:r};l.children=f;for(const i of Object.keys(l))l[i]!==void 0&&(a[i]=l[i]);const u=Ft();return a.loc={start:u.start.offset,end:u.end.offset-1},a}if(We=$(),n.peg$library)return{peg$result:We,peg$currPos:t,peg$FAILED:e,peg$maxFailExpected:$r,peg$maxFailPos:pe};if(We!==e&&t===s.length)return We;throw We!==e&&t<s.length&&d(Gn()),Kn($r,pe<s.length?s.charAt(pe):null,pe<s.length?mr(pe,pe+1):mr(pe,pe))}const si=["def","return","attr","each","for","loop","break","continue","assign","addAssign","subAssign"];function ai(s){return si.includes(s.type)}const ni=["infix","if","fn","match","block","exists","tmpl","str","num","bool","null","obj","arr","identifier","call","index","prop"];function bs(s){return ni.includes(s.type)}function Br(s){return"chain"in s&&s.chain!==null}function xs(s,n,e){return{type:"call",target:s,args:n,loc:e}}function As(s,n,e){return{type:"index",target:s,index:n,loc:e}}function Cs(s,n,e){return{type:"prop",target:s,name:n,loc:e}}const ji=Object.freeze(Object.defineProperty({__proto__:null,CALL:xs,INDEX:As,PROP:Cs,hasChainProp:Br,isExpression:bs,isStatement:ai},Symbol.toStringTag,{value:"Module"}));function O(s,n){const e=n(s);switch(e.type){case"def":{e.expr=O(e.expr,n);break}case"return":{e.expr=O(e.expr,n);break}case"each":{e.items=O(e.items,n),e.for=O(e.for,n);break}case"for":{e.from!=null&&(e.from=O(e.from,n)),e.to!=null&&(e.to=O(e.to,n)),e.times!=null&&(e.times=O(e.times,n)),e.for=O(e.for,n);break}case"loop":{for(let o=0;o<e.statements.length;o++)e.statements[o]=O(e.statements[o],n);break}case"addAssign":case"subAssign":case"assign":{e.expr=O(e.expr,n),e.dest=O(e.dest,n);break}case"infix":{for(let o=0;o<e.operands.length;o++)e.operands[o]=O(e.operands[o],n);break}case"not":{e.expr=O(e.expr,n);break}case"if":{e.cond=O(e.cond,n),e.then=O(e.then,n);for(const o of e.elseif)o.cond=O(o.cond,n),o.then=O(o.then,n);e.else!=null&&(e.else=O(e.else,n));break}case"fn":{for(let o=0;o<e.children.length;o++)e.children[o]=O(e.children[o],n);break}case"match":{e.about=O(e.about,n);for(const o of e.qs)o.q=O(o.q,n),o.a=O(o.a,n);e.default!=null&&(e.default=O(e.default,n));break}case"block":{for(let o=0;o<e.statements.length;o++)e.statements[o]=O(e.statements[o],n);break}case"exists":{e.identifier=O(e.identifier,n);break}case"tmpl":{for(let o=0;o<e.tmpl.length;o++){const g=e.tmpl[o];typeof g!="string"&&(e.tmpl[o]=O(g,n))}break}case"obj":{for(const o of e.value)e.value.set(o[0],O(o[1],n));break}case"arr":{for(let o=0;o<e.value.length;o++)e.value[o]=O(e.value[o],n);break}case"callChain":{for(let o=0;o<e.args.length;o++)e.args[o]=O(e.args[o],n);break}case"indexChain":{e.index=O(e.index,n);break}case"call":{e.target=O(e.target,n);for(let o=0;o<e.args.length;o++)e.args[o]=O(e.args[o],n);break}case"index":{e.target=O(e.target,n),e.index=O(e.index,n);break}case"prop":{e.target=O(e.target,n);break}case"ns":{for(let o=0;o<e.members.length;o++)e.members[o]=O(e.members[o],n);break}case"or":case"and":{e.left=O(e.left,n),e.right=O(e.right,n);break}}if(Br(e)&&e.chain!=null)for(let o=0;o<e.chain.length;o++)e.chain[o]=O(e.chain[o],n);return e}const Hr=["null","true","false","each","for","loop","break","continue","match","if","elif","else","return","eval","var","let","exists","fn","namespace","meta","attr","attribute","static","class","struct","module","while","import","export"];function qr(s){throw new je(`Reserved word "${s}" cannot be used as variable name.`)}function li(s){switch(s.type){case"def":case"attr":case"ns":case"identifier":case"propChain":{Hr.includes(s.name)&&qr(s.name);break}case"meta":{s.name!=null&&Hr.includes(s.name)&&qr(s.name);break}case"fn":{for(const n of s.args)Hr.includes(n.name)&&qr(n.name);break}}return s}function ii(s){for(const n of s)O(n,li);return s}function cs(s){return{type:"simple",name:s}}function ui(s,n){return{type:"generic",name:s,inners:n}}function fi(s,n){return{type:"fn",args:s,result:n}}function Cr(s){switch(s.type){case"namedTypeSource":if(s.inner){const n=Cr(s.inner);return`${s.name}<${n}>`}else return s.name;case"fnTypeSource":{const n=s.args.map(o=>Cr(o)).join(", "),e=Cr(s.result);return`@(${n}) { ${e} }`}}}function Qe(s){if(s.type==="namedTypeSource"){switch(s.name){case"null":case"bool":case"num":case"str":case"any":case"void":{if(s.inner==null)return cs(s.name);break}case"arr":case"obj":{let n;return s.inner!=null?n=Qe(s.inner):n=cs("any"),ui(s.name,[n])}}throw new je(`Unknown type: '${Cr(s)}'`)}else{const n=s.args.map(e=>Qe(e));return fi(n,Qe(s.result))}}function oi(s){switch(s.type){case"def":{s.varType!=null&&Qe(s.varType);break}case"fn":{for(const n of s.args)n.argType!=null&&Qe(n.argType);s.retType!=null&&Qe(s.retType);break}}return s}function ci(s){for(const n of s)O(n,oi);return s}function Pr(s){const n=[],e=[];for(const o of s)if(o.type==="attr")e.push(o);else if(o.type==="def")o.attr==null&&(o.attr=[]),o.attr.push(...e),e.splice(0,e.length),o.expr.type==="fn"&&(o.expr.children=Pr(o.expr.children)),n.push(o);else{if(e.length>0)throw new je("invalid attribute.");switch(o.type){case"fn":{o.children=Pr(o.children);break}case"block":{o.statements=Pr(o.statements);break}}n.push(o)}if(e.length>0)throw new je("invalid attribute.");return n}function hi(s){if(bs(s)&&Br(s)&&s.chain!=null){const{chain:n,...e}=s;let o=e;for(const g of n)switch(g.type){case"callChain":{o=xs(o,g.args,g.loc);break}case"indexChain":{o=As(o,g.index,g.loc);break}case"propChain":{o=Cs(o,g.name,g.loc);break}}return o}return s}function pi(s){for(let n=0;n<s.length;n++)s[n]=O(s[n],hi);return s}function _r(s,n,e){return{type:"infixTree",left:s,right:n,info:e}}function Ps(s,n,e){if(s.type!=="infixTree"||e.priority<=s.info.priority)return _r(s,n,e);{const{left:o,right:g,info:$}=s;return _r(o,Ps(g,n,e),$)}}function Fe(s){if(s.type!=="infixTree")return s;if(s.info.mapFn)return s.info.mapFn(s);{const n=Fe(s.left),e=Fe(s.right);return{type:"call",target:{type:"identifier",name:s.info.func,loc:s.info.opLoc},args:[n,e],loc:{start:n.loc.start,end:e.loc.end}}}}const vi={"*":{func:"Core:mul",priority:7},"^":{func:"Core:pow",priority:7},"/":{func:"Core:div",priority:7},"%":{func:"Core:mod",priority:7},"+":{func:"Core:add",priority:6},"-":{func:"Core:sub",priority:6},"==":{func:"Core:eq",priority:4},"!=":{func:"Core:neq",priority:4},"<":{func:"Core:lt",priority:4},">":{func:"Core:gt",priority:4},"<=":{func:"Core:lteq",priority:4},">=":{func:"Core:gteq",priority:4},"&&":{mapFn:s=>{const n=Fe(s.left),e=Fe(s.right);return{type:"and",left:n,right:e,loc:{start:n.loc.start,end:e.loc.end},operatorLoc:s.info.opLoc}},priority:3},"||":{mapFn:s=>{const n=Fe(s.left),e=Fe(s.right);return{type:"or",left:n,right:e,loc:{start:n.loc.start,end:e.loc.end},operatorLoc:s.info.opLoc}},priority:3}};function gi(s){const n=s.operators.map((o,g)=>{const $=vi[o];if($==null)throw new je(`No such operator: ${o}.`);return{...$,opLoc:s.operatorLocs[g]}});let e=_r(s.operands[0],s.operands[1],n[0]);for(let o=0;o<n.length-1;o++)e=Ps(e,s.operands[2+o],n[1+o]);return Fe(e)}function di(s){for(let n=0;n<s.length;n++)s[n]=O(s[n],e=>e.type==="infix"?gi(e):e);return s}class er{static instance;plugins;constructor(){this.plugins={validate:[ii,ci],transform:[Pr,pi,di]}}static parse(n){return er.instance==null&&(er.instance=new er),er.instance.parse(n)}addPlugin(n,e){switch(n){case"validate":this.plugins.validate.push(e);break;case"transform":this.plugins.transform.push(e);break;default:throw new Error("unknown plugin type")}}parse(n){let e;try{const o=os(n,{startRule:"Preprocess"});e=os(o,{startRule:"Main"})}catch(o){throw o.location?o.expected?new je(`Parsing error. (Line ${o.location.start.line}:${o.location.start.column})`,o):new je(`${o.message} (Line ${o.location.start.line}:${o.location.start.column})`,o):o}for(const o of this.plugins.validate)e=o(e);for(const o of this.plugins.transform)e=o(e);return e}}const wi=["def","return","each","for","loop","break","continue","assign","addAssign","subAssign"];function yi(s){return wi.includes(s.type)}const $i=["if","fn","match","block","exists","tmpl","str","num","bool","null","obj","arr","identifier","call","index","prop"];function mi(s){return $i.includes(s.type)}const Oi=Object.freeze(Object.defineProperty({__proto__:null,isExpression:mi,isStatement:yi},Symbol.toStringTag,{value:"Module"}));export{Gl as AISCRIPT_VERSION,Oi as Ast,ji as Cst,ae as Interpreter,er as Parser,ie as Scope,Ei as errors,Ni as utils,Ti as values};
