import{s as et}from"./3iSoGi4ic-C0O4p9AH.js";function m(e,t,r){let a=r.value;return{configurable:!0,get(){const n=a.bind(this);return Object.defineProperty(this,t,{configurable:!0,writable:!0,value:n}),n},set(n){a=n}}}class W extends Error{name="AiScript";info;pos;constructor(t,r){super(t),this.info=r,Error.captureStackTrace&&Error.captureStackTrace(this,W)}}class Se extends W{name="Internal";constructor(t){const r=String(t?.message??t);super(r,t)}}class U extends W{pos;name="Syntax";constructor(t,r,a){super(`${t} (Line ${r.line}, Column ${r.column})`,a),this.pos=r}}class te extends U{constructor(t,r){super("unexpected EOF",t,r)}}class dt extends W{pos;name="Type";constructor(t,r,a){super(`${t} (Line ${r.line}, Column ${r.column})`,a),this.pos=r}}class ne extends W{pos;name="Namespace";constructor(t,r,a){super(`${t} (Line ${r.line}, Column ${r.column})`,a),this.pos=r}}class v extends W{name="Runtime";constructor(t,r){super(t,r)}}class ve extends v{constructor(t,r){super(t,r)}}class tt extends v{name="";constructor(t,r){super(t,r)}}class we extends W{name="Host";constructor(t,r){super(t,r)}}const Lr=Object.freeze(Object.defineProperty({__proto__:null,AiScriptError:W,AiScriptHostsideError:we,AiScriptIndexOutOfRangeError:ve,AiScriptNamespaceError:ne,AiScriptRuntimeError:v,AiScriptSyntaxError:U,AiScriptTypeError:dt,AiScriptUnexpectedEOFError:te,AiScriptUserError:tt,NonAiScriptError:Se},Symbol.toStringTag,{value:"Module"})),mt=["def","return","each","for","loop","break","continue","assign","addAssign","subAssign"];function Oe(e){return mt.includes(e.type)}const bt=["if","fn","match","block","exists","tmpl","str","num","bool","null","obj","arr","not","pow","mul","div","rem","add","sub","lt","lteq","gt","gteq","eq","neq","and","or","identifier","call","index","prop"];function xt(e){return bt.includes(e.type)}const Ir=Object.freeze(Object.defineProperty({__proto__:null,isExpression:xt,isStatement:Oe},Symbol.toStringTag,{value:"Module"}));function Ae(e){switch(e.type){case"arr":return e.value.map(t=>Ae(t));case"bool":return e.value;case"null":return null;case"num":return e.value;case"obj":{const t={};for(const[r,a]of e.value.entries())t[r]=Ae(a);return t}case"str":return e.value;default:return}}var J=(function(e,t,r,a){var n=arguments.length,i=n<3?t:a===null?a=Object.getOwnPropertyDescriptor(t,r):a,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i});class q{parent;layerdStates;name;opts={};nsName;constructor(t=[],r,a,n){this.layerdStates=t,this.parent=r,this.name=a||(t.length===1?"<root>":"<anonymous>"),this.nsName=n}log(t,r){this.parent?this.parent.log(t,r):this.opts.log&&this.opts.log(t,r)}onUpdated(t,r){this.parent?this.parent.onUpdated(t,r):this.opts.onUpdated&&this.opts.onUpdated(t,r)}createChildScope(t=new Map,r){const a=[t,...this.layerdStates];return new q(a,this,r)}createChildNamespaceScope(t,r=new Map,a){const n=[r,...this.layerdStates];return new q(n,this,a,t)}get(t){for(const r of this.layerdStates)if(r.has(t)){const a=r.get(t).value;return this.log("read",{var:t,val:a}),a}throw new v(`No such variable '${t}' in scope '${this.name}'`,{scope:this.layerdStates})}getNsPrefix(){return this.parent==null||this.nsName==null?"":this.parent.getNsPrefix()+this.nsName+":"}exists(t){for(const r of this.layerdStates)if(r.has(t))return this.log("exists",{var:t}),!0;return this.log("not exists",{var:t}),!1}getAll(){const t=this.layerdStates.reduce((r,a)=>[...r,...a],[]);return new Map(t)}add(t,r){this.log("add",{var:t,val:r});const a=this.layerdStates[0];if(a.has(t))throw new v(`Variable '${t}' already exists in scope '${this.name}'`,{scope:this.layerdStates});a.set(t,r),this.parent==null?this.onUpdated(t,r.value):this.nsName!=null&&this.parent.add(this.nsName+":"+t,r)}assign(t,r){let a=1;for(const n of this.layerdStates){if(n.has(t)){const i=n.get(t);if(!i.isMutable)throw new v(`Cannot assign to an immutable variable ${t}.`);i.value=r,this.log("assign",{var:t,val:r}),a===this.layerdStates.length&&this.onUpdated(t,r);return}a++}throw new v(`No such variable '${t}' in scope '${this.name}'`,{scope:this.layerdStates})}}J([m],q.prototype,"log",null);J([m],q.prototype,"onUpdated",null);J([m],q.prototype,"createChildScope",null);J([m],q.prototype,"createChildNamespaceScope",null);J([m],q.prototype,"get",null);J([m],q.prototype,"getNsPrefix",null);J([m],q.prototype,"exists",null);J([m],q.prototype,"getAll",null);J([m],q.prototype,"add",null);J([m],q.prototype,"assign",null);const I=[];for(let e=0;e<256;++e)I.push((e+256).toString(16).slice(1));function _t(e,t=0){return(I[e[t+0]]+I[e[t+1]]+I[e[t+2]]+I[e[t+3]]+"-"+I[e[t+4]]+I[e[t+5]]+"-"+I[e[t+6]]+I[e[t+7]]+"-"+I[e[t+8]]+I[e[t+9]]+"-"+I[e[t+10]]+I[e[t+11]]+I[e[t+12]]+I[e[t+13]]+I[e[t+14]]+I[e[t+15]]).toLowerCase()}let Ce;const Pt=new Uint8Array(16);function Ct(){if(!Ce){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ce=crypto.getRandomValues.bind(crypto)}return Ce(Pt)}const Bt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),$e={randomUUID:Bt};function Et(e,t,r){if($e.randomUUID&&!e)return $e.randomUUID();e=e||{};const a=e.random??e.rng?.()??Ct();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,_t(a)}const g={type:"null"},A={type:"bool",value:!0},N={type:"bool",value:!1},f=e=>({type:"num",value:e}),b=e=>({type:"str",value:e}),T=e=>({type:"bool",value:e}),Q=e=>({type:"obj",value:e}),C=e=>({type:"arr",value:e}),Ne=(e,t,r)=>({type:"fn",params:e,statements:t,scope:r}),l=(e,t)=>({type:"fn",native:e,nativeSync:t}),ce=(e,t)=>({type:"error",value:e,info:t}),Hr=Object.freeze(Object.defineProperty({__proto__:null,ARR:C,BOOL:T,ERROR:ce,FALSE:N,FN:Ne,FN_NATIVE:l,NULL:g,NUM:f,OBJ:Q,STR:b,TRUE:A},Symbol.toStringTag,{value:"Module"}));function L(e){if(e==null)throw new v("Expect anything, but got nothing.")}function rt(e){return e.type==="bool"}function oe(e){return e.type==="fn"}function nt(e){return e.type==="str"}function at(e){return e.type==="num"}function X(e){return e.type==="obj"}function k(e){return e.type==="arr"}function it(e){return e.type==="null"}function E(e){if(e==null)throw new v("Expect boolean, but got nothing.");if(!rt(e))throw new v(`Expect boolean, but got ${e.type}.`)}function S(e){if(e==null)throw new v("Expect function, but got nothing.");if(!oe(e))throw new v(`Expect function, but got ${e.type}.`)}function P(e){if(e==null)throw new v("Expect string, but got nothing.");if(!nt(e))throw new v(`Expect string, but got ${e.type}.`)}function c(e){if(e==null)throw new v("Expect number, but got nothing.");if(!at(e))throw new v(`Expect number, but got ${e.type}.`)}function H(e){if(e==null)throw new v("Expect object, but got nothing.");if(!X(e))throw new v(`Expect object, but got ${e.type}.`)}function D(e){if(e==null)throw new v("Expect array, but got nothing.");if(!k(e))throw new v(`Expect array, but got ${e.type}.`)}function Mt(e){if(e==null)throw new v("Expect null, but got nothing.");if(!it(e))throw new v(`Expect null, but got ${e.type}.`)}function ee(e,t){return e.type==="fn"&&t.type==="fn"?e.native&&t.native?e.native===t.native:e===t:e.type==="fn"||t.type==="fn"?!1:e.type==="null"&&t.type==="null"?!0:e.type==="null"||t.type==="null"?!1:e.value===t.value}function st(e,t=!1){if(t){if(e.type==="num")return e.value.toString();if(e.type==="bool")return e.value?"true":"false";if(e.type==="str")return`"${e.value}"`;if(e.type==="arr")return`[${e.value.map(a=>st(a,!0)).join(", ")}]`;if(e.type==="null")return"(null)"}const r=e.type==="num"||e.type==="bool"?e.value:e.type==="str"?`"${e.value}"`:e.type==="fn"||e.type==="obj"?"...":e.type==="null"?"":null;return`${e.type}<${r}>`}function de(e){switch(e.type){case"fn":return"<function>";case"arr":return e.value.map(t=>de(t));case"bool":return e.value;case"null":return null;case"num":return e.value;case"obj":{const t={};for(const[r,a]of e.value.entries())t[r]=de(a);return t}case"str":return e.value;default:throw new Error(`Unrecognized value type: ${e.type}`)}}function me(e){if(e===null)return g;if(typeof e=="boolean")return T(e);if(typeof e=="string")return b(e);if(typeof e=="number")return f(e);if(Array.isArray(e))return C(e.map(t=>me(t)));if(typeof e=="object"){const t=new Map;for(const[r,a]of Object.entries(e))t.set(r,me(a));return Q(t)}return g}function St(e){const t=/^\s*\/\/\/\s*@\s*([A-Z0-9_.-]+)(?:[\r\n][\s\S]*)?$/i.exec(e);return t!=null?t[1]:null}function G(e,t=!1,r=new Set){if((e.type==="arr"||e.type==="obj")&&r.has(e.value))return"...";if(t&&e.type==="str")return'"'+e.value.replace(/["\\\r\n]/g,a=>`\\${a}`)+'"';if(e.type==="str")return e.value;if(e.type==="num")return e.value.toString();if(e.type==="arr"){r.add(e.value);const a=[];for(const n of e.value)a.push(G(n,!0,r));return"[ "+a.join(", ")+" ]"}if(e.type==="obj"){r.add(e.value);const a=[];for(const[n,i]of e.value)a.push(`${n}: ${G(i,!0,r)}`);return"{ "+a.join(", ")+" }"}return e.type==="bool"?e.value.toString():e.type==="null"?"null":e.type==="fn"?e.native?"@( ?? ) { native code }":`@( ${e.params.map(a=>a.dest.type==="identifier"?a.dest.name:"?").join(", ")} ) { ... }`:"?"}const Dr=Object.freeze(Object.defineProperty({__proto__:null,assertArray:D,assertBoolean:E,assertFunction:S,assertNull:Mt,assertNumber:c,assertObject:H,assertString:P,eq:ee,expectAny:L,getLangVersion:St,isArray:k,isBoolean:rt,isFunction:oe,isNull:it,isNumber:at,isObject:X,isString:nt,jsToVal:me,reprValue:G,valToJs:de,valToString:st},Symbol.toStringTag,{value:"Module"})),Ot={version:"1.2.0"},At=Ot.version,ut=new TextEncoder,Nt=new TextDecoder,ie=Math.ceil(Math.log2(Number.MAX_SAFE_INTEGER));BigInt(ie);const Rt=ie-1;BigInt(Rt);class Re{generateNumber0To1(){let t=this.generateBigUintByBits(ie),r=1022,a=ie-je(t);for(;a>0&&r>=ie;)r-=a,t<<=BigInt(a),t|=this.generateBigUintByBits(a),a=ie-je(t);if(a>0){const n=Math.min(r-1,a);t<<=BigInt(n),t|=this.generateBigUintByBits(n),r=Math.max(r-n,0)}return Number(t)*.5**ie*.5**(1022-r)}generateUniform(t){if(t<1)return 0n;const r=t.toString(2).length,a=Math.ceil(r/8),n=BigInt(a*8-r);let i;do i=this.generateBigUintByBytes(a)>>n;while(i>t);return i}generateRandomIntegerInRange(t,r){const a=Math.ceil(t),n=Math.floor(r),i=n-a;if(i===0)return a;const s=Math.abs(i),o=Math.sign(i);if(!Number.isSafeInteger(s)||!Number.isSafeInteger(a)||!Number.isSafeInteger(n))return null;const h=BigInt(s);return Number(this.generateUniform(h))*o+a}}function je(e){return e===0n?0:e.toString(2).length}function Ut(e){if(e.byteLength===0)return null;if(e.byteLength<8){const t=new Uint8Array(8);return t.set(new Uint8Array(e)),new DataView(t.buffer).getBigUint64(0,!0)}return new DataView(e).getBigUint64(0,!0)}function Ue(e){if(e.byteLength===0)return null;if(e.byteLength<=8)return Ut(e);const t=new DataView(e);let r=0n,a=0n,n=0;for(;n<t.byteLength-7;n+=8,r+=64n){const i=t.getBigUint64(n,!0);a|=i<<r}if(n<t.byteLength){const i=new Uint8Array(8);i.set(new Uint8Array(e,n)),a|=new DataView(i.buffer).getBigUint64(0,!0)<<r}return a}class fe extends Re{static _instance=new fe;static get instance(){return fe._instance}constructor(){super()}generateBigUintByBytes(t){let r=new Uint8Array(Math.ceil(t/8)*8);return r.length<1||!Number.isSafeInteger(t)?0n:(r=this.generateBytes(r.subarray(0,t)),Ue(r.buffer)??0n)}generateBigUintByBits(t){if(t<1||!Number.isSafeInteger(t))return 0n;const r=Math.ceil(t/8),a=BigInt(r*8-t);return this.generateBigUintByBytes(r)>>a}generateBytes(t){return crypto.getRandomValues(t)}}const re=Int32Array.BYTES_PER_ELEMENT;class Lt extends Re{rng;buffer;filledBuffer;constructor(t){super(),this.rng=et(t.toString()),this.buffer=new Uint8Array(re),this.filledBuffer=new Uint8Array(0)}fillBuffer(){this.buffer.fill(0),this.buffer=this.fillBufferDirect(this.buffer),this.filledBuffer=this.buffer}fillBufferDirect(t){if(t.length%re!==0)throw new Error(`SeedRandomWrapper.fillBufferDirect should always be called with the buffer with the length a multiple-of-${re}!`);const r=t.length/re,a=new DataView(t.buffer);let n=0;for(let i=0;i<r;i++,n+=re)a.setInt32(n,this.rng.int32(),!1);return t}generateBigUintByBytes(t){let r=new Uint8Array(Math.ceil(t/8)*8);return r.length<1||!Number.isSafeInteger(t)?0n:(r=this.generateBytes(r.subarray(0,t)),Ue(r.buffer)??0n)}generateBigUintByBits(t){if(t<1||!Number.isSafeInteger(t))return 0n;const r=Math.ceil(t/8),a=BigInt(r*8-t);return this.generateBigUintByBytes(r)>>a}generateBytes(t){if(t.length<1)return t;t.fill(0);let r=t;if(r.length<=this.filledBuffer.length)return r.set(this.filledBuffer.subarray(0,r.length)),this.filledBuffer=this.filledBuffer.subarray(r.length),t;for(;r.length>0;){if(this.filledBuffer.length===0){if(r.length>=re){const a=r.subarray(0,r.length-r.length%re);this.fillBufferDirect(a),r=r.subarray(a.length);continue}this.fillBuffer()}if(r.length<=this.filledBuffer.length)return r.set(this.filledBuffer.subarray(0,r.length)),this.filledBuffer=this.filledBuffer.subarray(r.length),t;r.set(this.filledBuffer),r=r.subarray(this.filledBuffer.length),this.fillBuffer()}return t}}const pe=64,It=20,ge=32,Ke=8;function ye(e,t){return e<<t|e>>>32-t}function Z(e,t,r,a,n){if(e.length<16)return;let i=e[t],s=e[r],o=e[a],h=e[n];i===void 0||s===void 0||o===void 0||h===void 0||(i=i+s|0,h=ye(h^i,16),o=o+h|0,s=ye(s^o,12),i=i+s|0,h=ye(h^i,8),o=o+h|0,s=ye(s^o,7),e[t]=i,e[r]=s,e[a]=o,e[n]=h)}function Ht(e,t){if(!(e.length<16||t.length<16)){e.set(t);for(let r=0;r<It;r+=2)Z(e,0,4,8,12),Z(e,1,5,9,13),Z(e,2,6,10,14),Z(e,3,7,11,15),Z(e,0,5,10,15),Z(e,1,6,11,12),Z(e,2,7,8,13),Z(e,3,4,9,14);for(let r=0;r<16;r++){let a=e[r];const n=t[r];if(a===void 0||n===void 0)throw new Error("generateChaCha20: Something went wrong!");a=a+n|0,e[r]=a}}}class Dt extends Re{keynonce;state;buffer;filledBuffer;counter;constructor(t){const r=Ke+ge;super();let a;if(typeof t>"u")a=crypto.getRandomValues(new Uint8Array(r));else if(a=t,a.byteLength>r&&(a=t.subarray(0,r)),a.byteLength<r){const o=new Uint8Array(r);o.set(a),a=o}const n=a.subarray(0,ge),i=a.subarray(ge,ge+Ke),s=new Uint8Array(64);s.set([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]),s.set(n,16),s.set(i,56),this.keynonce=new Uint32Array(s.buffer),this.state=new Uint32Array(16),this.buffer=new Uint8Array(pe),this.counter=0n,this.filledBuffer=new Uint8Array(0)}fillBuffer(){this.buffer.fill(0),this.buffer=this.fillBufferDirect(this.buffer),this.filledBuffer=this.buffer}fillBufferDirect(t){if(t.length%pe!==0)throw new Error("ChaCha20.fillBufferDirect should always be called with the buffer with the length a multiple-of-64!");t.fill(0);let r=this.counter;const a=this.state,n=new BigUint64Array(a.buffer);let i=t;for(;i.length>0;){const s=i.subarray(0,a.byteLength),o=new Uint32Array(s.buffer);a.set(this.keynonce),n[6]=BigInt.asUintN(64,r),Ht(o,a),i=i.subarray(s.length),r=BigInt.asUintN(64,r+1n)}return this.counter=r,t}generateBigUintByBytes(t){let r=new Uint8Array(Math.ceil(t/8)*8);return r.length<1||!Number.isSafeInteger(t)?0n:(r=this.generateBytes(r.subarray(0,t)),Ue(r.buffer)??0n)}generateBigUintByBits(t){if(t<1||!Number.isSafeInteger(t))return 0n;const r=Math.ceil(t/8),a=BigInt(r*8-t);return this.generateBigUintByBytes(r)>>a}generateBytes(t){if(t.length<1)return t;t.fill(0);let r=t;if(r.length<=this.filledBuffer.length)return r.set(this.filledBuffer.subarray(0,r.length)),this.filledBuffer=this.filledBuffer.subarray(r.length),t;for(;r.length>0;){if(this.filledBuffer.length===0){if(r.length>=pe){const a=r.subarray(0,r.length-r.length%pe);this.fillBufferDirect(a),r=r.subarray(a.length);continue}this.fillBuffer()}if(r.length<=this.filledBuffer.length)return r.set(this.filledBuffer.subarray(0,r.length)),this.filledBuffer=this.filledBuffer.subarray(r.length),t;r.set(this.filledBuffer),r=r.subarray(this.filledBuffer.length),this.fillBuffer()}return t}}function qt(e){if(!e||e.type!=="num"&&e.type!=="str")return g;const t=et(e.value.toString());return l(([r,a])=>r&&r.type==="num"&&a&&a.type==="num"?f(Math.floor(t()*(Math.floor(a.value)-Math.ceil(r.value)+1)+Math.ceil(r.value))):f(t()))}function $t(e){if(!e||e.type!=="num"&&e.type!=="str")return g;const t=new Lt(e.value);return l(([r,a])=>{if(r&&r.type==="num"&&a&&a.type==="num"){const n=t.generateRandomIntegerInRange(r.value,a.value);return typeof n=="number"?f(n):g}return f(t.generateNumber0To1())})}async function jt(e){if(!e||e.type!=="num"&&e.type!=="str"&&e.type!=="null")return g;let t;e.type==="num"?t=new Uint8Array(await crypto.subtle.digest("SHA-384",new Uint8Array(new Float64Array([e.value])))):e.type==="str"&&(t=new Uint8Array(await crypto.subtle.digest("SHA-384",new Uint8Array(ut.encode(e.value)))));const r=new Dt(t);return l(([a,n])=>{if(a&&a.type==="num"&&n&&n.type==="num"){const i=r.generateRandomIntegerInRange(a.value,n.value);return typeof i=="number"?f(i):g}return f(r.generateNumber0To1())})}const Kt={"Math:Infinity":f(1/0),"Math:E":f(Math.E),"Math:LN2":f(Math.LN2),"Math:LN10":f(Math.LN10),"Math:LOG2E":f(Math.LOG2E),"Math:LOG10E":f(Math.LOG10E),"Math:PI":f(Math.PI),"Math:SQRT1_2":f(Math.SQRT1_2),"Math:SQRT2":f(Math.SQRT2),"Math:abs":l(([e])=>(c(e),f(Math.abs(e.value)))),"Math:acos":l(([e])=>(c(e),f(Math.acos(e.value)))),"Math:acosh":l(([e])=>(c(e),f(Math.acosh(e.value)))),"Math:asin":l(([e])=>(c(e),f(Math.asin(e.value)))),"Math:asinh":l(([e])=>(c(e),f(Math.asinh(e.value)))),"Math:atan":l(([e])=>(c(e),f(Math.atan(e.value)))),"Math:atanh":l(([e])=>(c(e),f(Math.atanh(e.value)))),"Math:atan2":l(([e,t])=>(c(e),c(t),f(Math.atan2(e.value,t.value)))),"Math:cbrt":l(([e])=>(c(e),f(Math.cbrt(e.value)))),"Math:ceil":l(([e])=>(c(e),f(Math.ceil(e.value)))),"Math:clz32":l(([e])=>(c(e),f(Math.clz32(e.value)))),"Math:cos":l(([e])=>(c(e),f(Math.cos(e.value)))),"Math:cosh":l(([e])=>(c(e),f(Math.cosh(e.value)))),"Math:exp":l(([e])=>(c(e),f(Math.exp(e.value)))),"Math:expm1":l(([e])=>(c(e),f(Math.expm1(e.value)))),"Math:floor":l(([e])=>(c(e),f(Math.floor(e.value)))),"Math:fround":l(([e])=>(c(e),f(Math.fround(e.value)))),"Math:hypot":l(([e])=>{D(e);const t=[];for(const r of e.value)c(r),t.push(r.value);return f(Math.hypot(...t))}),"Math:imul":l(([e,t])=>(c(e),c(t),f(Math.imul(e.value,t.value)))),"Math:log":l(([e])=>(c(e),f(Math.log(e.value)))),"Math:log1p":l(([e])=>(c(e),f(Math.log1p(e.value)))),"Math:log10":l(([e])=>(c(e),f(Math.log10(e.value)))),"Math:log2":l(([e])=>(c(e),f(Math.log2(e.value)))),"Math:max":l(([e,t])=>(c(e),c(t),f(Math.max(e.value,t.value)))),"Math:min":l(([e,t])=>(c(e),c(t),f(Math.min(e.value,t.value)))),"Math:pow":l(([e,t])=>(c(e),c(t),f(Math.pow(e.value,t.value)))),"Math:round":l(([e])=>(c(e),f(Math.round(e.value)))),"Math:sign":l(([e])=>(c(e),f(Math.sign(e.value)))),"Math:sin":l(([e])=>(c(e),f(Math.sin(e.value)))),"Math:sinh":l(([e])=>(c(e),f(Math.sinh(e.value)))),"Math:sqrt":l(([e])=>{c(e);const t=Math.sqrt(e.value);return f(t)}),"Math:tan":l(([e])=>(c(e),f(Math.tan(e.value)))),"Math:tanh":l(([e])=>(c(e),f(Math.tanh(e.value)))),"Math:trunc":l(([e])=>(c(e),f(Math.trunc(e.value)))),"Math:rnd":l(([e,t])=>{if(e&&e.type==="num"&&t&&t.type==="num"){const r=fe.instance.generateRandomIntegerInRange(e.value,t.value);return r===null?g:f(r)}return f(fe.instance.generateNumber0To1())}),"Math:gen_rng":l(async([e,t])=>{L(e);const r="subtle"in crypto;let a=r?"chacha20":"rc4_legacy";if(t?.type==="obj"){const n=t.value.get("algorithm");if(n?.type!=="str")throw new v("`options.algorithm` must be string.");a=n.value}else if(t?.type!==void 0)throw new v("`options` must be an object if specified.");if(e.type!=="num"&&e.type!=="str"&&e.type!=="null")throw new v("`seed` must be either number or string if specified.");switch(a){case"rc4_legacy":return qt(e);case"rc4":{if(!r)throw new v(`The random algorithm ${a} cannot be used because \`crypto.subtle\` is not available. Maybe in non-secure context?`);return $t(e)}case"chacha20":{if(!r)throw new v(`The random algorithm ${a} cannot be used because \`crypto.subtle\` is not available. Maybe in non-secure context?`);return await jt(e)}default:throw new v("`options.algorithm` must be one of these: `chacha20`, `rc4`, or `rc4_legacy`.")}})},Vt={...Kt,help:b("SEE: https://github.com/syuilo/aiscript/blob/master/docs/get-started.md"),"Core:v":b(At),"Core:ai":b("kawaii"),"Core:not":l(([e])=>(E(e),e.value?N:A)),"Core:eq":l(([e,t])=>(L(e),L(t),ee(e,t)?A:N)),"Core:neq":l(([e,t])=>(L(e),L(t),ee(e,t)?N:A)),"Core:and":l(([e,t])=>(E(e),e.value?(E(t),t.value?A:N):N)),"Core:or":l(([e,t])=>(E(e),e.value?A:(E(t),t.value?A:N))),"Core:add":l(([e,t])=>(c(e),c(t),f(e.value+t.value))),"Core:sub":l(([e,t])=>(c(e),c(t),f(e.value-t.value))),"Core:mul":l(([e,t])=>(c(e),c(t),f(e.value*t.value))),"Core:pow":l(([e,t])=>{c(e),c(t);const r=e.value**t.value;return f(r)}),"Core:div":l(([e,t])=>{c(e),c(t);const r=e.value/t.value;return f(r)}),"Core:mod":l(([e,t])=>(c(e),c(t),f(e.value%t.value))),"Core:gt":l(([e,t])=>(c(e),c(t),e.value>t.value?A:N)),"Core:lt":l(([e,t])=>(c(e),c(t),e.value<t.value?A:N)),"Core:gteq":l(([e,t])=>(c(e),c(t),e.value>=t.value?A:N)),"Core:lteq":l(([e,t])=>(c(e),c(t),e.value<=t.value?A:N)),"Core:type":l(([e])=>(L(e),b(e.type))),"Core:to_str":l(([e])=>(L(e),b(G(e)))),"Core:range":l(([e,t])=>(c(e),c(t),e.value<t.value?C(Array.from({length:t.value-e.value+1},(r,a)=>f(a+e.value))):e.value>t.value?C(Array.from({length:e.value-t.value+1},(r,a)=>f(e.value-a))):C([e]))),"Core:sleep":l(async([e])=>(c(e),await new Promise(t=>setTimeout(t,e.value)),g)),"Core:abort":l(async([e])=>{throw P(e),new tt(e.value)}),"Util:uuid":l(()=>b(Et())),"Json:stringify":l(([e])=>(L(e),b(JSON.stringify(de(e))))),"Json:parse":l(([e])=>{P(e);try{return me(JSON.parse(e.value))}catch{return ce("not_json")}}),"Json:parsable":l(([e])=>{P(e);try{JSON.parse(e.value)}catch{return T(!1)}return T(!0)}),"Date:now":l(()=>f(Date.now())),"Date:year":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getFullYear()))),"Date:month":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getMonth()+1))),"Date:day":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getDate()))),"Date:hour":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getHours()))),"Date:minute":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getMinutes()))),"Date:second":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getSeconds()))),"Date:millisecond":l(([e])=>(e&&c(e),f(new Date(e?.value??Date.now()).getMilliseconds()))),"Date:parse":l(([e])=>{P(e);const t=new Date(e.value).getTime();return t===t?f(t):ce("not_date")}),"Date:to_iso_str":l(([e,t])=>{e&&c(e);const r=new Date(e?.value??Date.now());t&&c(t);const a=t?.value??-r.getTimezoneOffset();let n;if(a===0)n="Z";else{const O=Math.sign(a),R=Math.floor(Math.abs(a)/60),$=Math.abs(a)%60;r.setUTCHours(r.getUTCHours()+O*R),r.setUTCMinutes(r.getUTCMinutes()+O*$);const j=a>0?"+":"-",_e=R.toString().padStart(2,"0"),Pe=$.toString().padStart(2,"0");n=`${j}${_e}:${Pe}`}const i=r.getUTCFullYear().toString().padStart(4,"0"),s=(r.getUTCMonth()+1).toString().padStart(2,"0"),o=r.getUTCDate().toString().padStart(2,"0"),h=r.getUTCHours().toString().padStart(2,"0"),w=r.getUTCMinutes().toString().padStart(2,"0"),d=r.getUTCSeconds().toString().padStart(2,"0"),B=r.getUTCMilliseconds().toString().padStart(3,"0");return b(`${i}-${s}-${o}T${h}:${w}:${d}.${B}${n}`)}),"Num:from_hex":l(([e])=>(P(e),f(parseInt(e.value,16)))),"Str:lf":b(`
`),"Str:lt":l(([e,t])=>(P(e),P(t),e.value<t.value?f(-1):e.value===t.value?f(0):f(1))),"Str:gt":l(([e,t])=>(P(e),P(t),e.value>t.value?f(-1):e.value===t.value?f(0):f(1))),"Str:from_codepoint":l(([e])=>(c(e),b(String.fromCodePoint(e.value)))),"Str:from_unicode_codepoints":l(([e])=>(D(e),b(Array.from(e.value.map(t=>(c(t),String.fromCodePoint(t.value)))).join("")))),"Str:from_utf8_bytes":l(([e])=>(D(e),b(Nt.decode(Uint8Array.from(e.value.map(t=>(c(t),t.value))))))),"Uri:encode_full":l(([e])=>(P(e),b(encodeURI(e.value)))),"Uri:encode_component":l(([e])=>(P(e),b(encodeURIComponent(e.value)))),"Uri:decode_full":l(([e])=>(P(e),b(decodeURI(e.value)))),"Uri:decode_component":l(([e])=>(P(e),b(decodeURIComponent(e.value)))),"Arr:create":l(([e,t])=>{c(e);try{return C(Array(e.value).fill(t??g))}catch(r){throw e.value<0?new v("Arr:create expected non-negative number, got negative"):Number.isInteger(e.value)?r:new v("Arr:create expected integer, got non-integer")}}),"Obj:keys":l(([e])=>(H(e),C(Array.from(e.value.keys()).map(t=>b(t))))),"Obj:vals":l(([e])=>(H(e),C(Array.from(e.value.values())))),"Obj:kvs":l(([e])=>(H(e),C(Array.from(e.value.entries()).map(([t,r])=>C([b(t),r]))))),"Obj:get":l(([e,t])=>(H(e),P(t),e.value.get(t.value)??g)),"Obj:set":l(([e,t,r])=>(H(e),P(t),L(r),e.value.set(t.value,r),g)),"Obj:has":l(([e,t])=>(H(e),P(t),T(e.value.has(t.value)))),"Obj:copy":l(([e])=>(H(e),Q(new Map(e.value)))),"Obj:merge":l(([e,t])=>(H(e),H(t),Q(new Map([...e.value,...t.value])))),"Obj:pick":l(([e,t])=>(H(e),D(t),Q(new Map(t.value.map(r=>(P(r),[r.value,e.value.get(r.value)??g])))))),"Obj:from_kvs":l(([e])=>(D(e),Q(new Map(e.value.map(t=>{D(t);const[r,a]=t.value;return P(r),L(a),[r.value,a]}))))),"Error:create":l(([e,t])=>(P(e),ce(e.value,t))),"Async:interval":l(async([e,t,r],a)=>{c(e),S(t),r&&(E(r),r.value&&a.call(t,[]));let n;const i=()=>{n=setInterval(()=>{a.topCall(t,[])},e.value),a.registerAbortHandler(s),a.registerPauseHandler(s),a.unregisterUnpauseHandler(i)},s=()=>{clearInterval(n),a.unregisterAbortHandler(s),a.unregisterPauseHandler(s),a.registerUnpauseHandler(i)};return i(),l(([],o)=>{s(),o.unregisterUnpauseHandler(i)})}),"Async:timeout":l(async([e,t],r)=>{c(e),S(t);let a;const n=()=>{a=setTimeout(()=>{r.topCall(t,[]),r.unregisterAbortHandler(i),r.unregisterPauseHandler(i)},e.value),r.registerAbortHandler(i),r.registerPauseHandler(i),r.unregisterUnpauseHandler(n)},i=()=>{clearTimeout(a),r.unregisterAbortHandler(i),r.unregisterPauseHandler(i),r.registerUnpauseHandler(n)};return n(),l(([],s)=>{i(),s.unregisterUnpauseHandler(n)})})},Ve=e=>({type:"return",value:e}),Fe=(e,t)=>({type:"break",label:e,value:t}),Te=e=>({type:"continue",label:e,value:null});function K(e,t){return e.type==="break"&&e.label!=null&&e.label===t?e.value??g:e}function We(e){switch(e.type){case"return":return e.value;default:return ae(e),e}}function ae(e){switch(e.type){case"return":throw new v("Invalid return");case"break":throw new v("Invalid break");case"continue":throw new v("Invalid continue")}}function p(e){switch(e.type){case"null":case"bool":case"num":case"str":case"arr":case"obj":case"fn":case"error":case"reference":return!1;case"return":case"break":case"continue":return!0}throw new TypeError("expected value or control")}var F={},Be,Ge;function Ft(){return Ge||(Ge=1,Be=()=>{const e="\\ud800-\\udfff",s="\\u0300-\\u036f"+"\\ufe20-\\ufe2f"+"\\u20d0-\\u20ff"+"\\u1ab0-\\u1aff"+"\\u1dc0-\\u1dff",o="\\ufe0e\\ufe0f",h="\\uD83D\\uDC69\\uD83C\\uDFFB\\u200D\\uD83C\\uDF93",w=`[${e}]`,d=`[${s}]`,B="\\ud83c[\\udffb-\\udfff]",O=`(?:${d}|${B})`,R=`[^${e}]`,$="(?:\\uD83C[\\uDDE6-\\uDDFF]){2}",j="[\\ud800-\\udbff][\\udc00-\\udfff]",_e="\\u200d",Pe="(?:\\ud83c\\udff4\\udb40\\udc67\\udb40\\udc62\\udb40(?:\\udc65|\\udc73|\\udc77)\\udb40(?:\\udc6e|\\udc63|\\udc6c)\\udb40(?:\\udc67|\\udc74|\\udc73)\\udb40\\udc7f)",gt=`[${h}]`,De=`${O}?`,qe=`[${o}]?`,yt=`(?:${_e}(?:${[R,$,j].join("|")})${qe+De})*`,wt=qe+De+yt,vt=`(?:${[`${R}${d}?`,d,$,j,w,gt].join("|")})`;return new RegExp(`${Pe}|${B}(?=${B})|${vt+wt}`,"g")}),Be}var ze;function Tt(){if(ze)return F;ze=1;var e=F&&F.__importDefault||(function(h){return h&&h.__esModule?h:{default:h}});Object.defineProperty(F,"__esModule",{value:!0});var t=e(Ft());function r(h){if(typeof h!="string")throw new Error("A string is expected as input");return h.match(t.default())||[]}F.toArray=r;function a(h){if(typeof h!="string")throw new Error("Input must be a string");var w=h.match(t.default());return w===null?0:w.length}F.length=a;function n(h,w,d){if(w===void 0&&(w=0),typeof h!="string")throw new Error("Input must be a string");(typeof w!="number"||w<0)&&(w=0),typeof d=="number"&&d<0&&(d=0);var B=h.match(t.default());return B?B.slice(w,d).join(""):""}F.substring=n;function i(h,w,d){if(w===void 0&&(w=0),typeof h!="string")throw new Error("Input must be a string");var B=a(h);if(typeof w!="number"&&(w=parseInt(w,10)),w>=B)return"";w<0&&(w+=B);var O;typeof d>"u"?O=B:(typeof d!="number"&&(d=parseInt(d,10)),O=d>=0?d+w:w);var R=h.match(t.default());return R?R.slice(w,O).join(""):""}F.substr=i;function s(h,w,d,B){if(w===void 0&&(w=16),d===void 0&&(d="#"),B===void 0&&(B="right"),typeof h!="string"||typeof w!="number")throw new Error("Invalid arguments specified");if(["left","right"].indexOf(B)===-1)throw new Error("Pad position should be either left or right");typeof d!="string"&&(d=String(d));var O=a(h);if(O>w)return n(h,0,w);if(O<w){var R=d.repeat(w-O);return B==="left"?R+h:h+R}return h}F.limit=s;function o(h,w,d){if(d===void 0&&(d=0),typeof h!="string")throw new Error("Input must be a string");if(h==="")return w===""?0:-1;d=Number(d),d=isNaN(d)?0:d,w=String(w);var B=r(h);if(d>=B.length)return w===""?B.length:-1;if(w==="")return d;var O=r(w),R=!1,$;for($=d;$<B.length;$+=1){for(var j=0;j<O.length&&O[j]===B[$+j];)j+=1;if(j===O.length&&O[j-1]===B[$+j-1]){R=!0;break}}return R?$:-1}return F.indexOf=o,F}var ue=Tt();const Je={num:{to_str:e=>l((t,r)=>b(e.value.toString())),to_hex:e=>l((t,r)=>b(e.value.toString(16)))},str:{to_num:e=>l((t,r)=>{const a=parseInt(e.value,10);return isNaN(a)?g:f(a)}),to_arr:e=>l((t,r)=>C(ue.toArray(e.value).map(a=>b(a)))),to_unicode_arr:e=>l((t,r)=>C([...e.value].map(a=>b(a)))),to_unicode_codepoint_arr:e=>l((t,r)=>C([...e.value].map(a=>{const n=a.codePointAt(0);return f(n??a.charCodeAt(0))}))),to_char_arr:e=>l((t,r)=>C(e.value.split("").map(a=>b(a)))),to_charcode_arr:e=>l((t,r)=>C(e.value.split("").map(a=>f(a.charCodeAt(0))))),to_utf8_byte_arr:e=>l((t,r)=>C(Array.from(ut.encode(e.value)).map(a=>f(a)))),len:e=>f(ue.length(e.value)),replace:e=>l(([t,r],a)=>(P(t),P(r),b(e.value.split(t.value).join(r.value)))),index_of:e=>l(([t,r],a)=>{P(t),r&&c(r);const n=r?r.value<0?e.value.length+r.value:r.value:void 0;return f(ue.indexOf(e.value,t.value,n))}),incl:e=>l(([t],r)=>(P(t),e.value.includes(t.value)?A:N)),trim:e=>l((t,r)=>b(e.value.trim())),upper:e=>l((t,r)=>b(e.value.toUpperCase())),lower:e=>l((t,r)=>b(e.value.toLowerCase())),split:e=>l(([t],r)=>(t&&P(t),C(t?e.value.split(t?t.value:"").map(a=>b(a)):ue.toArray(e.value).map(a=>b(a))))),slice:e=>l(([t,r],a)=>(c(t),c(r),b(ue.substring(e.value,t.value,r.value)))),pick:e=>l(([t],r)=>{c(t);const n=ue.toArray(e.value)[t.value];return n?b(n):g}),charcode_at:e=>l(([t],r)=>{c(t);const a=e.value.charCodeAt(t.value);return Number.isNaN(a)?g:f(a)}),codepoint_at:e=>l(([t],r)=>{c(t);const a=e.value.codePointAt(t.value)??e.value.charCodeAt(t.value);return Number.isNaN(a)?g:f(a)}),starts_with:e=>l(([t,r],a)=>{if(P(t),!t.value)return A;r&&c(r);const n=r?.value??0;if(n<-e.value.length||n>e.value.length)return N;const i=n>=0?n:e.value.length+n;return e.value.startsWith(t.value,i)?A:N}),ends_with:e=>l(([t,r],a)=>{if(P(t),!t.value)return A;r&&c(r);const n=r?.value??e.value.length;if(n<-e.value.length||n>e.value.length)return N;const i=n>=0?n:e.value.length+n;return e.value.endsWith(t.value,i)?A:N}),pad_start:e=>l(([t,r],a)=>{c(t);const n=r?(P(r),r.value):" ";return b(e.value.padStart(t.value,n))}),pad_end:e=>l(([t,r],a)=>{c(t);const n=r?(P(r),r.value):" ";return b(e.value.padEnd(t.value,n))})},arr:{len:e=>f(e.value.length),push:e=>l(([t],r)=>(L(t),e.value.push(t),e)),unshift:e=>l(([t],r)=>(L(t),e.value.unshift(t),e)),pop:e=>l((t,r)=>e.value.pop()??g),shift:e=>l((t,r)=>e.value.shift()??g),concat:e=>l(([t],r)=>(D(t),C(e.value.concat(t.value)))),slice:e=>l(([t,r],a)=>(c(t),c(r),C(e.value.slice(t.value,r.value)))),join:e=>l(([t],r)=>(t&&P(t),b(e.value.map(a=>a.type==="str"?a.value:"").join(t?t.value:"")))),map:e=>l(async([t],r)=>{S(t);const a=e.value.map(async(n,i)=>await r.call(t,[n,f(i)]));return C(await Promise.all(a))},([t],r)=>{S(t);const a=e.value.map((n,i)=>r.call(t,[n,f(i)]));return C(a)}),filter:e=>l(async([t],r)=>{S(t);const a=[];for(let n=0;n<e.value.length;n++){const i=e.value[n],s=await r.call(t,[i,f(n)]);E(s),s.value&&a.push(i)}return C(a)},([t],r)=>{S(t);const a=[];for(let n=0;n<e.value.length;n++){const i=e.value[n],s=r.call(t,[i,f(n)]);E(s),s.value&&a.push(i)}return C(a)}),reduce:e=>l(async([t,r],a)=>{S(t);const n=r!=null;if(!n&&e.value.length===0)throw new v("Reduce of empty array without initial value");let i=n?r:e.value[0];for(let s=n?0:1;s<e.value.length;s++){const o=e.value[s];i=await a.call(t,[i,o,f(s)])}return i},([t,r],a)=>{S(t);const n=r!=null;if(!n&&e.value.length===0)throw new v("Reduce of empty array without initial value");let i=n?r:e.value[0];for(let s=n?0:1;s<e.value.length;s++){const o=e.value[s];i=a.call(t,[i,o,f(s)])}return i}),find:e=>l(async([t],r)=>{S(t);for(let a=0;a<e.value.length;a++){const n=e.value[a],i=await r.call(t,[n,f(a)]);if(E(i),i.value)return n}return g},([t],r)=>{S(t);for(let a=0;a<e.value.length;a++){const n=e.value[a],i=r.call(t,[n,f(a)]);if(E(i),i.value)return n}return g}),incl:e=>l(([t],r)=>(L(t),e.value.some(a=>ee(t,a))?A:N)),index_of:e=>l(([t,r],a)=>{if(L(t),r){c(r);const n=e.value.slice(0,r.value).length,i=e.value.slice(r.value).findIndex(s=>ee(s,t));return f(i<0?i:i+n)}else return f(e.value.findIndex(n=>ee(n,t)))}),reverse:e=>l((t,r)=>(e.value.reverse(),g)),copy:e=>l((t,r)=>C([...e.value])),sort:e=>l(async([t],r)=>{const a=async(i,s)=>{if(i.length<=1)return i;const o=Math.floor(i.length/2),h=a(i.slice(0,o),s),w=a(i.slice(o),s),[d,B]=await Promise.all([h,w]);return n(d,B,s)},n=async(i,s,o)=>{const h=[];let w=0,d=0;for(;w<i.length&&d<s.length;){const B=i[w],O=s[d],R=await r.call(o,[B,O]);c(R),R.value<=0?(h.push(i[w]),w++):(h.push(s[d]),d++)}return h.concat(i.slice(w)).concat(s.slice(d))};return S(t),D(e),e.value=await a(e.value,t),e},([t],r)=>{const a=(i,s)=>{if(i.length<=1)return i;const o=Math.floor(i.length/2),h=a(i.slice(0,o),s),w=a(i.slice(o),s);return n(h,w,s)},n=(i,s,o)=>{const h=[];let w=0,d=0;for(;w<i.length&&d<s.length;){const B=i[w],O=s[d],R=r.call(o,[B,O]);c(R),R.value<=0?(h.push(i[w]),w++):(h.push(s[d]),d++)}return h.concat(i.slice(w)).concat(s.slice(d))};return S(t),D(e),e.value=a(e.value,t),e}),fill:e=>l(([t,r,a],n)=>{const i=t??g,s=r&&(c(r),r.value),o=a&&(c(a),a.value);return e.value.fill(i,s,o),e}),repeat:e=>l(([t],r)=>{c(t);try{return C(Array(t.value).fill(e.value).flat())}catch(a){throw t.value<0?new v("arr.repeat expected non-negative number, got negative"):Number.isInteger(t.value)?a:new v("arr.repeat expected integer, got non-integer")}}),splice:e=>l(([t,r,a],n)=>{c(t);const i=t.value<-e.value.length?0:t.value<0?e.value.length+t.value:t.value>=e.value.length?e.value.length:t.value,s=r!=null?(c(r),r.value):e.value.length-i,o=a!=null?(D(a),a.value):[],h=e.value.splice(i,s,...o);return C(h)}),flat:e=>l(([t],r)=>{if(t=t??f(1),c(t),!Number.isInteger(t.value))throw new v("arr.flat expected integer, got non-integer");if(t.value<0)throw new v("arr.flat expected non-negative number, got negative");const a=(i,s,o)=>{if(s===0){o.push(...i);return}for(const h of i)k(h)?a(h.value,s-1,o):o.push(h)},n=[];return a(e.value,t.value,n),C(n)}),flat_map:e=>l(async([t],r)=>{S(t);const a=e.value.map(async(i,s)=>{const o=await r.call(t,[i,f(s)]);return k(o)?o.value:o}),n=await Promise.all(a);return C(n.flat())},([t],r)=>{S(t);const n=e.value.map((i,s)=>{const o=r.call(t,[i,f(s)]);return k(o)?o.value:o});return C(n.flat())}),every:e=>l(async([t],r)=>{S(t);for(let a=0;a<e.value.length;a++){const n=e.value[a],i=await r.call(t,[n,f(a)]);if(E(i),!i.value)return N}return A},([t],r)=>{S(t);for(let a=0;a<e.value.length;a++){const n=e.value[a],i=r.call(t,[n,f(a)]);if(E(i),!i.value)return N}return A}),some:e=>l(async([t],r)=>{S(t);for(let a=0;a<e.value.length;a++){const n=e.value[a],i=await r.call(t,[n,f(a)]);if(E(i),i.value)return A}return N},([t],r)=>{S(t);for(let a=0;a<e.value.length;a++){const n=e.value[a],i=r.call(t,[n,f(a)]);if(E(i),i.value)return A}return N}),insert:e=>l(([t,r],a)=>(c(t),L(r),e.value.splice(t.value,0,r),g)),remove:e=>l(([t],r)=>(c(t),e.value.splice(t.value,1)[0]??g)),at:e=>l(([t,r],a)=>(c(t),e.value.at(t.value)??r??g))},error:{name:e=>b(e.value),info:e=>e.info??g}};function Qe(e,t){if(Object.hasOwn(Je,e.type)){const r=Je[e.type];if(Object.hasOwn(r,t))return r[t](e);throw new v(`No such prop (${t}) in ${e.type}.`)}else throw new v(`Cannot read prop of ${e.type}. (reading ${t})`)}const Wt={mut(e){return{isMutable:!0,value:e}},const(e){return{isMutable:!1,value:e}}},V={variable(e,t){return new Gt(e,t)},index(e,t){return new zt(e.value,t)},prop(e,t){return new Jt(e.value,t)},arr(e){return new Qt(e)},obj(e){return new kt(e)}};class Gt{name;scope;constructor(t,r){this.name=t,this.scope=r,this.type="reference"}type;get(){return this.scope.get(this.name)}set(t){this.scope.assign(this.name,t)}}class zt{target;index;constructor(t,r){this.target=t,this.index=r,this.type="reference"}type;get(){return this.assertIndexInRange(),this.target[this.index]}set(t){this.assertIndexInRange(),this.target[this.index]=t}assertIndexInRange(){const t=this.index;if(t<0||this.target.length<=t)throw new ve(`Index out of range. index: ${this.index} max: ${this.target.length-1}`)}}class Jt{target;index;constructor(t,r){this.target=t,this.index=r,this.type="reference"}type;get(){return this.target.get(this.index)??g}set(t){this.target.set(this.index,t)}}class Qt{items;constructor(t){this.items=t,this.type="reference"}type;get(){return C(this.items.map(t=>t.get()))}set(t){D(t);for(const[r,a]of this.items.entries())a.set(t.value[r]??g)}}class kt{entries;constructor(t){this.entries=t,this.type="reference"}type;get(){return Q(new Map([...this.entries].map(([t,r])=>[t,r.get()])))}set(t){H(t);for(const[r,a]of this.entries.entries())a.set(t.value.get(r)??g)}}var x=(function(e,t,r,a){var n=arguments.length,i=n<3?t:a===null?a=Object.getOwnPropertyDescriptor(t,r):a,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i});class _{opts;stepCount=0;stop=!1;pausing=null;scope;abortHandlers=[];pauseHandlers=[];unpauseHandlers=[];vars={};irqRate;irqSleep;constructor(t,r={}){this.opts=r;const a={print:l(([i])=>{L(i),this.opts.out&&this.opts.out(i)}),readline:l(async i=>{const s=i[0];if(P(s),this.opts.in==null)return g;const o=await this.opts.in(s.value);return b(o)})};if(this.vars=Object.fromEntries(Object.entries({...t,...Vt,...a}).map(([i,s])=>[i,Wt.const(s)])),this.scope=new q([new Map(Object.entries(this.vars))]),this.scope.opts.log=(i,s)=>{switch(i){case"add":this.log("var:add",s);break;case"read":this.log("var:read",s);break;case"write":this.log("var:write",s);break}},!((this.opts.irqRate??300)>=0))throw new we(`Invalid IRQ rate (${this.opts.irqRate}): must be non-negative number`);this.irqRate=this.opts.irqRate??300;const n=i=>()=>new Promise(s=>setTimeout(s,i));if(typeof this.opts.irqSleep=="function")this.irqSleep=this.opts.irqSleep;else if(this.opts.irqSleep===void 0)this.irqSleep=n(5);else if(this.opts.irqSleep>=0)this.irqSleep=n(this.opts.irqSleep);else throw new we("irqSleep must be a function or a positive number.")}async exec(t){if(!(t==null||t.length===0))try{await this.collectNs(t);const r=await this._run(t,this.scope,[]);ae(r),this.log("end",{val:r})}catch(r){this.handleError(r)}}execSync(t){if(t==null||t.length===0)return;this.collectNsSync(t);const r=this._runSync(t,this.scope,[]);return ae(r),r}async execFn(t,r){return await this._fn(t,r,[]).catch(a=>(this.handleError(a),ce("func_failed")))}execFnSync(t,r){return this._fnSync(t,r,[])}execFnSimple(t,r){return this._fn(t,r,[])}static collectMetadata(t){if(t==null||t.length===0)return;const r=new Map;for(const a of t)switch(a.type){case"meta":{r.set(a.name,Ae(a.value));break}}return r}handleError(t){if(!this.opts.err)throw t;if(this.opts.abortOnError){if(this.stop)return;this.abort()}t instanceof W?this.opts.err(t):this.opts.err(new Se(t))}log(t,r){this.opts.log&&this.opts.log(t,r)}async collectNs(t,r=this.scope){for(const a of t)switch(a.type){case"ns":{await this.collectNsMember(a,r);break}}}collectNsSync(t,r=this.scope){for(const a of t)switch(a.type){case"ns":{this.collectNsMemberSync(a,r);break}}}async collectNsMember(t,r=this.scope){const a=r.createChildNamespaceScope(t.name);await this.collectNs(t.members,a);for(const n of t.members)switch(n.type){case"def":{if(n.dest.type!=="identifier")throw new ne("Destructuring assignment is invalid in namespace declarations.",n.loc.start);if(n.mut)throw new ne('No "var" in namespace declaration: '+n.dest.name,n.loc.start);const i=await this._eval(n.expr,a,[]);ae(i),n.expr.type==="fn"&&oe(i)&&!i.native&&(i.name=a.getNsPrefix()+n.dest.name),this.define(a,n.dest,i,n.mut);break}case"ns":break;default:{const s=n;throw new ne("invalid ns member type: "+s.type,s.loc.start)}}}collectNsMemberSync(t,r=this.scope){const a=r.createChildNamespaceScope(t.name);this.collectNsSync(t.members,a);for(const n of t.members)switch(n.type){case"def":{if(n.dest.type!=="identifier")throw new ne("Destructuring assignment is invalid in namespace declarations.",n.loc.start);if(n.mut)throw new ne('No "var" in namespace declaration: '+n.dest.name,n.loc.start);const i=this._evalSync(n.expr,a,[]);ae(i),n.expr.type==="fn"&&oe(i)&&!i.native&&(i.name=a.getNsPrefix()+n.dest.name),this.define(a,n.dest,i,n.mut);break}case"ns":break;default:{const s=n;throw new ne("invalid ns member type: "+s.type,s.loc.start)}}}async _fn(t,r,a,n){if(t.native){const i={name:"<native>",pos:n};return t.native(r,{call:(o,h)=>this._fn(o,h,[...a,i]),topCall:this.execFn,registerAbortHandler:this.registerAbortHandler,registerPauseHandler:this.registerPauseHandler,registerUnpauseHandler:this.registerUnpauseHandler,unregisterAbortHandler:this.unregisterAbortHandler,unregisterPauseHandler:this.unregisterPauseHandler,unregisterUnpauseHandler:this.unregisterUnpauseHandler})??g}else{const i=t.scope.createChildScope();for(const[o,h]of t.params.entries()){const w=r[o];h.default||L(w),this.define(i,h.dest,w??h.default,!0)}const s={name:t.name??"<anonymous>",pos:n};return We(await this._run(t.statements,i,[...a,s]))}}_fnSync(t,r,a,n){if(t.native){const i={name:"<native>",pos:n},s=t.nativeSync?t.nativeSync(r,{call:(o,h)=>this._fnSync(o,h,[...a,i]),topCall:this.execFnSync,registerAbortHandler:this.registerAbortHandler,registerPauseHandler:this.registerPauseHandler,registerUnpauseHandler:this.registerUnpauseHandler,unregisterAbortHandler:this.unregisterAbortHandler,unregisterPauseHandler:this.unregisterPauseHandler,unregisterUnpauseHandler:this.unregisterUnpauseHandler}):t.native(r,{call:(o,h)=>this._fn(o,h,[...a,i]),topCall:this.execFn,registerAbortHandler:this.registerAbortHandler,registerPauseHandler:this.registerPauseHandler,registerUnpauseHandler:this.registerUnpauseHandler,unregisterAbortHandler:this.unregisterAbortHandler,unregisterPauseHandler:this.unregisterPauseHandler,unregisterUnpauseHandler:this.unregisterUnpauseHandler});if(s instanceof Promise)throw new we("Native function must not return a Promise in sync mode.");return s??g}else{const i=t.scope.createChildScope();for(const[o,h]of t.params.entries()){const w=r[o];h.default||L(w),this.define(i,h.dest,w??h.default,!0)}const s={name:t.name??"<anonymous>",pos:n};return We(this._runSync(t.statements,i,[...a,s]))}}_evalClause(t,r,a){return this._eval(t,Oe(t)?r.createChildScope():r,a)}_evalClauseSync(t,r,a){return this._evalSync(t,Oe(t)?r.createChildScope():r,a)}async _evalBinaryOperation(t,r,a,n,i){const s=n.get(t);S(s);const o=await this._eval(r,n,i);if(p(o))return o;const h=await this._eval(a,n,i);return p(h)?h:this._fn(s,[o,h],i)}_evalBinaryOperationSync(t,r,a,n,i){const s=n.get(t);S(s);const o=this._evalSync(r,n,i);if(p(o))return o;const h=this._evalSync(a,n,i);return p(h)?h:this._fnSync(s,[o,h],i)}_eval(t,r,a){return this.__eval(t,r,a).catch(n=>{if(n.pos)throw n;{const i=n instanceof W?n:new Se(n);throw i.pos=t.loc.start,i.message=[i.message,...[...a,{pos:i.pos}].map(({pos:s},o)=>{const h=a[o-1]?.name??"<root>";return s?`  at ${h} (Line ${s.line}, Column ${s.column})`:`  at ${h}`}).reverse()].join(`
`),i}})}_evalSync(t,r,a){return this.__evalSync(t,r,a)}async __eval(t,r,a){if(this.stop)return g;if(this.pausing&&await this.pausing.promise,this.irqRate!==0&&this.stepCount%this.irqRate>=this.irqRate-1&&await this.irqSleep(),this.stepCount++,this.opts.maxStep&&this.stepCount>this.opts.maxStep)throw new v("max step exceeded");switch(t.type){case"call":{const n=await this._eval(t.target,r,a);if(p(n))return n;S(n);const i=[];for(const s of t.args){const o=await this._eval(s,r,a);if(p(o))return o;i.push(o)}return this._fn(n,i,a,t.loc.start)}case"if":{const n=await this._eval(t.cond,r,a);if(p(n))return n;if(E(n),n.value)return K(await this._evalClause(t.then,r,a),t.label);for(const i of t.elseif){const s=await this._eval(i.cond,r,a);if(p(s))return s;if(E(s),s.value)return K(await this._evalClause(i.then,r,a),t.label)}return t.else?K(await this._evalClause(t.else,r,a),t.label):g}case"match":{const n=await this._eval(t.about,r,a);if(p(n))return n;for(const i of t.qs){const s=await this._eval(i.q,r,a);if(p(s))return s;if(ee(n,s))return K(await this._evalClause(i.a,r,a),t.label)}return t.default?K(await this._evalClause(t.default,r,a),t.label):g}case"loop":{for(;;){const n=await this._run(t.statements,r.createChildScope(),a);if(n.type==="break"){if(n.label!=null&&n.label!==t.label)return n;break}else if(n.type==="continue"){if(n.label!=null&&n.label!==t.label)return n}else if(n.type==="return")return n}return g}case"for":{if(t.times){const n=await this._eval(t.times,r,a);if(p(n))return n;c(n);for(let i=0;i<n.value;i++){const s=await this._evalClause(t.for,r,a);if(s.type==="break"){if(s.label!=null&&s.label!==t.label)return s;break}else if(s.type==="continue"){if(s.label!=null&&s.label!==t.label)return s}else if(s.type==="return")return s}}else{const n=await this._eval(t.from,r,a);if(p(n))return n;const i=await this._eval(t.to,r,a);if(p(i))return i;c(n),c(i);for(let s=n.value;s<n.value+i.value;s++){const o=await this._eval(t.for,r.createChildScope(new Map([[t.var,{isMutable:!1,value:f(s)}]])),a);if(o.type==="break"){if(o.label!=null&&o.label!==t.label)return o;break}else if(o.type==="continue"){if(o.label!=null&&o.label!==t.label)return o}else if(o.type==="return")return o}}return g}case"each":{const n=await this._eval(t.items,r,a);if(p(n))return n;D(n);for(const i of n.value){const s=r.createChildScope();this.define(s,t.var,i,!1);const o=await this._eval(t.for,s,a);if(o.type==="break"){if(o.label!=null&&o.label!==t.label)return o;break}else if(o.type==="continue"){if(o.label!=null&&o.label!==t.label)return o}else if(o.type==="return")return o}return g}case"def":{const n=await this._eval(t.expr,r,a);if(p(n))return n;if(t.attr.length>0){const i=[];for(const s of t.attr){const o=await this._eval(s.value,r,a);ae(o),i.push({name:s.name,value:o})}n.attr=i}return t.expr.type==="fn"&&t.dest.type==="identifier"&&oe(n)&&!n.native&&(n.name=t.dest.name),this.define(r,t.dest,n,t.mut),g}case"identifier":return r.get(t.name);case"assign":{const n=await this.getReference(t.dest,r,a);if(p(n))return n;const i=await this._eval(t.expr,r,a);return p(i)?i:(n.set(i),g)}case"addAssign":{const n=await this.getReference(t.dest,r,a);if(p(n))return n;const i=await this._eval(t.expr,r,a);if(p(i))return i;c(i);const s=n.get();return c(s),n.set(f(s.value+i.value)),g}case"subAssign":{const n=await this.getReference(t.dest,r,a);if(p(n))return n;const i=await this._eval(t.expr,r,a);if(p(i))return i;c(i);const s=n.get();return c(s),n.set(f(s.value-i.value)),g}case"null":return g;case"bool":return T(t.value);case"num":return f(t.value);case"str":return b(t.value);case"arr":{const n=[];for(const i of t.value){const s=await this._eval(i,r,a);if(p(s))return s;n.push(s)}return C(n)}case"obj":{const n=new Map;for(const[i,s]of t.value){const o=await this._eval(s,r,a);if(p(o))return o;n.set(i,o)}return Q(n)}case"prop":{const n=await this._eval(t.target,r,a);return p(n)?n:X(n)?n.value.has(t.name)?n.value.get(t.name):g:Qe(n,t.name)}case"index":{const n=await this._eval(t.target,r,a);if(p(n))return n;const i=await this._eval(t.index,r,a);if(p(i))return i;if(k(n)){c(i);const s=n.value[i.value];if(s===void 0)throw new ve(`Index out of range. index: ${i.value} max: ${n.value.length-1}`);return s}else{if(X(n))return P(i),n.value.has(i.value)?n.value.get(i.value):g;throw new v(`Cannot read prop (${G(i)}) of ${n.type}.`)}}case"plus":{const n=await this._eval(t.expr,r,a);return p(n)||c(n),n}case"minus":{const n=await this._eval(t.expr,r,a);return p(n)?n:(c(n),f(-n.value))}case"not":{const n=await this._eval(t.expr,r,a);return p(n)?n:(E(n),T(!n.value))}case"fn":{const n=await Promise.all(t.params.map(async s=>({dest:s.dest,default:s.default?await this._eval(s.default,r,a):s.optional?g:void 0}))),i=n.map(s=>s.default).filter(s=>s!=null).find(p);return i??Ne(n,t.children,r)}case"block":return K(await this._run(t.statements,r.createChildScope(),a),t.label);case"exists":return T(r.exists(t.identifier.name));case"tmpl":{let n="";for(const i of t.tmpl)if(typeof i=="string")n+=i;else{const s=await this._eval(i,r,a);if(p(s))return s;n+=G(s)}return b(n)}case"return":{const n=await this._eval(t.expr,r,a);return p(n)?n:(this.log("block:return",{scope:r.name,val:n}),Ve(n))}case"break":{let n;if(t.expr!=null){const i=await this._eval(t.expr,r,a);if(p(i))return i;n=i}return this.log("block:break",{scope:r.name}),Fe(t.label,n)}case"continue":return this.log("block:continue",{scope:r.name}),Te(t.label);case"ns":return g;case"meta":return g;case"pow":return this._evalBinaryOperation("Core:pow",t.left,t.right,r,a);case"mul":return this._evalBinaryOperation("Core:mul",t.left,t.right,r,a);case"div":return this._evalBinaryOperation("Core:div",t.left,t.right,r,a);case"rem":return this._evalBinaryOperation("Core:mod",t.left,t.right,r,a);case"add":return this._evalBinaryOperation("Core:add",t.left,t.right,r,a);case"sub":return this._evalBinaryOperation("Core:sub",t.left,t.right,r,a);case"lt":return this._evalBinaryOperation("Core:lt",t.left,t.right,r,a);case"lteq":return this._evalBinaryOperation("Core:lteq",t.left,t.right,r,a);case"gt":return this._evalBinaryOperation("Core:gt",t.left,t.right,r,a);case"gteq":return this._evalBinaryOperation("Core:gteq",t.left,t.right,r,a);case"eq":return this._evalBinaryOperation("Core:eq",t.left,t.right,r,a);case"neq":return this._evalBinaryOperation("Core:neq",t.left,t.right,r,a);case"and":{const n=await this._eval(t.left,r,a);if(p(n))return n;if(E(n),n.value){const i=await this._eval(t.right,r,a);return p(i)||E(i),i}else return n}case"or":{const n=await this._eval(t.left,r,a);if(p(n)||(E(n),n.value))return n;{const i=await this._eval(t.right,r,a);return p(i)||E(i),i}}case"namedTypeSource":case"fnTypeSource":case"unionTypeSource":case"attr":throw new Error("invalid node type");default:throw new Error("invalid node type")}}__evalSync(t,r,a){if(this.stop)return g;if(this.stepCount++,this.opts.maxStep&&this.stepCount>this.opts.maxStep)throw new v("max step exceeded");switch(t.type){case"call":{const n=this._evalSync(t.target,r,a);if(p(n))return n;S(n);const i=[];for(const s of t.args){const o=this._evalSync(s,r,a);if(p(o))return o;i.push(o)}return this._fnSync(n,i,a,t.loc.start)}case"if":{const n=this._evalSync(t.cond,r,a);if(p(n))return n;if(E(n),n.value)return K(this._evalClauseSync(t.then,r,a),t.label);for(const i of t.elseif){const s=this._evalSync(i.cond,r,a);if(p(s))return s;if(E(s),s.value)return K(this._evalClauseSync(i.then,r,a),t.label)}return t.else?K(this._evalClauseSync(t.else,r,a),t.label):g}case"match":{const n=this._evalSync(t.about,r,a);if(p(n))return n;for(const i of t.qs){const s=this._evalSync(i.q,r,a);if(p(s))return s;if(ee(n,s))return K(this._evalClauseSync(i.a,r,a),t.label)}return t.default?K(this._evalClauseSync(t.default,r,a),t.label):g}case"loop":{for(;;){const n=this._runSync(t.statements,r.createChildScope(),a);if(n.type==="break"){if(n.label!=null&&n.label!==t.label)return n;break}else if(n.type==="continue"){if(n.label!=null&&n.label!==t.label)return n}else if(n.type==="return")return n}return g}case"for":{if(t.times){const n=this._evalSync(t.times,r,a);if(p(n))return n;c(n);for(let i=0;i<n.value;i++){const s=this._evalClauseSync(t.for,r,a);if(s.type==="break"){if(s.label!=null&&s.label!==t.label)return s;break}else if(s.type==="continue"){if(s.label!=null&&s.label!==t.label)return s}else if(s.type==="return")return s}}else{const n=this._evalSync(t.from,r,a);if(p(n))return n;const i=this._evalSync(t.to,r,a);if(p(i))return i;c(n),c(i);for(let s=n.value;s<n.value+i.value;s++){const o=this._evalSync(t.for,r.createChildScope(new Map([[t.var,{isMutable:!1,value:f(s)}]])),a);if(o.type==="break"){if(o.label!=null&&o.label!==t.label)return o;break}else if(o.type==="continue"){if(o.label!=null&&o.label!==t.label)return o}else if(o.type==="return")return o}}return g}case"each":{const n=this._evalSync(t.items,r,a);if(p(n))return n;D(n);for(const i of n.value){const s=r.createChildScope();this.define(s,t.var,i,!1);const o=this._evalSync(t.for,s,a);if(o.type==="break"){if(o.label!=null&&o.label!==t.label)return o;break}else if(o.type==="continue"){if(o.label!=null&&o.label!==t.label)return o}else if(o.type==="return")return o}return g}case"def":{const n=this._evalSync(t.expr,r,a);if(p(n))return n;if(t.attr.length>0){const i=[];for(const s of t.attr){const o=this._evalSync(s.value,r,a);ae(o),i.push({name:s.name,value:o})}n.attr=i}return t.expr.type==="fn"&&t.dest.type==="identifier"&&oe(n)&&!n.native&&(n.name=t.dest.name),this.define(r,t.dest,n,t.mut),g}case"identifier":return r.get(t.name);case"assign":{const n=this.getReferenceSync(t.dest,r,a);if(p(n))return n;const i=this._evalSync(t.expr,r,a);return p(i)?i:(n.set(i),g)}case"addAssign":{const n=this.getReferenceSync(t.dest,r,a);if(p(n))return n;const i=this._evalSync(t.expr,r,a);if(p(i))return i;c(i);const s=n.get();return c(s),n.set(f(s.value+i.value)),g}case"subAssign":{const n=this.getReferenceSync(t.dest,r,a);if(p(n))return n;const i=this._evalSync(t.expr,r,a);if(p(i))return i;c(i);const s=n.get();return c(s),n.set(f(s.value-i.value)),g}case"null":return g;case"bool":return T(t.value);case"num":return f(t.value);case"str":return b(t.value);case"arr":{const n=[];for(const i of t.value){const s=this._evalSync(i,r,a);if(p(s))return s;n.push(s)}return C(n)}case"obj":{const n=new Map;for(const[i,s]of t.value){const o=this._evalSync(s,r,a);if(p(o))return o;n.set(i,o)}return Q(n)}case"prop":{const n=this._evalSync(t.target,r,a);return p(n)?n:X(n)?n.value.has(t.name)?n.value.get(t.name):g:Qe(n,t.name)}case"index":{const n=this._evalSync(t.target,r,a);if(p(n))return n;const i=this._evalSync(t.index,r,a);if(p(i))return i;if(k(n)){c(i);const s=n.value[i.value];if(s===void 0)throw new ve(`Index out of range. index: ${i.value} max: ${n.value.length-1}`);return s}else{if(X(n))return P(i),n.value.has(i.value)?n.value.get(i.value):g;throw new v(`Cannot read prop (${G(i)}) of ${n.type}.`)}}case"plus":{const n=this._evalSync(t.expr,r,a);return p(n)||c(n),n}case"minus":{const n=this._evalSync(t.expr,r,a);return p(n)?n:(c(n),f(-n.value))}case"not":{const n=this._evalSync(t.expr,r,a);return p(n)?n:(E(n),T(!n.value))}case"fn":{const n=t.params.map(s=>({dest:s.dest,default:s.default?this._evalSync(s.default,r,a):s.optional?g:void 0})),i=n.map(s=>s.default).filter(s=>s!=null).find(p);return i??Ne(n,t.children,r)}case"block":return K(this._runSync(t.statements,r.createChildScope(),a),t.label);case"exists":return T(r.exists(t.identifier.name));case"tmpl":{let n="";for(const i of t.tmpl)if(typeof i=="string")n+=i;else{const s=this._evalSync(i,r,a);if(p(s))return s;n+=G(s)}return b(n)}case"return":{const n=this._evalSync(t.expr,r,a);return p(n)?n:(this.log("block:return",{scope:r.name,val:n}),Ve(n))}case"break":{let n;if(t.expr!=null){const i=this._evalSync(t.expr,r,a);if(p(i))return i;n=i}return this.log("block:break",{scope:r.name}),Fe(t.label,n)}case"continue":return this.log("block:continue",{scope:r.name}),Te(t.label);case"ns":return g;case"meta":return g;case"pow":return this._evalBinaryOperationSync("Core:pow",t.left,t.right,r,a);case"mul":return this._evalBinaryOperationSync("Core:mul",t.left,t.right,r,a);case"div":return this._evalBinaryOperationSync("Core:div",t.left,t.right,r,a);case"rem":return this._evalBinaryOperationSync("Core:mod",t.left,t.right,r,a);case"add":return this._evalBinaryOperationSync("Core:add",t.left,t.right,r,a);case"sub":return this._evalBinaryOperationSync("Core:sub",t.left,t.right,r,a);case"lt":return this._evalBinaryOperationSync("Core:lt",t.left,t.right,r,a);case"lteq":return this._evalBinaryOperationSync("Core:lteq",t.left,t.right,r,a);case"gt":return this._evalBinaryOperationSync("Core:gt",t.left,t.right,r,a);case"gteq":return this._evalBinaryOperationSync("Core:gteq",t.left,t.right,r,a);case"eq":return this._evalBinaryOperationSync("Core:eq",t.left,t.right,r,a);case"neq":return this._evalBinaryOperationSync("Core:neq",t.left,t.right,r,a);case"and":{const n=this._evalSync(t.left,r,a);if(p(n))return n;if(E(n),n.value){const i=this._evalSync(t.right,r,a);return p(i)||E(i),i}else return n}case"or":{const n=this._evalSync(t.left,r,a);if(p(n)||(E(n),n.value))return n;{const i=this._evalSync(t.right,r,a);return p(i)||E(i),i}}case"namedTypeSource":case"fnTypeSource":case"unionTypeSource":case"attr":throw new Error("invalid node type");default:throw new Error("invalid node type")}}async _run(t,r,a){this.log("block:enter",{scope:r.name});let n=g;for(let i=0;i<t.length;i++){const s=t[i];if(n=await this._eval(s,r,a),n.type==="return")return this.log("block:return",{scope:r.name,val:n.value}),n;if(n.type==="break")return this.log("block:break",{scope:r.name}),n;if(n.type==="continue")return this.log("block:continue",{scope:r.name}),n}return this.log("block:leave",{scope:r.name,val:n}),n}_runSync(t,r,a){this.log("block:enter",{scope:r.name});let n=g;for(let i=0;i<t.length;i++){const s=t[i];if(n=this._evalSync(s,r,a),n.type==="return")return this.log("block:return",{scope:r.name,val:n.value}),n;if(n.type==="break")return this.log("block:break",{scope:r.name}),n;if(n.type==="continue")return this.log("block:continue",{scope:r.name}),n}return this.log("block:leave",{scope:r.name,val:n}),n}registerAbortHandler(t){this.abortHandlers.push(t)}registerPauseHandler(t){this.pauseHandlers.push(t)}registerUnpauseHandler(t){this.unpauseHandlers.push(t)}unregisterAbortHandler(t){this.abortHandlers=this.abortHandlers.filter(r=>r!==t)}unregisterPauseHandler(t){this.pauseHandlers=this.pauseHandlers.filter(r=>r!==t)}unregisterUnpauseHandler(t){this.unpauseHandlers=this.unpauseHandlers.filter(r=>r!==t)}abort(){this.stop=!0;for(const t of this.abortHandlers)t();this.abortHandlers=[]}pause(){if(this.pausing)return;let t;const r=new Promise(a=>{t=()=>a()});this.pausing={promise:r,resolve:t};for(const a of this.pauseHandlers)a();this.pauseHandlers=[]}unpause(){if(this.pausing){this.pausing.resolve(),this.pausing=null;for(const t of this.unpauseHandlers)t();this.unpauseHandlers=[]}}define(t,r,a,n){switch(r.type){case"identifier":{t.add(r.name,{isMutable:n,value:a});break}case"arr":{D(a),r.value.map((i,s)=>this.define(t,i,a.value[s]??g,n));break}case"obj":{H(a),[...r.value].map(([i,s])=>this.define(t,s,a.value.get(i)??g,n));break}default:throw new v("The left-hand side of an definition expression must be a variable.")}}async getReference(t,r,a){switch(t.type){case"identifier":return V.variable(t.name,r);case"index":{const n=await this._eval(t.target,r,a);if(p(n))return n;const i=await this._eval(t.index,r,a);if(p(i))return i;if(k(n))return c(i),V.index(n,i.value);if(X(n))return P(i),V.prop(n,i.value);throw new v(`Cannot read prop (${G(i)}) of ${n.type}.`)}case"prop":{const n=await this._eval(t.target,r,a);return p(n)?n:(H(n),V.prop(n,t.name))}case"arr":{const n=[];for(const i of t.value){const s=await this.getReference(i,r,a);if(p(s))return s;n.push(s)}return V.arr(n)}case"obj":{const n=new Map;for(const[i,s]of t.value.entries()){const o=await this.getReference(s,r,a);if(p(o))return o;n.set(i,o)}return V.obj(n)}default:throw new v("The left-hand side of an assignment expression must be a variable or a property/index access.")}}getReferenceSync(t,r,a){switch(t.type){case"identifier":return V.variable(t.name,r);case"index":{const n=this._evalSync(t.target,r,a);if(p(n))return n;const i=this._evalSync(t.index,r,a);if(p(i))return i;if(k(n))return c(i),V.index(n,i.value);if(X(n))return P(i),V.prop(n,i.value);throw new v(`Cannot read prop (${G(i)}) of ${n.type}.`)}case"prop":{const n=this._evalSync(t.target,r,a);return p(n)?n:(H(n),V.prop(n,t.name))}case"arr":{const n=[];for(const i of t.value){const s=this.getReferenceSync(i,r,a);if(p(s))return s;n.push(s)}return V.arr(n)}case"obj":{const n=new Map;for(const[i,s]of t.value.entries()){const o=this.getReferenceSync(s,r,a);if(p(o))return o;n.set(i,o)}return V.obj(n)}default:throw new v("The left-hand side of an assignment expression must be a variable or a property/index access.")}}}x([m],_.prototype,"exec",null);x([m],_.prototype,"execSync",null);x([m],_.prototype,"execFn",null);x([m],_.prototype,"execFnSync",null);x([m],_.prototype,"execFnSimple",null);x([m],_.prototype,"handleError",null);x([m],_.prototype,"log",null);x([m],_.prototype,"collectNs",null);x([m],_.prototype,"collectNsSync",null);x([m],_.prototype,"collectNsMember",null);x([m],_.prototype,"collectNsMemberSync",null);x([m],_.prototype,"_fn",null);x([m],_.prototype,"_fnSync",null);x([m],_.prototype,"_evalClause",null);x([m],_.prototype,"_evalClauseSync",null);x([m],_.prototype,"_evalBinaryOperation",null);x([m],_.prototype,"_evalBinaryOperationSync",null);x([m],_.prototype,"_eval",null);x([m],_.prototype,"_evalSync",null);x([m],_.prototype,"__eval",null);x([m],_.prototype,"__evalSync",null);x([m],_.prototype,"_run",null);x([m],_.prototype,"_runSync",null);x([m],_.prototype,"registerAbortHandler",null);x([m],_.prototype,"registerPauseHandler",null);x([m],_.prototype,"registerUnpauseHandler",null);x([m],_.prototype,"unregisterAbortHandler",null);x([m],_.prototype,"unregisterPauseHandler",null);x([m],_.prototype,"unregisterUnpauseHandler",null);x([m],_.prototype,"abort",null);x([m],_.prototype,"pause",null);x([m],_.prototype,"unpause",null);x([m],_.prototype,"define",null);x([m],_.prototype,"getReference",null);x([m],_.prototype,"getReferenceSync",null);x([m],_,"collectMetadata",null);var u;(function(e){e[e.EOF=0]="EOF",e[e.NewLine=1]="NewLine",e[e.Identifier=2]="Identifier",e[e.NumberLiteral=3]="NumberLiteral",e[e.StringLiteral=4]="StringLiteral",e[e.Template=5]="Template",e[e.TemplateStringElement=6]="TemplateStringElement",e[e.TemplateExprElement=7]="TemplateExprElement",e[e.NullKeyword=8]="NullKeyword",e[e.TrueKeyword=9]="TrueKeyword",e[e.FalseKeyword=10]="FalseKeyword",e[e.EachKeyword=11]="EachKeyword",e[e.ForKeyword=12]="ForKeyword",e[e.LoopKeyword=13]="LoopKeyword",e[e.DoKeyword=14]="DoKeyword",e[e.WhileKeyword=15]="WhileKeyword",e[e.BreakKeyword=16]="BreakKeyword",e[e.ContinueKeyword=17]="ContinueKeyword",e[e.MatchKeyword=18]="MatchKeyword",e[e.CaseKeyword=19]="CaseKeyword",e[e.DefaultKeyword=20]="DefaultKeyword",e[e.IfKeyword=21]="IfKeyword",e[e.ElifKeyword=22]="ElifKeyword",e[e.ElseKeyword=23]="ElseKeyword",e[e.ReturnKeyword=24]="ReturnKeyword",e[e.EvalKeyword=25]="EvalKeyword",e[e.VarKeyword=26]="VarKeyword",e[e.LetKeyword=27]="LetKeyword",e[e.ExistsKeyword=28]="ExistsKeyword",e[e.Not=29]="Not",e[e.NotEq=30]="NotEq",e[e.Sharp=31]="Sharp",e[e.OpenSharpBracket=32]="OpenSharpBracket",e[e.Sharp3=33]="Sharp3",e[e.Percent=34]="Percent",e[e.And2=35]="And2",e[e.OpenParen=36]="OpenParen",e[e.CloseParen=37]="CloseParen",e[e.Asterisk=38]="Asterisk",e[e.Plus=39]="Plus",e[e.PlusEq=40]="PlusEq",e[e.Comma=41]="Comma",e[e.Minus=42]="Minus",e[e.MinusEq=43]="MinusEq",e[e.Dot=44]="Dot",e[e.Slash=45]="Slash",e[e.Colon=46]="Colon",e[e.Colon2=47]="Colon2",e[e.SemiColon=48]="SemiColon",e[e.Lt=49]="Lt",e[e.LtEq=50]="LtEq",e[e.Out=51]="Out",e[e.Eq=52]="Eq",e[e.Eq2=53]="Eq2",e[e.Arrow=54]="Arrow",e[e.Gt=55]="Gt",e[e.GtEq=56]="GtEq",e[e.Question=57]="Question",e[e.At=58]="At",e[e.OpenBracket=59]="OpenBracket",e[e.BackSlash=60]="BackSlash",e[e.CloseBracket=61]="CloseBracket",e[e.Hat=62]="Hat",e[e.OpenBrace=63]="OpenBrace",e[e.Or=64]="Or",e[e.Or2=65]="Or2",e[e.CloseBrace=66]="CloseBrace"})(u||(u={}));class Yt{kind;pos;hasLeftSpacing;value;children;constructor(t,r,a=!1,n,i){this.kind=t,this.pos=r,this.hasLeftSpacing=a,this.value=n,this.children=i}}function Ee(e,t,r){return new Yt(e,t,r?.hasLeftSpacing,r?.value,r?.children)}const Zt=[u.NullKeyword,u.TrueKeyword,u.FalseKeyword,u.EachKeyword,u.ForKeyword,u.LoopKeyword,u.DoKeyword,u.WhileKeyword,u.BreakKeyword,u.ContinueKeyword,u.MatchKeyword,u.CaseKeyword,u.DefaultKeyword,u.IfKeyword,u.ElifKeyword,u.ElseKeyword,u.ReturnKeyword,u.EvalKeyword,u.VarKeyword,u.LetKeyword,u.ExistsKeyword];function Xt(e){return Zt.includes(e)}function er(e){switch(e){case u.NullKeyword:return"null";case u.TrueKeyword:return"true";case u.FalseKeyword:return"false";case u.EachKeyword:return"each";case u.ForKeyword:return"for";case u.LoopKeyword:return"loop";case u.DoKeyword:return"do";case u.WhileKeyword:return"while";case u.BreakKeyword:return"break";case u.ContinueKeyword:return"continue";case u.MatchKeyword:return"match";case u.CaseKeyword:return"case";case u.DefaultKeyword:return"default";case u.IfKeyword:return"if";case u.ElifKeyword:return"elif";case u.ElseKeyword:return"else";case u.ReturnKeyword:return"return";case u.EvalKeyword:return"eval";case u.VarKeyword:return"var";case u.LetKeyword:return"let";case u.ExistsKeyword:return"exists";default:{const t=e;throw new TypeError(`Unknown keyword token kind ${t}`)}}}function y(e,t,r,a){const n={type:e};for(const i of Object.keys(t))t[i]!==void 0&&(n[i]=t[i]);return n.loc={start:r,end:a},n}function tr(e,t,r,a){return y("call",{target:y("identifier",{name:e},r,r),args:t},r,a)}function Y(e,t,r){return e===u.EOF?new te(t,r):new U(`unexpected token: ${u[e]}`,t,r)}class rr{source;index;_token;constructor(t){this.source=t,this.index=0,this.load()}get eof(){return this.index>=this.source.length}getToken(){return this.eof?Ee(u.EOF,{line:-1,column:-1}):this._token}is(t){return this.getTokenKind()===t}getTokenValue(){return this.getToken().value}getTokenKind(){return this.getToken().kind}getPos(){return this.getToken().pos}next(){this.eof||this.index++,this.load()}lookahead(t){return this.index+t<this.source.length?this.source[this.index+t]:Ee(u.EOF,{line:-1,column:-1})}expect(t){if(!this.is(t))throw Y(this.getTokenKind(),this.getPos())}load(){this.eof?this._token=Ee(u.EOF,{line:-1,column:-1}):this._token=this.source[this.index]}}function se(e){return nr(e)}function Le(e){e.expect(u.Lt),e.next(),e.is(u.NewLine)&&e.next();const t=[ke(e)];for(;le(e)&&!e.is(u.Gt);){const r=ke(e);t.push(r)}return e.expect(u.Gt),e.next(),t}function ke(e){e.expect(u.Identifier);const t=e.getTokenValue();return e.next(),{name:t}}function nr(e){const t=e.getPos(),r=Ye(e);if(!e.is(u.Or))return r;const a=[r];do e.next(),a.push(Ye(e));while(e.is(u.Or));return y("unionTypeSource",{inners:a},t,e.getPos())}function Ye(e){return e.is(u.At)?ar(e):ir(e)}function ar(e){const t=e.getPos();e.expect(u.At),e.next();let r;e.is(u.Lt)?r=Le(e):r=[],e.expect(u.OpenParen),e.next();const a=[];for(;!e.is(u.CloseParen);){if(a.length>0)switch(e.getTokenKind()){case u.Comma:{e.next();break}case u.EOF:throw new te(e.getPos());default:throw new U("separator expected",e.getPos())}const i=se(e);a.push(i)}e.expect(u.CloseParen),e.next(),e.expect(u.Arrow),e.next();const n=se(e);return y("fnTypeSource",{typeParams:r,params:a,result:n},t,e.getPos())}function ir(e){const t=e.getPos();let r;e.is(u.Identifier)?(r=e.getTokenValue(),e.next()):(e.expect(u.NullKeyword),e.next(),r="null");let a;return e.is(u.Lt)&&(e.next(),a=se(e),e.expect(u.Gt),e.next()),y("namedTypeSource",{name:r,inner:a},t,e.getPos())}function M(e,t){return t?ot(e,!0):Ie(e,0)}const Me=[{opKind:"postfix",kind:u.OpenParen,bp:20},{opKind:"postfix",kind:u.OpenBracket,bp:20},{opKind:"infix",kind:u.Dot,lbp:18,rbp:19},{opKind:"infix",kind:u.Hat,lbp:17,rbp:16},{opKind:"prefix",kind:u.Plus,bp:14},{opKind:"prefix",kind:u.Minus,bp:14},{opKind:"prefix",kind:u.Not,bp:14},{opKind:"infix",kind:u.Asterisk,lbp:12,rbp:13},{opKind:"infix",kind:u.Slash,lbp:12,rbp:13},{opKind:"infix",kind:u.Percent,lbp:12,rbp:13},{opKind:"infix",kind:u.Plus,lbp:10,rbp:11},{opKind:"infix",kind:u.Minus,lbp:10,rbp:11},{opKind:"infix",kind:u.Lt,lbp:8,rbp:9},{opKind:"infix",kind:u.LtEq,lbp:8,rbp:9},{opKind:"infix",kind:u.Gt,lbp:8,rbp:9},{opKind:"infix",kind:u.GtEq,lbp:8,rbp:9},{opKind:"infix",kind:u.Eq2,lbp:6,rbp:7},{opKind:"infix",kind:u.NotEq,lbp:6,rbp:7},{opKind:"infix",kind:u.And2,lbp:4,rbp:5},{opKind:"infix",kind:u.Or2,lbp:2,rbp:3}];function sr(e,t){const r=e.getPos(),a=e.getTokenKind();e.next(),e.is(u.BackSlash)&&(e.next(),e.expect(u.NewLine),e.next());const n=Ie(e,t),i=n.loc.end;switch(a){case u.Plus:return n.type==="num"?y("num",{value:n.value},r,i):y("plus",{expr:n},r,i);case u.Minus:return n.type==="num"?y("num",{value:-1*n.value},r,i):y("minus",{expr:n},r,i);case u.Not:return y("not",{expr:n},r,i);default:throw Y(a,r)}}function ur(e,t,r){const a=e.getPos(),n=e.getTokenKind();if(e.next(),e.is(u.BackSlash)&&(e.next(),e.expect(u.NewLine),e.next()),n===u.Dot){const i=ct(e);return e.next(),y("prop",{target:t,name:i},a,e.getPos())}else{const i=Ie(e,r),s=e.getPos();switch(n){case u.Hat:return y("pow",{left:t,right:i},a,s);case u.Asterisk:return y("mul",{left:t,right:i},a,s);case u.Slash:return y("div",{left:t,right:i},a,s);case u.Percent:return y("rem",{left:t,right:i},a,s);case u.Plus:return y("add",{left:t,right:i},a,s);case u.Minus:return y("sub",{left:t,right:i},a,s);case u.Lt:return y("lt",{left:t,right:i},a,s);case u.LtEq:return y("lteq",{left:t,right:i},a,s);case u.Gt:return y("gt",{left:t,right:i},a,s);case u.GtEq:return y("gteq",{left:t,right:i},a,s);case u.Eq2:return y("eq",{left:t,right:i},a,s);case u.NotEq:return y("neq",{left:t,right:i},a,s);case u.And2:return y("and",{left:t,right:i},a,s);case u.Or2:return y("or",{left:t,right:i},a,s);default:throw Y(n,a)}}}function or(e,t){const r=e.getPos(),a=e.getTokenKind();switch(a){case u.OpenParen:return lr(e,t);case u.OpenBracket:{e.next();const n=M(e,!1);return e.expect(u.CloseBracket),e.next(),y("index",{target:t,index:n},r,e.getPos())}default:throw Y(a,r)}}function ot(e,t){const r=e.getPos();switch(e.getTokenKind()){case u.IfKeyword:{if(t)break;return fr(e)}case u.At:{if(t)break;return hr(e)}case u.MatchKeyword:{if(t)break;return pr(e)}case u.EvalKeyword:{if(t)break;return gr(e)}case u.ExistsKeyword:{if(t)break;return yr(e)}case u.Template:{const a=[];if(t)break;for(const[n,i]of e.getToken().children.entries())switch(i.kind){case u.TemplateStringElement:{const s=e.getToken().children[n+1]??e.lookahead(1);a.push(y("str",{value:i.value},i.pos,s.pos));break}case u.TemplateExprElement:{const s=new rr(i.children);s.is(u.NewLine)&&s.next();const o=M(s,!1);s.is(u.NewLine)&&s.next(),s.expect(u.EOF),a.push(o);break}default:throw Y(i.kind,i.pos)}return e.next(),y("tmpl",{tmpl:a},r,e.getPos())}case u.StringLiteral:{const a=e.getTokenValue();return e.next(),y("str",{value:a},r,e.getPos())}case u.NumberLiteral:{const a=Number(e.getTokenValue());return e.next(),y("num",{value:a},r,e.getPos())}case u.TrueKeyword:case u.FalseKeyword:{const a=e.is(u.TrueKeyword);return e.next(),y("bool",{value:a},r,e.getPos())}case u.NullKeyword:return e.next(),y("null",{},r,e.getPos());case u.OpenBrace:return wr(e,t);case u.OpenBracket:return vr(e,t);case u.Identifier:{if(t)break;return lt(e)}case u.OpenParen:{e.next();const a=M(e,t);return e.expect(u.CloseParen),e.next(),a}case u.Sharp:return cr(e)}throw Y(e.getTokenKind(),r)}function lr(e,t){const r=e.getPos(),a=[];for(e.expect(u.OpenParen),e.next(),e.is(u.NewLine)&&e.next();!e.is(u.CloseParen);)switch(a.push(M(e,!1)),e.getTokenKind()){case u.NewLine:{e.next();break}case u.Comma:{e.next(),e.is(u.NewLine)&&e.next();break}case u.CloseParen:break;case u.EOF:throw new te(e.getPos());default:throw new U("separator expected",e.getPos())}return e.expect(u.CloseParen),e.next(),y("call",{target:t,args:a},r,e.getPos())}function cr(e){const t=be(e);e.expect(u.Colon),e.next();const r=M(e,!1);switch(r.type){case"if":case"match":case"block":return r.label=t,r;default:throw new U("cannot use label for expression other than eval / if / match",r.loc.start)}}function fr(e){const t=e.getPos();e.expect(u.IfKeyword),e.next();const r=M(e,!1),a=z(e);e.is(u.NewLine)&&[u.ElifKeyword,u.ElseKeyword].includes(e.lookahead(1).kind)&&e.next();const n=[];for(;e.is(u.ElifKeyword);){e.next();const s=M(e,!1),o=z(e);e.is(u.NewLine)&&[u.ElifKeyword,u.ElseKeyword].includes(e.lookahead(1).kind)&&e.next(),n.push({cond:s,then:o})}let i;return e.is(u.ElseKeyword)&&(e.next(),i=z(e)),y("if",{cond:r,then:a,elseif:n,else:i},t,e.getPos())}function hr(e){const t=e.getPos();e.expect(u.At),e.next();let r;e.is(u.Lt)?r=Le(e):r=[];const a=ft(e);let n;e.is(u.Colon)&&(e.next(),n=se(e));const i=he(e);return y("fn",{typeParams:r,params:a,retType:n,children:i},t,e.getPos())}function pr(e){const t=e.getPos();e.expect(u.MatchKeyword),e.next();const r=M(e,!1);e.expect(u.OpenBrace),e.next(),e.is(u.NewLine)&&e.next();const a=[];let n;if(e.is(u.CaseKeyword)){a.push(Ze(e));let i=le(e);for(;e.is(u.CaseKeyword);){if(!i)throw new U("separator expected",e.getPos());a.push(Ze(e)),i=le(e)}if(e.is(u.DefaultKeyword)){if(!i)throw new U("separator expected",e.getPos());n=Xe(e),le(e)}}else e.is(u.DefaultKeyword)&&(n=Xe(e),le(e));return e.expect(u.CloseBrace),e.next(),y("match",{about:r,qs:a,default:n},t,e.getPos())}function Ze(e){e.expect(u.CaseKeyword),e.next();const t=M(e,!1);e.expect(u.Arrow),e.next();const r=z(e);return{q:t,a:r}}function Xe(e){return e.expect(u.DefaultKeyword),e.next(),e.expect(u.Arrow),e.next(),z(e)}function gr(e){const t=e.getPos();e.expect(u.EvalKeyword),e.next();const r=he(e);return y("block",{statements:r},t,e.getPos())}function yr(e){const t=e.getPos();e.expect(u.ExistsKeyword),e.next();const r=lt(e);return y("exists",{identifier:r},t,e.getPos())}function lt(e){const t=e.getPos(),r=[];for(;;){if(r.length>0)if(e.is(u.Colon)){if(e.getToken().hasLeftSpacing)throw new U("Cannot use spaces in a reference.",e.getPos());if(e.next(),e.getToken().hasLeftSpacing)throw new U("Cannot use spaces in a reference.",e.getPos())}else break;e.expect(u.Identifier),r.push(e.getTokenValue()),e.next()}return y("identifier",{name:r.join(":")},t,e.getPos())}function wr(e,t){const r=e.getPos();for(e.expect(u.OpenBrace),e.next();e.is(u.NewLine);)e.next();const a=new Map;for(;!e.is(u.CloseBrace);){const n=ct(e);e.next(),e.expect(u.Colon),e.next();const i=M(e,t);switch(a.set(n,i),e.getTokenKind()){case u.NewLine:case u.Comma:{for(e.next();e.is(u.NewLine);)e.next();break}case u.CloseBrace:break;case u.EOF:throw new te(e.getPos());default:throw new U("separator expected",e.getPos())}}return e.expect(u.CloseBrace),e.next(),y("obj",{value:a},r,e.getPos())}function ct(e){const t=e.getTokenKind();if(t===u.Identifier||t===u.StringLiteral)return e.getTokenValue();if(Xt(t))return er(t);throw Y(t,e.getPos())}function vr(e,t){const r=e.getPos();for(e.expect(u.OpenBracket),e.next();e.is(u.NewLine);)e.next();const a=[];for(;!e.is(u.CloseBracket);)switch(a.push(M(e,t)),e.getTokenKind()){case u.NewLine:case u.Comma:{for(e.next();e.is(u.NewLine);)e.next();break}case u.CloseBracket:break;case u.EOF:throw new te(e.getPos());default:throw new U("separator expected",e.getPos())}return e.expect(u.CloseBracket),e.next(),y("arr",{value:a},r,e.getPos())}function Ie(e,t){let r;const a=e.getTokenKind(),n=Me.find(i=>i.opKind==="prefix"&&i.kind===a);for(n!=null?r=sr(e,n.bp):r=ot(e,!1);;){e.is(u.BackSlash)&&(e.next(),e.expect(u.NewLine),e.next());const i=e.getTokenKind(),s=Me.find(h=>h.opKind==="postfix"&&h.kind===i);if(s!=null){if(s.bp<t)break;if(!([u.OpenBracket,u.OpenParen].includes(i)&&e.getToken().hasLeftSpacing)){r=or(e,r);continue}}const o=Me.find(h=>h.opKind==="infix"&&h.kind===i);if(o!=null){if(o.lbp<t)break;r=ur(e,r,o.rbp);continue}break}return r}function He(e){if(e.is(u.Identifier)){const t=e.getPos(),r=e.getTokenValue();return e.next(),y("identifier",{name:r},t,e.getPos())}else return M(e,!1)}function ft(e){const t=[];for(e.expect(u.OpenParen),e.next(),e.is(u.NewLine)&&e.next();!e.is(u.CloseParen);){const r=He(e);let a=!1,n;e.is(u.Question)?(e.next(),a=!0):e.is(u.Eq)&&(e.next(),n=M(e,!1));let i;switch(e.is(u.Colon)&&(e.next(),i=se(e)),t.push({dest:r,optional:a,default:n,argType:i}),e.getTokenKind()){case u.NewLine:{e.next();break}case u.Comma:{e.next(),e.is(u.NewLine)&&e.next();break}case u.CloseParen:break;case u.EOF:throw new te(e.getPos());default:throw new U("separator expected",e.getPos())}}return e.expect(u.CloseParen),e.next(),t}function he(e){for(e.expect(u.OpenBrace),e.next();e.is(u.NewLine);)e.next();const t=[];for(;!e.is(u.CloseBrace);)switch(t.push(xe(e)),e.getTokenKind()){case u.NewLine:case u.SemiColon:{for(;e.is(u.NewLine)||e.is(u.SemiColon);)e.next();break}case u.CloseBrace:break;case u.EOF:throw new te(e.getPos());default:throw new U("Multiple statements cannot be placed on a single line.",e.getPos())}return e.expect(u.CloseBrace),e.next(),t}function be(e){if(e.expect(u.Sharp),e.next(),e.getToken().hasLeftSpacing)throw new U("cannot use spaces in a label",e.getPos());e.expect(u.Identifier);const t=e.getTokenValue();return e.next(),t}function le(e){switch(e.getTokenKind()){case u.NewLine:return e.next(),!0;case u.Comma:return e.next(),e.is(u.NewLine)&&e.next(),!0;default:return!1}}function xe(e){switch(e.getPos(),e.getTokenKind()){case u.VarKeyword:case u.LetKeyword:return ht(e);case u.At:{if(e.lookahead(1).kind===u.Identifier)return pt(e);break}case u.Out:return dr(e);case u.ReturnKeyword:return _r(e);case u.OpenSharpBracket:return Pr(e);case u.Sharp:return mr(e);case u.EachKeyword:return br(e);case u.ForKeyword:return xr(e);case u.LoopKeyword:return Br(e);case u.DoKeyword:return Er(e);case u.WhileKeyword:return Mr(e);case u.BreakKeyword:return Sr(e);case u.ContinueKeyword:return Or(e)}const t=M(e,!1),r=Ar(e,t);return r||t}function qr(e){switch(e.getTokenKind()){case u.VarKeyword:case u.LetKeyword:return ht(e);case u.At:return pt(e);default:throw Y(e.getTokenKind(),e.getPos())}}function z(e){if(e.is(u.OpenBrace)){const t=e.getPos(),r=he(e);return y("block",{statements:r},t,e.getPos())}else return xe(e)}function ht(e){const t=e.getPos();let r;switch(e.getTokenKind()){case u.LetKeyword:{r=!1;break}case u.VarKeyword:{r=!0;break}default:throw Y(e.getTokenKind(),e.getPos())}e.next();const a=He(e);let n;e.is(u.Colon)&&(e.next(),n=se(e)),e.expect(u.Eq),e.next(),e.is(u.NewLine)&&e.next();const i=M(e,!1);return y("def",{dest:a,varType:n,expr:i,mut:r,attr:[]},t,e.getPos())}function pt(e){const t=e.getPos();e.expect(u.At),e.next(),e.expect(u.Identifier);const r=e.getPos(),a=e.getTokenValue();e.next();const n=y("identifier",{name:a},r,e.getPos());let i;e.is(u.Lt)?i=Le(e):i=[];const s=ft(e);let o;e.is(u.Colon)&&(e.next(),o=se(e));const h=he(e),w=e.getPos();return y("def",{dest:n,expr:y("fn",{typeParams:i,params:s,retType:o,children:h},t,w),mut:!1,attr:[]},t,w)}function dr(e){const t=e.getPos();e.expect(u.Out),e.next();const r=M(e,!1);return tr("print",[r],t,e.getPos())}function mr(e){const t=be(e);e.expect(u.Colon),e.next();const r=xe(e);switch(r.type){case"if":case"match":case"block":case"each":case"for":case"loop":return r.label=t,r;default:throw new U("cannot use label for statement other than eval / if / match / for / each / while / do-while / loop",r.loc.start)}}function br(e){const t=e.getPos();let r=!1;e.expect(u.EachKeyword),e.next(),e.is(u.OpenParen)&&(r=!0,e.next()),e.expect(u.LetKeyword),e.next();const a=He(e);if(e.is(u.Comma))e.next();else throw new U("separator expected",e.getPos());const n=M(e,!1);r&&(e.expect(u.CloseParen),e.next());const i=z(e);return y("each",{var:a,items:n,for:i},t,e.getPos())}function xr(e){const t=e.getPos();let r=!1;if(e.expect(u.ForKeyword),e.next(),e.is(u.OpenParen)&&(r=!0,e.next()),e.is(u.LetKeyword)){e.next();const a=e.getPos();e.expect(u.Identifier);const n=e.getTokenValue();e.next();let i;if(e.is(u.Eq)?(e.next(),i=M(e,!1)):i=y("num",{value:0},a,a),e.is(u.Comma))e.next();else throw new U("separator expected",e.getPos());const s=M(e,!1);r&&(e.expect(u.CloseParen),e.next());const o=z(e);return y("for",{var:n,from:i,to:s,for:o},t,e.getPos())}else{const a=M(e,!1);r&&(e.expect(u.CloseParen),e.next());const n=z(e);return y("for",{times:a,for:n},t,e.getPos())}}function _r(e){const t=e.getPos();e.expect(u.ReturnKeyword),e.next();const r=M(e,!1);return y("return",{expr:r},t,e.getPos())}function Pr(e){const t=[];for(;e.is(u.OpenSharpBracket);)t.push(Cr(e)),e.expect(u.NewLine),e.next();const r=xe(e);if(r.type!=="def")throw new U("invalid attribute.",r.loc.start);return r.attr!=null?r.attr.push(...t):r.attr=t,r}function Cr(e){const t=e.getPos();e.expect(u.OpenSharpBracket),e.next(),e.expect(u.Identifier);const r=e.getTokenValue();e.next();let a;if(!e.is(u.CloseBracket))a=M(e,!0);else{const n=e.getPos();a=y("bool",{value:!0},n,n)}return e.expect(u.CloseBracket),e.next(),y("attr",{name:r,value:a},t,e.getPos())}function Br(e){const t=e.getPos();e.expect(u.LoopKeyword),e.next();const r=he(e);return y("loop",{statements:r},t,e.getPos())}function Er(e){const t=e.getPos();e.expect(u.DoKeyword),e.next();const r=z(e),a=e.getPos();e.expect(u.WhileKeyword),e.next();const n=M(e,!1),i=e.getPos();return y("loop",{statements:[r,y("if",{cond:y("not",{expr:n},a,i),then:y("break",{},i,i),elseif:[]},a,i)]},t,i)}function Mr(e){const t=e.getPos();e.expect(u.WhileKeyword),e.next();const r=M(e,!1),a=e.getPos(),n=z(e);return y("loop",{statements:[y("if",{cond:y("not",{expr:r},t,a),then:y("break",{},a,a),elseif:[]},t,a),n]},t,e.getPos())}function Sr(e){const t=e.getPos();e.expect(u.BreakKeyword),e.next();let r,a;if(e.is(u.Sharp)){if(r=be(e),e.is(u.Colon))throw new U("cannot omit label from break if expression is given",t);Nr(e)||(a=M(e,!1))}return y("break",{label:r,expr:a},t,e.getPos())}function Or(e){const t=e.getPos();e.expect(u.ContinueKeyword),e.next();let r;return e.is(u.Sharp)&&(r=be(e)),y("continue",{label:r},t,e.getPos())}function Ar(e,t){const r=e.getPos();switch(e.getTokenKind()){case u.Eq:{e.next();const a=M(e,!1);return y("assign",{dest:t,expr:a},r,e.getPos())}case u.PlusEq:{e.next();const a=M(e,!1);return y("addAssign",{dest:t,expr:a},r,e.getPos())}case u.MinusEq:{e.next();const a=M(e,!1);return y("subAssign",{dest:t,expr:a},r,e.getPos())}default:return}}function Nr(e){switch(e.getTokenKind()){case u.EOF:case u.NewLine:case u.WhileKeyword:case u.ElifKeyword:case u.ElseKeyword:case u.Comma:case u.SemiColon:case u.CloseBrace:return!0;default:return!1}}export{U as A,Dr as B,Hr as C,Lr as D,ce as E,l as F,Ir as G,At as H,_ as I,St as J,ue as K,y as N,Q as O,b as S,u as T,Ee as a,te as b,M as c,Pr as d,qr as e,P as f,v as g,g as h,L as i,me as j,it as k,H as l,nt as m,Mt as n,N as o,xe as p,A as q,st as r,D as s,E as t,Y as u,de as v,S as w,c as x,Ae as y,q as z};
