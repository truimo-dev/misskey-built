import{Q as T}from"./3iSoGi4ic-C_KRNUC8.js";import{u as M}from"./3iSoGi4ic-B1GPmOGN.js";import{d as w,I as E}from"./3iSoGi4ic-BmLZI3Ia.js";import{Q as y}from"./3iSoGi4ic-DV-GuiCp.js";import"./3iSoGi4ic-D0mTJ0Mu.js";import"./3iSoGi4ic-Dty8GuTz.js";import"./3iSoGi4ic-D98_HDRS.js";var B=`#version 300 es
precision mediump float;in vec2 in_uv;uniform sampler2D in_texture;uniform vec2 in_resolution;uniform sampler2D u_image;uniform sampler2D u_topLabel;uniform sampler2D u_bottomLabel;uniform bool u_topLabelEnabled;uniform bool u_bottomLabelEnabled;uniform float u_paddingTop;uniform float u_paddingBottom;uniform float u_paddingLeft;uniform float u_paddingRight;uniform vec3 u_bg;out vec4 out_color;float remap(float value,float inputMin,float inputMax,float outputMin,float outputMax){return outputMin+(outputMax-outputMin)*((value - inputMin)/(inputMax - inputMin));}vec3 blendAlpha(vec3 bg,vec4 fg){return fg.a*fg.rgb+(1.0-fg.a)*bg;}void main(){vec4 bg=vec4(u_bg,1.0);vec4 image_color=texture(u_image,vec2(remap(in_uv.x,u_paddingLeft,1.0-u_paddingRight,0.0,1.0),remap(in_uv.y,u_paddingTop,1.0-u_paddingBottom,0.0,1.0)));vec4 topLabel_color=u_topLabelEnabled ? texture(u_topLabel,vec2(in_uv.x,remap(in_uv.y,0.0,u_paddingTop,0.0,1.0))): bg;vec4 bottomLabel_color=u_bottomLabelEnabled ? texture(u_bottomLabel,vec2(in_uv.x,remap(in_uv.y,1.0-u_paddingBottom,1.0,0.0,1.0))): bg;if(in_uv.y<u_paddingTop){out_color=vec4(blendAlpha(bg.rgb,topLabel_color),1.0);}else if(in_uv.y>(1.0-u_paddingBottom)){out_color=vec4(blendAlpha(bg.rgb,bottomLabel_color),1.0);}else{if(in_uv.y>u_paddingTop&&in_uv.x>u_paddingLeft&&in_uv.x<(1.0-u_paddingRight)){out_color=image_color;}else{out_color=bg;}}}`;const R=w({shader:B,main:({gl:o,u:e,params:i,textures:n})=>{if(i.image==null)return;const c=n.get(i.image);if(c!=null){if(o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,c.texture),o.uniform1i(e.image,1),o.uniform1i(e.topLabelEnabled,i.topLabelEnabled?1:0),o.uniform1i(e.bottomLabelEnabled,i.bottomLabelEnabled?1:0),o.uniform1f(e.paddingTop,i.paddingTop),o.uniform1f(e.paddingBottom,i.paddingBottom),o.uniform1f(e.paddingLeft,i.paddingLeft),o.uniform1f(e.paddingRight,i.paddingRight),o.uniform3f(e.bg,i.bg[0],i.bg[1],i.bg[2]),i.topLabelEnabled&&i.topLabel!=null){const r=n.get(i.topLabel);r&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,r.texture),o.uniform1i(e.topLabel,2))}if(i.bottomLabelEnabled&&i.bottomLabel!=null){const r=n.get(i.bottomLabel);r&&(o.activeTexture(o.TEXTURE3),o.bindTexture(o.TEXTURE_2D,r.texture),o.uniform1i(e.bottomLabel,3))}}}}),A=y();class P{compositor;image;exif;caption=null;filename=null;renderAsPreview=!1;constructor(e){this.image=e.image,this.exif=e.exif,this.caption=e.caption??null,this.filename=e.filename??null,this.renderAsPreview=e.renderAsPreview??!1,this.compositor=new E({canvas:e.canvas,renderWidth:1,renderHeight:1,image:null,functions:{frame:R}}),this.compositor.registerTexture("image",this.image)}interpolateTemplateText(e){const i=this.exif==null?"2012:03:04 5:06:07":this.exif.DateTimeOriginal?.description,n=this.exif==null?"Example camera":this.exif.Model?.description,c=this.exif==null?"Example lens 123mm f/1.23":this.exif.LensModel?.description,r=this.exif==null?"123mm":this.exif.FocalLength?.description,l=this.exif==null?"123mm":this.exif.FocalLengthIn35mmFilm?.description,p=this.exif==null?"1/234":this.exif.ExposureTime?.description,a=this.exif==null?"1.23":this.exif.FNumber?.description,f=this.exif==null?"123":this.exif.ISOSpeedRatings?.description,t=this.exif==null?"123.000000000000123":this.exif.GPSLatitude?.description,m=this.exif==null?"456.000000000000123":this.exif.GPSLongitude?.description;return e.replaceAll(/\{(\w+)\}/g,(d,h)=>{const u=i??"????:??:?? ??:??:??",s=u.split(" ")[0].replaceAll(":","/");switch(h){case"caption":return this.caption??"?";case"filename":return this.filename??"?";case"filename_without_ext":return this.filename?.replace(/\.[^/.]+$/,"")??"?";case"year":return s.split("/")[0];case"month":return s.split("/")[1].replace(/^0/,"");case"day":return s.split("/")[2].replace(/^0/,"");case"hour":return u.split(" ")[1].split(":")[0].replace(/^0/,"");case"minute":return u.split(" ")[1].split(":")[1].replace(/^0/,"");case"second":return u.split(" ")[1].split(":")[2].replace(/^0/,"");case"0month":return s.split("/")[1];case"0day":return s.split("/")[2];case"0hour":return u.split(" ")[1].split(":")[0];case"0minute":return u.split(" ")[1].split(":")[1];case"0second":return u.split(" ")[1].split(":")[2];case"camera_model":return n??"?";case"camera_lens_model":return c??"?";case"camera_mm":return r?.replace(" mm","").replace("mm","")??"?";case"camera_mm_35":return l?.replace(" mm","").replace("mm","")??"?";case"camera_f":return a?.replace("f/","")??"?";case"camera_s":return p??"?";case"camera_iso":return f??"?";case"gps_lat":return t??"?";case"gps_long":return m??"?";default:return"?"}})}async renderLabel(e,i,n,c,r,l,p,a){const f=r*a.scale,t=window.document.createElement("canvas").getContext("2d");t.canvas.width=e,t.canvas.height=i;const m=f/30,d=Math.max(m*2,n),h=d,u=a.withQrCode,s=f*.1,g=Math.max((t.canvas.height-s)/2,c);t.fillStyle=`rgb(${Math.floor(l[0]*255)}, ${Math.floor(l[1]*255)}, ${Math.floor(l[2]*255)})`,t.font=`bold ${m}px ${p}`,t.textBaseline="middle";const b=a.textSmall===""?t.canvas.height/2:t.canvas.height/2-m*.9;a.centered?(t.textAlign="center",t.fillText(this.interpolateTemplateText(a.textBig),t.canvas.width/2,b,t.canvas.width-d-h)):(t.textAlign="left",t.fillText(this.interpolateTemplateText(a.textBig),d,b,t.canvas.width-d-(u?s+g+m*1:h))),t.fillStyle=`rgba(${Math.floor(l[0]*255)}, ${Math.floor(l[1]*255)}, ${Math.floor(l[2]*255)}, 0.5)`,t.font=`${m*.85}px ${p}`,t.textBaseline="middle";const x=a.textBig===""?t.canvas.height/2:t.canvas.height/2+m*.9;if(a.centered?(t.textAlign="center",t.fillText(this.interpolateTemplateText(a.textSmall),t.canvas.width/2,x,t.canvas.width-d-h)):(t.textAlign="left",t.fillText(this.interpolateTemplateText(a.textSmall),d,x,t.canvas.width-d-(u?s+g+m*1:h))),u)try{const _=await new T({width:t.canvas.height,height:t.canvas.height,margin:0,type:"canvas",data:`${M}/users/${A.id}`,qrOptions:{typeNumber:0,mode:"Byte",errorCorrectionLevel:"H"},imageOptions:{hideBackgroundDots:!0,imageSize:.3,margin:16,crossOrigin:"anonymous"},dotsOptions:{type:"dots",roundSize:!1,color:`rgb(${Math.floor(l[0]*255)}, ${Math.floor(l[1]*255)}, ${Math.floor(l[2]*255)})`},backgroundOptions:{color:"transparent"},cornersDotOptions:{type:"dot"},cornersSquareOptions:{type:"extra-rounded"}}).getRawData("png");if(_==null)throw new Error("Failed to generate QR code");const v=await window.createImageBitmap(_);t.drawImage(v,t.canvas.width-s-g,(t.canvas.height-s)/2,s,s),v.close()}catch{}return t.getImageData(0,0,t.canvas.width,t.canvas.height)}async render(e){let i=this.image.width,n=this.image.height;if(this.renderAsPreview&&(i>1e3||n>1e3)){const d=Math.min(1e3/i,1e3/n);i=Math.floor(i*d),n=Math.floor(n*d)}const c=Math.floor(n*e.borderThickness),r=Math.floor(n*e.borderThickness),l=e.labelTop.enabled?Math.floor(n*e.labelTop.padding):Math.floor(n*e.borderThickness),p=e.labelBottom.enabled?Math.floor(n*e.labelBottom.padding):Math.floor(n*e.borderThickness),a=i+c+r,f=n+l+p;if(e.labelTop.enabled){const t=await this.renderLabel(a,l,c,r,n,e.fgColor,e.font,e.labelTop);this.compositor.registerTexture("topLabel",t)}if(e.labelBottom.enabled){const t=await this.renderLabel(a,p,c,r,n,e.fgColor,e.font,e.labelBottom);this.compositor.registerTexture("bottomLabel",t)}this.compositor.changeResolution(a,f),this.compositor.render([{functionId:"frame",id:"a",params:{image:"image",topLabel:"topLabel",bottomLabel:"bottomLabel",topLabelEnabled:e.labelTop.enabled,bottomLabelEnabled:e.labelBottom.enabled,paddingLeft:c/a,paddingRight:r/a,paddingTop:l/f,paddingBottom:p/f,bg:e.bgColor}}])}destroy(e=!0){this.compositor.destroy(e)}}export{P as ImageFrameRenderer};
