import{Q as m}from"./3iSoGi4ic-C_KRNUC8.js";import{u}from"./3iSoGi4ic-B1GPmOGN.js";import{bq as l,Q as f}from"./3iSoGi4ic-DV-GuiCp.js";import{d as p,I as d}from"./3iSoGi4ic-BmLZI3Ia.js";import{f as g,a as x,b as y}from"./3iSoGi4ic-BK8Hr_a2.js";import"./3iSoGi4ic-D0mTJ0Mu.js";import"./3iSoGi4ic-Dty8GuTz.js";import"./3iSoGi4ic-D98_HDRS.js";var w=`#version 300 es
precision mediump float;const float PI=3.141592653589793;in vec2 in_uv;uniform sampler2D in_texture;uniform vec2 in_resolution;uniform sampler2D u_watermark;uniform vec2 u_wmResolution;uniform float u_opacity;uniform float u_scale;uniform float u_angle;uniform bool u_cover;uniform bool u_repeat;uniform int u_alignX;uniform int u_alignY;uniform float u_margin;uniform float u_repeatMargin;uniform bool u_noBBoxExpansion;uniform bool u_wmEnabled;out vec4 out_color;mat2 rot(float a){float c=cos(a),s=sin(a);return mat2(c,-s,s,c);}vec2 computeWmSize(vec2 outSize,vec2 wmSize,bool cover,float scale){float wmAspect=wmSize.x/wmSize.y;float outAspect=outSize.x/outSize.y;vec2 size;if(cover){if(wmAspect>=outAspect){size.y=outSize.y*scale;size.x=size.y*wmAspect;}else{size.x=outSize.x*scale;size.y=size.x/wmAspect;}}else{if(wmAspect>=outAspect){size.x=outSize.x*scale;size.y=size.x/wmAspect;}else{size.y=outSize.y*scale;size.x=size.y*wmAspect;}}return size;}void main(){vec2 outSize=in_resolution;vec2 p=in_uv*outSize;vec4 base=texture(in_texture,in_uv);if(!u_wmEnabled){out_color=base;return;}float theta=u_angle*PI;vec2 wmSize=computeWmSize(outSize,u_wmResolution,u_cover,u_scale);vec2 margin=u_repeat ? wmSize*u_repeatMargin : outSize*u_margin;float rotateX=0.0;float rotateY=0.0;if(abs(theta)>1e-6&&!u_noBBoxExpansion){rotateX=abs(abs(wmSize.x*cos(theta))+abs(wmSize.y*sin(theta))-wmSize.x)*0.5;rotateY=abs(abs(wmSize.x*sin(theta))+abs(wmSize.y*cos(theta))-wmSize.y)*0.5;}float x;if(u_alignX==1){x=(outSize.x-wmSize.x)*0.5;}else if(u_alignX==0){x=rotateX+margin.x;}else{x=outSize.x-wmSize.x - margin.x - rotateX;}float y;if(u_alignY==1){y=(outSize.y-wmSize.y)*0.5;}else if(u_alignY==0){y=rotateY+margin.y;}else{y=outSize.y-wmSize.y - margin.y - rotateY;}vec2 rectMin=vec2(x,y);vec2 rectMax=rectMin+wmSize;vec2 rectCenter=(rectMin+rectMax)*0.5;vec4 wmCol=vec4(0.0);if(u_repeat){vec2 q=rectCenter+rot(theta)*(p-rectCenter);vec2 gridOrigin=rectMin-margin;vec2 qFromOrigin=q-gridOrigin;vec2 tile=wmSize+margin*2.0;vec2 tileUv=qFromOrigin/tile;vec2 localUv=fract(tileUv);vec2 localPos=localUv*tile;bool inMargin=any(lessThan(localPos,margin))||any(greaterThanEqual(localPos,margin+wmSize));if(!inMargin){vec2 uvWm=(localPos-margin)/wmSize;wmCol=texture(u_watermark,uvWm);}}else{vec2 q=rectCenter+rot(theta)*(p-rectCenter);bool inside=all(greaterThanEqual(q,rectMin))&&all(lessThan(q,rectMax));if(inside){vec2 uvWm=(q-rectMin)/wmSize;wmCol=texture(u_watermark,uvWm);}}float a=clamp(wmCol.a*u_opacity,0.0,1.0);out_color=mix(base,vec4(wmCol.rgb,1.0),a);}`;const h=p({shader:w,main:({gl:t,u:o,params:i,textures:n})=>{t.uniform1f(o.opacity,i.opacity??1),t.uniform1f(o.scale,i.scale??.3),t.uniform1f(o.angle,i.angle??0),t.uniform1i(o.cover,i.cover?1:0),t.uniform1i(o.repeat,i.repeat?1:0);const e=i.align?.x==="left"?0:i.align?.x==="center"?1:2,a=i.align?.y==="top"?0:i.align?.y==="center"?1:2;t.uniform1i(o.alignX,e),t.uniform1i(o.alignY,a),t.uniform1f(o.margin,i.align?.margin??0),t.uniform1f(o.repeatMargin,i.align?.margin??0),t.uniform1i(o.noBBoxExpansion,i.noBoundingBoxExpansion?1:0);const r=i.watermark?n.get(i.watermark):null;r?(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,r.texture),i.repeat?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),t.uniform1i(o.watermark,1),t.uniform2f(o.wmResolution,r.width,r.height),t.uniform1i(o.wmEnabled,1)):t.uniform1i(o.wmEnabled,0)}});class P{compositor;constructor(o){this.compositor=new d({canvas:o.canvas,renderWidth:o.renderWidth,renderHeight:o.renderHeight,image:o.image,functions:{watermark:h,stripe:y,polkadot:x,checker:g}})}async render(o){const i=[],n=new Set(this.compositor.getKeysOfRegisteredTextures());for(const e of o)if(e.type==="text"){const a=`text:${e.text}`;if(n.delete(a),!this.compositor.hasTexture(a)){const r=await _(e.text);r!=null&&this.compositor.registerTexture(a,r)}i.push({functionId:"watermark",id:e.id,params:{repeat:e.repeat,noBoundingBoxExpansion:e.noBoundingBoxExpansion,scale:e.scale,align:e.align,angle:e.angle,opacity:e.opacity,cover:!1,watermark:a}})}else if(e.type==="image"){const a=`url:${e.imageUrl}`;if(n.delete(a),!this.compositor.hasTexture(a)){const r=await v(e.imageUrl);r!=null&&this.compositor.registerTexture(a,r)}i.push({functionId:"watermark",id:e.id,params:{repeat:e.repeat,noBoundingBoxExpansion:e.noBoundingBoxExpansion,scale:e.scale,align:e.align,angle:e.angle,opacity:e.opacity,cover:e.cover,watermark:a}})}else if(e.type==="qr"){const a=`qr:${e.data}`;if(n.delete(a),!this.compositor.hasTexture(a)){const r=await z({data:e.data});r!=null&&this.compositor.registerTexture(a,r)}i.push({functionId:"watermark",id:e.id,params:{repeat:!1,scale:e.scale,align:e.align,angle:0,opacity:e.opacity,cover:!1,watermark:a}})}else if(e.type==="stripe")i.push({functionId:"stripe",id:e.id,params:{angle:e.angle,frequency:e.frequency,threshold:e.threshold,color:e.color,opacity:e.opacity}});else if(e.type==="polkadot")i.push({functionId:"polkadot",id:e.id,params:{angle:e.angle,scale:e.scale,majorRadius:e.majorRadius,majorOpacity:e.majorOpacity,minorDivisions:e.minorDivisions,minorRadius:e.minorRadius,minorOpacity:e.minorOpacity,color:e.color}});else if(e.type==="checker")i.push({functionId:"checker",id:e.id,params:{angle:e.angle,scale:e.scale,color:e.color,opacity:e.opacity}});else throw new Error(`Unrecognized layer type: ${e.type}`);for(const e of n)this.compositor.unregisterTexture(e);this.compositor.render(i)}changeResolution(o,i){this.compositor.changeResolution(o,i)}destroy(o=!0){this.compositor.destroy(o)}}async function v(t){if(t==null||t.trim()==="")return null;const o=await new Promise((i,n)=>{const e=new Image;e.onload=()=>i(e),e.onerror=n,e.src=l(t)}).catch(()=>null);return o??null}async function _(t,o=2048){if(t==null||t.trim()==="")return null;const i=window.document.createElement("canvas").getContext("2d");i.canvas.width=o,i.canvas.height=o/4;const n=o/32,e=n/2;i.shadowColor="#000000",i.shadowBlur=n/4,i.fillStyle="#ffffff",i.font=`bold ${n}px sans-serif`,i.textBaseline="middle",i.fillText(t,e,i.canvas.height/2);const a=i.measureText(t),r=Math.ceil(a.actualBoundingBoxRight+a.actualBoundingBoxLeft)+e+e,s=Math.ceil(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent)+e+e,c=i.getImageData(0,i.canvas.height/2-s/2,r,s);return i.canvas.remove(),c}async function z(t,o=512){const i=f(),e=await new m({width:o,height:o,margin:42,type:"canvas",data:t.data==null||t.data===""?`${u}/users/${i.id}`:t.data,image:i.avatarUrl,qrOptions:{typeNumber:0,mode:"Byte",errorCorrectionLevel:"H"},imageOptions:{hideBackgroundDots:!0,imageSize:.3,margin:16,crossOrigin:"anonymous"},dotsOptions:{type:"dots"},cornersDotOptions:{type:"dot"},cornersSquareOptions:{type:"extra-rounded"}}).getRawData("png");return e==null?null:await window.createImageBitmap(e)}export{P as WatermarkRenderer};
