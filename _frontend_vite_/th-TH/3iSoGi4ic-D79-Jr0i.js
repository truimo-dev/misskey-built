import{U as z,aH as F,J as G,l as N,aW as _,az as R,M as E,C as B,L as Q}from"./3iSoGi4ic-DV-GuiCp.js";import{i as U,u as j,C as J,c as O}from"./3iSoGi4ic-CqmhgU-Q.js";import{a as K}from"./3iSoGi4ic-BPp9MNgd.js";import{b as q,u as A,e as X,l as C,i as f,m as Y,a as D,o as Z,z as $,p as e,B as y,D as v,E as u,t as k,h as x,F as ee,A as ae,c as H,f as S,C as te}from"./3iSoGi4ic-D0mTJ0Mu.js";import{M as se}from"./3iSoGi4ic-Fx-BY70c.js";import"./3iSoGi4ic-B1GPmOGN.js";import"./3iSoGi4ic-D98_HDRS.js";const L=q({__name:"federation-job-queue.chart.chart",props:{type:{}},setup(w,{expose:n}){U();const l=w,m=A("chartEl"),{handler:b}=j();let a=null;function r(o){if(!(a==null||a.data.labels==null)){for(const s of o)a.data.labels.push(""),a.data.datasets[0].data.push(s),a.data.datasets[0].data.length>200&&(a.data.labels.shift(),a.data.datasets[0].data.shift());a.update()}}function t(o){a==null||a.data.labels==null||(a.data.labels.push(""),a.data.datasets[0].data.push(o),a.data.datasets[0].data.length>200&&(a.data.labels.shift(),a.data.datasets[0].data.shift()),a.update())}const c=l.type==="process"?"Process":l.type==="active"?"Active":l.type==="delayed"?"Delayed":l.type==="waiting"?"Waiting":"?",d=l.type==="process"?"#00E396":l.type==="active"?"#00BCD4":l.type==="delayed"?"#E53935":l.type==="waiting"?"#FFB300":"?";return X(()=>{const o=z.s.darkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)";m.value!=null&&(a=new J(m.value,{type:"line",data:{labels:[],datasets:[{label:c,pointRadius:0,tension:.3,borderWidth:2,borderJoinStyle:"round",borderColor:d,backgroundColor:K(d,.2),fill:!0,data:[]}]},options:{aspectRatio:2.5,layout:{padding:{left:0,right:0,top:0,bottom:0}},scales:{x:{grid:{display:!0},ticks:{display:!1,maxTicksLimit:10}},y:{min:0,grid:{}}},interaction:{intersect:!1},plugins:{legend:{display:!1},tooltip:{enabled:!1,mode:"index",animation:{duration:0},external:b}}},plugins:[O(o)]}))}),n({setData:r,pushData:t}),(o,s)=>(f(),C("canvas",{ref_key:"chartEl",ref:m},null,512))}}),ne={class:"_gaps"},le={key:0},ie={style:{"margin-left":"8px",opacity:"0.7"}},oe={key:1,style:{opacity:"0.5"}},I=q({__name:"federation-job-queue.chart",props:{domain:{}},setup(w){const n=Y(F().useChannel("queueStats")),l=D(0),m=D(0),b=D(0),a=D(0),r=D([]),t=A("chartProcess"),c=A("chartActive"),d=A("chartDelayed"),o=A("chartWaiting"),s=w;function M(i){l.value=i[s.domain].activeSincePrevTick,m.value=i[s.domain].active,b.value=i[s.domain].delayed,a.value=i[s.domain].waiting,t.value!=null&&t.value.pushData(i[s.domain].activeSincePrevTick),c.value!=null&&c.value.pushData(i[s.domain].active),d.value!=null&&d.value.pushData(i[s.domain].delayed),o.value!=null&&o.value.pushData(i[s.domain].waiting)}function V(i){const g=[],T=[],p=[],P=[];for(const W of[...i].reverse())g.push(W[s.domain].activeSincePrevTick),T.push(W[s.domain].active),p.push(W[s.domain].delayed),P.push(W[s.domain].waiting);t.value!=null&&t.value.setData(g),c.value!=null&&c.value.setData(T),d.value!=null&&d.value.setData(p),o.value!=null&&o.value.setData(P)}return X(()=>{G(`admin/queue/${s.domain}-delayed`).then(i=>{r.value=i}),n.on("stats",M),n.on("statsLog",V),n.send("requestLog",{id:N(),length:200})}),Z(()=>{n.off("stats",M),n.off("statsLog",V),n.dispose()}),(i,g)=>{const T=$("MkA");return f(),C("div",ne,[e("div",{class:"xmUHf"},[e("div",{class:"xCpnX _panel"},[e("div",{class:"xdGkd"},"Process",2),v(u(k(_)(l.value)),1)],2),e("div",{class:"xCpnX _panel"},[e("div",{class:"xdGkd"},"Active",2),v(u(k(_)(m.value)),1)],2),e("div",{class:"xCpnX _panel"},[e("div",{class:"xdGkd"},"Waiting",2),v(u(k(_)(a.value)),1)],2),e("div",{class:"xCpnX _panel"},[e("div",{class:"xdGkd"},"Delayed",2),v(u(k(_)(b.value)),1)],2)],2),e("div",{class:"xeDpz"},[e("div",{class:"xanb5"},[e("div",{class:"xodV5"},"Process",2),y(L,{ref_key:"chartProcess",ref:t,type:"process"},null,512)],2),e("div",{class:"xanb5"},[e("div",{class:"xodV5"},"Active",2),y(L,{ref_key:"chartActive",ref:c,type:"active"},null,512)],2),e("div",{class:"xanb5"},[e("div",{class:"xodV5"},"Delayed",2),y(L,{ref_key:"chartDelayed",ref:d,type:"delayed"},null,512)],2),e("div",{class:"xanb5"},[e("div",{class:"xodV5"},"Waiting",2),y(L,{ref_key:"chartWaiting",ref:o,type:"waiting"},null,512)],2)],2),y(se,{defaultOpen:!0,"max-height":250},{icon:x(()=>[...g[0]||(g[0]=[e("i",{class:"ti ti-alert-triangle"},null,-1)])]),label:x(()=>[...g[1]||(g[1]=[v("Errored instances",-1)])]),suffix:x(()=>[v("("+u(k(_)(r.value.reduce((p,P)=>p+P[1],0)))+" jobs)",1)]),default:x(()=>[e("div",null,[r.value.length>0?(f(),C("div",le,[(f(!0),C(ee,null,ae(r.value,p=>(f(),C("div",{key:p[0]},[y(T,{to:`/instance-info/${p[0]}`,behavior:"window"},{default:x(()=>[v(u(p[0]),1)]),_:2},1032,["to"]),e("span",ie,"("+u(k(_)(p[1]))+" jobs)",1)]))),128))])):(f(),C("span",oe,u("ไม่มีงาน"),1))])]),_:1})])}}});const re={class:"_spacer",style:{"--MI_SPACER-w":"800px"}},de={class:"_buttons"},be=q({__name:"federation-job-queue",setup(w){const n=D("deliver");function l(){B({type:"warning",title:"ต้องการล้างคิวใช่ไหม?",text:"โพสต์ที่ยังค้างในคิวจะไม่ถูกจัดส่งอีกต่อไป โดยปกติแล้วการดำเนินการนี้ไม่จำเป็น"}).then(({canceled:r})=>{r||Q("admin/queue/clear",{queue:n.value,state:"*"})})}function m(){B({type:"warning",title:"ลองใหม่ทั้งหมดจริงๆหรอแน่ใจนะ?",text:"สิ่งนี้จะเพิ่มการโหลดเซิร์ฟเวอร์ชั่วคราวนะ"}).then(({canceled:r})=>{r||Q("admin/queue/promote-jobs",{queue:n.value})})}const b=H(()=>[]),a=H(()=>[{key:"deliver",title:"Deliver"},{key:"inbox",title:"Inbox"}]);return R(()=>({title:"งานสหพันธ์",icon:"ti ti-clock-play"})),(r,t)=>{const c=$("PageWithHeader");return f(),S(c,{tab:n.value,"onUpdate:tab":t[0]||(t[0]=d=>n.value=d),actions:b.value,tabs:a.value},{default:x(()=>[e("div",re,[n.value==="deliver"?(f(),S(I,{key:0,domain:"deliver"})):n.value==="inbox"?(f(),S(I,{key:1,domain:"inbox"})):te("",!0),t[3]||(t[3]=e("br",null,null,-1)),e("div",de,[y(E,{onClick:m},{default:x(()=>[t[1]||(t[1]=e("i",{class:"ti ti-reload"},null,-1)),v(" "+u("ลองเรียกใช้คิวทั้งหมดอีกครั้ง"),1)]),_:1}),y(E,{danger:"",onClick:l},{default:x(()=>[t[2]||(t[2]=e("i",{class:"ti ti-trash"},null,-1)),v(" "+u("ล้างคิว"),1)]),_:1})])])]),_:1},8,["tab","actions","tabs"])}}});export{be as default};
