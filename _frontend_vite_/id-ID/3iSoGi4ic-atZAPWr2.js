import{i as D,u as R,C as W}from"./3iSoGi4ic-CqmhgU-Q.js";import{J as i,U as F}from"./3iSoGi4ic-DV-GuiCp.js";import{a as I}from"./3iSoGi4ic-BPp9MNgd.js";import{b as B,u as k,a as T,w as A,e as L,z as Y,l as b,i as w,f as $,p as z,n as H}from"./3iSoGi4ic-D0mTJ0Mu.js";const J={key:1},j=B({__name:"MkHeatmap",props:{src:{},user:{default:void 0},label:{default:""}},setup(x){D();const a=x,l=k("rootEl"),d=k("chartEl"),u=new Date;let p=null;const f=T(!0),{handler:M}=R({position:"middle"});async function v(){if(l.value==null)return;p&&p.destroy();const m=l.value.offsetWidth>700,h=l.value.offsetWidth<400,c=m?50:h?10:25,o=7*c,_=t=>{const e=u.getFullYear(),r=u.getMonth(),n=u.getDate();return new Date(e,r,n-t)},C=t=>t.map((e,r)=>{const n=_(r),g=`${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,"0")}-${n.getDate().toString().padStart(2,"0")}`;return{x:g,y:n.getDay(),d:g,v:e}});let s=[];a.src==="active-users"?s=(await i("charts/active-users",{limit:o,span:"day"})).readWrite:a.src==="notes"?a.user?s=(await i("charts/user/notes",{userId:a.user.id,limit:o,span:"day"})).inc:s=(await i("charts/notes",{limit:o,span:"day"})).local.inc:a.src==="ap-requests-inbox-received"?s=(await i("charts/ap-request",{limit:o,span:"day"})).inboxReceived:a.src==="ap-requests-deliver-succeeded"?s=(await i("charts/ap-request",{limit:o,span:"day"})).deliverSucceeded:a.src==="ap-requests-deliver-failed"&&(s=(await i("charts/ap-request",{limit:o,span:"day"})).deliverFailed),f.value=!1,await H();const E=F.s.darkMode?"#b4e900":"#86b300",S=s.slice().sort((t,e)=>e-t).slice(0,3).reduce((t,e)=>t+e,0)/3,q=Math.max(0,Math.min(...s)-1),y=4;d.value!=null&&(p=new W(d.value,{type:"matrix",data:{datasets:[{label:a.label,data:C(s),borderWidth:0,borderRadius:3,backgroundColor(t){const e=t.dataset.data[t.dataIndex].v;let r=(e-q)/S;return e!==0&&(r=Math.max(r,.05)),I(E,r)},width(t){const e=t.chart.chartArea??{};return(e.right-e.left)/c-y},height(t){const e=t.chart.chartArea??{};return(e.bottom-e.top)/7-y}}]},options:{aspectRatio:m?6:h?1.8:3.2,layout:{padding:{left:8,right:0,top:0,bottom:0}},scales:{x:{type:"time",offset:!0,position:"bottom",time:{unit:"week",round:"week",isoWeekday:0,displayFormats:{day:"M/d",month:"Y/M",week:"M/d"}},grid:{display:!1},ticks:{display:!0,maxRotation:0,autoSkipPadding:8}},y:{offset:!0,reverse:!0,position:"right",grid:{display:!1},ticks:{maxRotation:0,autoSkip:!0,padding:1,font:{size:9},callback:(t,e,r)=>["","Mon","","Wed","","Fri",""][t]}}},plugins:{legend:{display:!1},tooltip:{enabled:!1,callbacks:{title(t){return t[0].dataset.data[t[0].dataIndex].d},label(t){return[t.dataset.data[t.dataIndex].v]}},animation:{duration:0},external:M}}}}))}return A(()=>a.src,()=>{f.value=!0,v()}),L(async()=>{v()}),(m,h)=>{const c=Y("MkLoading");return w(),b("div",{ref_key:"rootEl",ref:l},[f.value?(w(),$(c,{key:0})):(w(),b("div",J,[z("canvas",{ref_key:"chartEl",ref:d},null,512)]))],512)}}});export{j as _};
