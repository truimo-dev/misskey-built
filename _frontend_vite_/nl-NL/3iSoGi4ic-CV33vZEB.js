import{b as as,c as xs,u as Qe,a as k,Z as Ge,w as Te,e as Ss,o as zs,M as As,z as we,l as g,i as f,p as s,C,j as Ke,g as ks,D as _,B as v,E as u,t as P,v as Je,h as b,T as Ae,F as ke,A as Ye,G as ws,q as Re,s as ze,f as se,R as Cs}from"./3iSoGi4ic-D0mTJ0Mu.js";import{_ as Ms}from"./3iSoGi4ic-BNEZVgdd.js";import{d8 as Es,b as oe,dk as U,ar as Ze,as as Is,bj as es,J as pe,aF as Gs,A as Rs,be as Ts,bf as Ys,az as ns,M as D,U as Xs,C as Ps,b2 as ss,bz as Fs,c as Os,$ as is,aS as Ds,ag as Ls,ab as Hs,b7 as Bs}from"./3iSoGi4ic-DV-GuiCp.js";import{m as y}from"./3iSoGi4ic-BgWU3LBm.js";import{s as Ns}from"./3iSoGi4ic-C0O4p9AH.js";import{a as Us}from"./3iSoGi4ic-B1GPmOGN.js";import{_ as ee}from"./3iSoGi4ic-Dy0PONm0.js";import{M as $s}from"./3iSoGi4ic-geP5Alzl.js";import{M as ts}from"./3iSoGi4ic-CSc4cSLM.js";import"./3iSoGi4ic-D98_HDRS.js";import"./3iSoGi4ic-Ddz4upM5.js";import"./3iSoGi4ic-ke9ZaMpT.js";const Ws="https://fastly.jsdelivr.net/gh/truimo-dev/misskey-built@latest/_frontend_vite_/assets/3iSoGi4ic-MmUg7_9E.png",Vs="https://fastly.jsdelivr.net/gh/truimo-dev/misskey-built@latest/_frontend_vite_/assets/3iSoGi4ic-phqPAXHj.png",qs="https://fastly.jsdelivr.net/gh/truimo-dev/misskey-built@latest/_frontend_vite_/assets/3iSoGi4ic-BGr1zIRj.svg",js="https://fastly.jsdelivr.net/gh/truimo-dev/misskey-built@latest/_frontend_vite_/assets/3iSoGi4ic-Bkum39VP.svg",Qs="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='UTF-8'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20width='100%25'%20height='100%25'%20viewBox='0%200%20128%20128'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20xml:space='preserve'%20xmlns:serif='http://www.serif.com/'%20style='fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;'%3e%3cpath%20d='M0,0L128,0L64,64L0,0Z'%20style='fill:rgb(255,61,0);'/%3e%3cpath%20d='M0,0L128,0L64,64L0,0ZM28.971,12L64,47.029C64,47.029%2099.029,12%2099.029,12L28.971,12Z'%20style='fill:rgb(255,122,0);'/%3e%3c/svg%3e",Ks="https://fastly.jsdelivr.net/gh/truimo-dev/misskey-built@latest/_frontend_vite_/assets/3iSoGi4ic-CgH9jR-X.png",S=32,os=[{id:"9377076d-c980-4d83-bdaf-175bc58275b7",level:10,sizeX:S*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"circle",score:512,dropCandidate:!1},{id:"be9f38d2-b267-4b1a-b420-904e22e80568",level:9,sizeX:S*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"circle",score:256,dropCandidate:!1},{id:"beb30459-b064-4888-926b-f572e4e72e0c",level:8,sizeX:S*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"circle",score:128,dropCandidate:!1},{id:"feab6426-d9d8-49ae-849c-048cdbb6cdf0",level:7,sizeX:S*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25*1.25*1.25*1.25,shape:"circle",score:64,dropCandidate:!1},{id:"d6d8fed6-6d18-4726-81a1-6cf2c974df8a",level:6,sizeX:S*1.25*1.25*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25*1.25*1.25,shape:"circle",score:32,dropCandidate:!1},{id:"249c728e-230f-4332-bbbf-281c271c75b2",level:5,sizeX:S*1.25*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25*1.25,shape:"circle",score:16,dropCandidate:!0},{id:"23d67613-d484-4a93-b71e-3e81b19d6186",level:4,sizeX:S*1.25*1.25*1.25,sizeY:S*1.25*1.25*1.25,shape:"circle",score:8,dropCandidate:!0},{id:"3cbd0add-ad7d-4685-bad0-29f6dddc0b99",level:3,sizeX:S*1.25*1.25,sizeY:S*1.25*1.25,shape:"circle",score:4,dropCandidate:!0},{id:"8f86d4f4-ee02-41bf-ad38-1ce0ae457fb5",level:2,sizeX:S*1.25,sizeY:S*1.25,shape:"circle",score:2,dropCandidate:!0},{id:"64ec4add-ce39-42b4-96cb-33908f3f118d",level:1,sizeX:S,sizeY:S,shape:"circle",score:1,dropCandidate:!0}],X=32,Q=70,Js=[{id:"880f9bd9-802f-4135-a7e1-fd0e0331f726",level:10,sizeX:Q*2*1.25*1.25*1.25,sizeY:Q*1.25*1.25*1.25,shape:"rectangle",score:1e4,dropCandidate:!1},{id:"e807beb6-374a-4314-9cc2-aa5f17d96b6b",level:9,sizeX:Q*2*1.25*1.25,sizeY:Q*1.25*1.25,shape:"rectangle",score:5e3,dropCandidate:!1},{id:"033445b7-8f90-4fc9-beca-71a9e87cb530",level:8,sizeX:Q*2*1.25,sizeY:Q*1.25,shape:"rectangle",score:2e3,dropCandidate:!1},{id:"410a09ec-5f7f-46f6-b26f-cbca4ccbd091",level:7,sizeX:Q*2,sizeY:Q,shape:"rectangle",score:1e3,dropCandidate:!1},{id:"2aae82bc-3fa4-49ad-a6b5-94d888e809f5",level:6,sizeX:X*1.25*1.25*1.25*1.25*1.25,sizeY:X*1.25*1.25*1.25*1.25*1.25,shape:"circle",score:500,dropCandidate:!1},{id:"a619bd67-d08f-4cc0-8c7e-c8072a4950cd",level:5,sizeX:X*1.25*1.25*1.25*1.25,sizeY:X*1.25*1.25*1.25*1.25,shape:"circle",score:100,dropCandidate:!0},{id:"c1c5d8e4-17d6-4455-befd-12154d731faa",level:4,sizeX:X*1.25*1.25*1.25,sizeY:X*1.25*1.25*1.25,shape:"circle",score:50,dropCandidate:!0},{id:"7082648c-e428-44c4-887a-25c07a8ebdd5",level:3,sizeX:X*1.25*1.25,sizeY:X*1.25*1.25,shape:"circle",score:10,dropCandidate:!0},{id:"0d8d40d5-e6e0-4d26-8a95-b8d842363379",level:2,sizeX:X*1.25,sizeY:X*1.25,shape:"circle",score:5,dropCandidate:!0},{id:"9dec1b38-d99d-40de-8288-37367b983d0d",level:1,sizeX:X,sizeY:X,shape:"circle",score:1,dropCandidate:!0}],z=28,Zs=[{id:"f75fd0ba-d3d4-40a4-9712-b470e45b0525",level:10,sizeX:z*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"rectangle",score:512,dropCandidate:!1},{id:"7b70f4af-1c01-45fd-af72-61b1f01e03d1",level:9,sizeX:z*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"rectangle",score:256,dropCandidate:!1},{id:"41607ef3-b6d6-4829-95b6-3737bf8bb956",level:8,sizeX:z*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"rectangle",score:128,dropCandidate:!1},{id:"8a8310d2-0374-460f-bb50-ca9cd3ee3416",level:7,sizeX:z*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25*1.25*1.25*1.25,shape:"rectangle",score:64,dropCandidate:!1},{id:"1092e069-fe1a-450b-be97-b5d477ec398c",level:6,sizeX:z*1.25*1.25*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25*1.25*1.25,shape:"rectangle",score:32,dropCandidate:!1},{id:"2294734d-7bb8-4781-bb7b-ef3820abf3d0",level:5,sizeX:z*1.25*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25*1.25,shape:"rectangle",score:16,dropCandidate:!0},{id:"ea8a61af-e350-45f7-ba6a-366fcd65692a",level:4,sizeX:z*1.25*1.25*1.25,sizeY:z*1.25*1.25*1.25,shape:"rectangle",score:8,dropCandidate:!0},{id:"d0c74815-fc1c-4fbe-9953-c92e4b20f919",level:3,sizeX:z*1.25*1.25,sizeY:z*1.25*1.25,shape:"rectangle",score:4,dropCandidate:!0},{id:"d8fbd70e-611d-402d-87da-1a7fd8cd2c8d",level:2,sizeX:z*1.25,sizeY:z*1.25,shape:"rectangle",score:2,dropCandidate:!0},{id:"35e476ee-44bd-4711-ad42-87be245d3efd",level:1,sizeX:z,sizeY:z,shape:"rectangle",score:1,dropCandidate:!0}],A=40,ei=[{id:"77f724c0-88be-4aeb-8e1a-a00ed18e3844",level:10,sizeX:A*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"custom",vertices:[[{x:14,y:2},{x:2,y:13},{x:2,y:31},{x:30,y:23},{x:30,y:7},{x:29,y:6},{x:20,y:4},{x:17,y:3},{x:16,y:2}]],verticesSize:32,score:400,dropCandidate:!1},{id:"f3468ef4-2e1e-4906-8795-f147f39f7e1f",level:9,sizeX:A*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"custom",vertices:[[{x:15,y:2},{x:14,y:3},{x:8,y:4},{x:6,y:5},{x:4,y:8},{x:4,y:15},{x:2,y:19},{x:2,y:22.36},{x:3,y:25},{x:5,y:28},{x:10,y:30},{x:22,y:30},{x:27,y:28},{x:29,y:25},{x:30,y:22},{x:30,y:19},{x:28,y:15},{x:28,y:8},{x:26,y:5},{x:24,y:4},{x:18,y:3},{x:17,y:2}]],verticesSize:32,score:380,dropCandidate:!1},{id:"bcb41129-6f2d-44ee-89d3-86eb2df564ba",level:8,sizeX:A*1.25*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25*1.25*1.25*1.25*1.25,shape:"custom",vertices:[[{x:15,y:2},{x:11,y:3},{x:8,y:6},{x:7,y:8},{x:6,y:11},{x:6,y:13},{x:7,y:16},{x:8,y:18},{x:15,y:30},{x:17,y:30},{x:24,y:18},{x:25,y:16},{x:26,y:13},{x:26,y:11},{x:25,y:8},{x:24,y:6},{x:21,y:3},{x:17,y:2}]],verticesSize:32,score:300,dropCandidate:!1},{id:"f058e1ad-1981-409b-b3a7-302de0a43744",level:7,sizeX:A*1.25*1.25*1.25*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25*1.25*1.25*1.25,shape:"custom",vertices:[[{x:17,y:2.541},{x:14,y:5.402},{x:10,y:7},{x:10,y:10.367},{x:8,y:11},{x:8,y:14},{x:5.781,y:16.265},{x:6.594,y:19.627},{x:9.414,y:21},{x:12,y:29.988},{x:21,y:29.988},{x:22.016,y:22.629},{x:23,y:21.772},{x:23,y:19.202},{x:25.783,y:17.473},{x:25.783,y:14.727},{x:24,y:13.173},{x:24,y:10.367},{x:22,y:9.233},{x:22,y:6.454},{x:18,y:5}]],verticesSize:32,score:300,dropCandidate:!1},{id:"d22cfe38-5a3b-4b9c-a1a6-907930a3d732",level:6,sizeX:A*1.25*1.25*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25*1.25*1.25,shape:"custom",vertices:[[{x:15,y:2},{x:11,y:3},{x:8,y:5},{x:7,y:6},{x:5,y:9},{x:4,y:12},{x:4,y:20},{x:5,y:23},{x:7,y:26},{x:11,y:29},{x:14,y:30},{x:18,y:30},{x:21,y:29},{x:25,y:26},{x:27,y:23},{x:28,y:20},{x:28,y:12},{x:27,y:9},{x:25,y:6},{x:24,y:5},{x:21,y:3},{x:17,y:2}]],verticesSize:32,score:250,dropCandidate:!1},{id:"79867083-a073-427e-ae82-07a70d9f3b4f",level:5,sizeX:A*1.25*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25*1.25,shape:"custom",vertices:[[{x:9,y:15},{x:23,y:15},{x:30,y:27},{x:25.7,y:30},{x:6.34,y:30},{x:2,y:27}]],verticesSize:32,score:200,dropCandidate:!0},{id:"2e152a12-a567-4100-b4d4-d15d81ba47b1",level:4,sizeX:A*1.25*1.25*1.25,sizeY:A*1.25*1.25*1.25,shape:"custom",vertices:[[{x:12,y:2},{x:2,y:12},{x:2,y:14},{x:18,y:30},{x:20,y:30},{x:30,y:20},{x:30,y:18},{x:14,y:2}]],verticesSize:32,score:200,dropCandidate:!0},{id:"12250376-2258-4716-8eec-b3a7239461fc",level:3,sizeX:A*1.25*1.25,sizeY:A*1.25*1.25,shape:"custom",vertices:[[{x:12,y:2},{x:7,y:3},{x:3,y:7},{x:2,y:12},{x:3,y:16},{x:5,y:19},{x:8,y:21},{x:12,y:22},{x:18,y:21},{x:27,y:30},{x:30,y:30},{x:30,y:27},{x:21,y:18},{x:22,y:14.25},{x:22,y:11},{x:21,y:8},{x:19,y:5},{x:16.5,y:3}]],verticesSize:32,score:120,dropCandidate:!0},{id:"4d4f2668-4be7-44a3-aa3a-856df6e25aa6",level:2,sizeX:A*1.25,sizeY:A*1.25,shape:"custom",vertices:[[{x:12,y:1.9},{x:4,y:4},{x:2,y:12},{x:6,y:13.375},{x:6,y:18},{x:8,y:22},{x:12,y:25.372},{x:16,y:26},{x:19,y:25.372},{x:20,y:30},{x:28,y:27},{x:30,y:20},{x:25.473,y:19},{x:26,y:15},{x:24,y:10},{x:20,y:7},{x:16,y:6},{x:13,y:6}]],verticesSize:32,score:20,dropCandidate:!0},{id:"c9984b40-4045-44c3-b260-d47b7b4625b2",level:1,sizeX:A,sizeY:A,shape:"circle",score:30,dropCandidate:!0}];class ge extends Es{PHYSICS_QUALITY_FACTOR=16;COMBO_INTERVAL=60;GAME_VERSION=3;GAME_WIDTH=450;GAME_HEIGHT=600;DROP_COOLTIME=30;PLAYAREA_MARGIN=25;STOCK_MAX=4;TICK_DELTA=1e3/60;frame=0;engine;tickCallbackQueue=[];overflowCollider;isGameOver=!1;gameMode;rng;logs=[];fusionReadyBodyIds=[];gameOverReadyBodyIds=[];fusionReservedPairs=[];latestDroppedAt=0;latestFusionedAt=0;stock=[];holding=null;get monoDefinitions(){switch(this.gameMode){case"normal":return os;case"yen":return Js;case"square":return Zs;case"sweets":return ei;case"space":return os}}_combo=0;get combo(){return this._combo}set combo(i){this._combo=i,this.emit("changeCombo",i)}_score=0;get score(){return this._score}set score(i){this._score=i,this.emit("changeScore",i)}getMonoRenderOptions=null;replayPlaybackRate=1;constructor(i){super(),this.tick=this.tick.bind(this),this.gameMode=i.gameMode,this.getMonoRenderOptions=i.getMonoRenderOptions??null,this.rng=Ns(i.seed);const a=this.gameMode==="sweets"?4:this.PHYSICS_QUALITY_FACTOR;this.engine=y.Engine.create({constraintIterations:2*a,positionIterations:6*a,velocityIterations:4*a,gravity:{x:0,y:this.gameMode==="space"?.0125:1},timing:{timeScale:2},enableSleeping:!1}),this.engine.world.bodies=[];const r={label:"_wall_",isStatic:!0,friction:.7,slop:this.gameMode==="space"?.01:.7,render:{strokeStyle:"transparent",fillStyle:"transparent"}},n=100;y.Composite.add(this.engine.world,[y.Bodies.rectangle(this.GAME_WIDTH/2,this.GAME_HEIGHT+n/2-this.PLAYAREA_MARGIN,this.GAME_WIDTH,n,r),y.Bodies.rectangle(this.GAME_WIDTH+n/2-this.PLAYAREA_MARGIN,this.GAME_HEIGHT/2,n,this.GAME_HEIGHT,r),y.Bodies.rectangle(-(n/2-this.PLAYAREA_MARGIN),this.GAME_HEIGHT/2,n,this.GAME_HEIGHT,r)]),this.overflowCollider=y.Bodies.rectangle(this.GAME_WIDTH/2,0,this.GAME_WIDTH,200,{label:"_overflow_",isStatic:!0,isSensor:!0,render:{strokeStyle:"transparent",fillStyle:"transparent"}}),y.Composite.add(this.engine.world,this.overflowCollider)}msToFrame(i){return Math.round(i/this.TICK_DELTA)}frameToMs(i){return i*this.TICK_DELTA}createBody(i,a,r){const n={label:i.id,density:this.gameMode==="space"?.01:i.sizeX*i.sizeY/1e4,restitution:this.gameMode==="space"?.5:.2,frictionAir:this.gameMode==="space"?0:.01,friction:this.gameMode==="space"?.5:.7,frictionStatic:this.gameMode==="space"?0:5,slop:this.gameMode==="space"?.01:.7,render:this.getMonoRenderOptions?this.getMonoRenderOptions(i):void 0};if(i.shape==="circle")return y.Bodies.circle(a,r,i.sizeX/2,n);if(i.shape==="rectangle")return y.Bodies.rectangle(a,r,i.sizeX,i.sizeY,n);if(i.shape==="custom"&&i.vertices!=null&&i.verticesSize!=null)return y.Bodies.fromVertices(a,r,i.vertices.map(p=>p.map(d=>({x:d.x/i.verticesSize*i.sizeX,y:d.y/i.verticesSize*i.sizeY}))),n);throw new Error("unrecognized shape")}fusion(i,a){this.latestFusionedAt>this.frame-this.COMBO_INTERVAL?this.combo++:this.combo=1,this.latestFusionedAt=this.frame;const r=(i.position.x+a.position.x)/2,n=(i.position.y+a.position.y)/2;this.fusionReadyBodyIds=this.fusionReadyBodyIds.filter(h=>h!==i.id&&h!==a.id),this.gameOverReadyBodyIds=this.gameOverReadyBodyIds.filter(h=>h!==i.id&&h!==a.id),y.Composite.remove(this.engine.world,[i,a]);const p=this.monoDefinitions.find(h=>h.id===i.label);if(p==null)throw new Error("Current Mono Not Found");const d=this.monoDefinitions.find(h=>h.level===p.level+1)??null;if(d){const h=this.createBody(d,r,n);y.Composite.add(this.engine.world,h),this.tickCallbackQueue.push({frame:this.frame+this.msToFrame(100),callback:()=>{this.fusionReadyBodyIds.push(h.id)}}),this.emit("monoAdded",d)}const ae=this.gameMode!=="yen"&&this.gameMode!=="sweets"?1+(this.combo-1)/5:1,N=Math.round(p.score*ae);this.score+=N,this.emit("fusioned",r,n,d,N)}onCollision(i){for(const a of i.pairs){const{bodyA:r,bodyB:n}=a;if(r.label===n.label&&!this.fusionReservedPairs.some(p=>p.bodyA.id===r.id||p.bodyA.id===n.id||p.bodyB.id===r.id||p.bodyB.id===n.id))this.fusionReadyBodyIds.includes(r.id)&&this.fusionReadyBodyIds.includes(n.id)?this.fusion(r,n):(this.fusionReservedPairs.push({bodyA:r,bodyB:n}),this.tickCallbackQueue.push({frame:this.frame+this.msToFrame(100),callback:()=>{this.fusionReservedPairs=this.fusionReservedPairs.filter(p=>p.bodyA.id!==r.id&&p.bodyB.id!==n.id),this.fusion(r,n)}}));else{const p=a.collision.depth;if(r.label==="_overflow_"||n.label==="_overflow_")continue;r.label!=="_wall_"&&n.label!=="_wall_"&&(this.gameOverReadyBodyIds.includes(r.id)||this.gameOverReadyBodyIds.push(r.id),this.gameOverReadyBodyIds.includes(n.id)||this.gameOverReadyBodyIds.push(n.id)),this.emit("collision",p,r,n)}}}onCollisionActive(i){for(const a of i.pairs){const{bodyA:r,bodyB:n}=a;if(r.id===this.overflowCollider.id||n.id===this.overflowCollider.id){if(this.gameOverReadyBodyIds.includes(r.id)||this.gameOverReadyBodyIds.includes(n.id)){this.gameOver();break}continue}}}surrender(){this.logs.push({frame:this.frame,operation:"surrender"}),this.gameOver()}gameOver(){this.isGameOver=!0,this.emit("gameOver")}start(){for(let i=0;i<this.STOCK_MAX;i++)this.stock.push({id:this.rng().toString(),mono:this.monoDefinitions.filter(a=>a.dropCandidate)[Math.floor(this.rng()*this.monoDefinitions.filter(a=>a.dropCandidate).length)]});this.emit("changeStock",this.stock),y.Events.on(this.engine,"collisionStart",this.onCollision.bind(this)),y.Events.on(this.engine,"collisionActive",this.onCollisionActive.bind(this))}getLogs(){return this.logs}tick(){return this.frame++,this.latestFusionedAt<this.frame-this.COMBO_INTERVAL&&(this.combo=0),this.tickCallbackQueue=this.tickCallbackQueue.filter(i=>i.frame===this.frame?(i.callback(),!1):!0),y.Engine.update(this.engine,this.TICK_DELTA),!this.isGameOver}getActiveMonos(){return this.engine.world.bodies.map(i=>this.monoDefinitions.find(a=>a.id===i.label)).filter(i=>i!==void 0)}drop(i){if(this.isGameOver||this.frame-this.latestDroppedAt<this.DROP_COOLTIME)return;const a=this.stock.shift();if(!a)return;this.stock.push({id:this.rng().toString(),mono:this.monoDefinitions.filter(d=>d.dropCandidate)[Math.floor(this.rng()*this.monoDefinitions.filter(d=>d.dropCandidate).length)]}),this.emit("changeStock",this.stock);const r=Math.round(i),n=Math.min(this.GAME_WIDTH-this.PLAYAREA_MARGIN-a.mono.sizeX/2,Math.max(this.PLAYAREA_MARGIN+a.mono.sizeX/2,r)),p=this.createBody(a.mono,n,50+a.mono.sizeY/2);this.logs.push({frame:this.frame,operation:"drop",x:r}),this.gameMode==="space"&&y.Body.applyForce(p,p.position,{x:0,y:Math.PI*a.mono.sizeX*a.mono.sizeY/65536}),y.Composite.add(this.engine.world,p),this.fusionReadyBodyIds.push(p.id),this.latestDroppedAt=this.frame,this.emit("dropped",n),this.emit("monoAdded",a.mono)}hold(){if(!this.isGameOver)if(this.logs.push({frame:this.frame,operation:"hold"}),this.holding){const i=this.stock.shift();if(!i)return;this.stock.unshift(this.holding),this.holding=i,this.emit("changeHolding",this.holding),this.emit("changeStock",this.stock)}else{const i=this.stock.shift();if(!i)return;this.holding=i,this.stock.push({id:this.rng().toString(),mono:this.monoDefinitions.filter(a=>a.dropCandidate)[Math.floor(this.rng()*this.monoDefinitions.filter(a=>a.dropCandidate).length)]}),this.emit("changeHolding",this.holding),this.emit("changeStock",this.stock)}}static serializeLogs(i){const a=[];for(let r=0;r<i.length;r++){const n=i[r],p=r===0?n.frame:n.frame-i[r-1].frame;switch(n.operation){case"drop":a.push([p,0,n.x]);break;case"hold":a.push([p,1]);break;case"surrender":a.push([p,2]);break}}return a}static deserializeLogs(i){const a=[];let r=0;for(const n of i){const p=n[0];switch(r+=p,n[1]){case 0:a.push({frame:r,operation:"drop",x:n[2]});break;case 1:a.push({frame:r,operation:"hold"});break;case 2:a.push({frame:r,operation:"surrender"});break}}return a}dispose(){y.World.clear(this.engine.world,!1),y.Engine.clear(this.engine)}}const si={class:"_spacer",style:{"--MI_SPACER-w":"800px"}},ii={class:"_gaps_s"},ti={class:"_woodenFrameInner"},oi={class:"_woodenFrame _woodenFrameH"},ai={class:"_woodenFrameInner"},ni=["src"],li=["src"],ri=["src"],di={class:"_gaps_s"},ci={key:0},mi={key:1,class:"_woodenFrame"},ui={class:"_woodenFrameInner"},fi={style:{background:"#0004"}},pi={class:"_woodenFrameInner"},gi={class:"_buttonsCenter"},vi={key:2,class:"_woodenFrame"},_i={class:"_woodenFrameInner"},hi={class:"_buttonsCenter"},yi={style:{display:"flex"}},bi={class:"_woodenFrame",style:{flex:"1","margin-right":"10px"}},xi={class:"_woodenFrameInner"},Si={key:0},zi={key:1},Ai={key:0},ki={class:"_woodenFrame",style:{"margin-left":"auto"}},wi={class:"_woodenFrameInner",style:{"text-align":"center"}},Ci={key:3,class:"_woodenFrame"},Mi={class:"_woodenFrameInner"},Ei={class:"_gaps"},Ii={class:"_woodenFrame"},Gi={class:"_woodenFrameInner"},Ri=["src"],Ti={key:0,style:{display:"inline-block","margin-left":"4px","vertical-align":"bottom"}},Yi={class:"_woodenFrame"},Xi={class:"_woodenFrameInner"},Pi=as({__name:"drop-and-fusion.game",props:{gameMode:{},mute:{type:Boolean}},emits:["end"],setup(L,{emit:i}){const a=[{id:"9377076d-c980-4d83-bdaf-175bc58275b7",sfxPitch:.25,img:"/client-assets/drop-and-fusion/normal_monos/exploding_head.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"be9f38d2-b267-4b1a-b420-904e22e80568",sfxPitch:.5,img:"/client-assets/drop-and-fusion/normal_monos/face_with_symbols_on_mouth.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"beb30459-b064-4888-926b-f572e4e72e0c",sfxPitch:.75,img:"/client-assets/drop-and-fusion/normal_monos/cold_face.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"feab6426-d9d8-49ae-849c-048cdbb6cdf0",sfxPitch:1,img:"/client-assets/drop-and-fusion/normal_monos/zany_face.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"d6d8fed6-6d18-4726-81a1-6cf2c974df8a",sfxPitch:1.5,img:"/client-assets/drop-and-fusion/normal_monos/pleading_face.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"249c728e-230f-4332-bbbf-281c271c75b2",sfxPitch:2,img:"/client-assets/drop-and-fusion/normal_monos/face_with_open_mouth.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"23d67613-d484-4a93-b71e-3e81b19d6186",sfxPitch:2.5,img:"/client-assets/drop-and-fusion/normal_monos/smiling_face_with_sunglasses.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"3cbd0add-ad7d-4685-bad0-29f6dddc0b99",sfxPitch:3,img:"/client-assets/drop-and-fusion/normal_monos/grinning_squinting_face.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"8f86d4f4-ee02-41bf-ad38-1ce0ae457fb5",sfxPitch:3.5,img:"/client-assets/drop-and-fusion/normal_monos/smiling_face_with_hearts.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"64ec4add-ce39-42b4-96cb-33908f3f118d",sfxPitch:4,img:"/client-assets/drop-and-fusion/normal_monos/heart_suit.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12}],r=[{id:"880f9bd9-802f-4135-a7e1-fd0e0331f726",sfxPitch:.25,img:"/client-assets/drop-and-fusion/yen_monos/10000yen.png",imgSizeX:512,imgSizeY:256,spriteScale:.97},{id:"e807beb6-374a-4314-9cc2-aa5f17d96b6b",sfxPitch:.5,img:"/client-assets/drop-and-fusion/yen_monos/5000yen.png",imgSizeX:512,imgSizeY:256,spriteScale:.97},{id:"033445b7-8f90-4fc9-beca-71a9e87cb530",sfxPitch:.75,img:"/client-assets/drop-and-fusion/yen_monos/2000yen.png",imgSizeX:512,imgSizeY:256,spriteScale:.97},{id:"410a09ec-5f7f-46f6-b26f-cbca4ccbd091",sfxPitch:1,img:"/client-assets/drop-and-fusion/yen_monos/1000yen.png",imgSizeX:512,imgSizeY:256,spriteScale:.97},{id:"2aae82bc-3fa4-49ad-a6b5-94d888e809f5",sfxPitch:1.5,img:"/client-assets/drop-and-fusion/yen_monos/500yen.png",imgSizeX:256,imgSizeY:256,spriteScale:.97},{id:"a619bd67-d08f-4cc0-8c7e-c8072a4950cd",sfxPitch:2,img:"/client-assets/drop-and-fusion/yen_monos/100yen.png",imgSizeX:256,imgSizeY:256,spriteScale:.97},{id:"c1c5d8e4-17d6-4455-befd-12154d731faa",sfxPitch:2.5,img:"/client-assets/drop-and-fusion/yen_monos/50yen.png",imgSizeX:256,imgSizeY:256,spriteScale:.97},{id:"7082648c-e428-44c4-887a-25c07a8ebdd5",sfxPitch:3,img:"/client-assets/drop-and-fusion/yen_monos/10yen.png",imgSizeX:256,imgSizeY:256,spriteScale:.97},{id:"0d8d40d5-e6e0-4d26-8a95-b8d842363379",sfxPitch:3.5,img:"/client-assets/drop-and-fusion/yen_monos/5yen.png",imgSizeX:256,imgSizeY:256,spriteScale:.97},{id:"9dec1b38-d99d-40de-8288-37367b983d0d",sfxPitch:4,img:"/client-assets/drop-and-fusion/yen_monos/1yen.png",imgSizeX:256,imgSizeY:256,spriteScale:.97}],n=[{id:"f75fd0ba-d3d4-40a4-9712-b470e45b0525",sfxPitch:.25,img:"/client-assets/drop-and-fusion/square_monos/keycap_10.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"7b70f4af-1c01-45fd-af72-61b1f01e03d1",sfxPitch:.5,img:"/client-assets/drop-and-fusion/square_monos/keycap_9.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"41607ef3-b6d6-4829-95b6-3737bf8bb956",sfxPitch:.75,img:"/client-assets/drop-and-fusion/square_monos/keycap_8.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"8a8310d2-0374-460f-bb50-ca9cd3ee3416",sfxPitch:1,img:"/client-assets/drop-and-fusion/square_monos/keycap_7.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"1092e069-fe1a-450b-be97-b5d477ec398c",sfxPitch:1.5,img:"/client-assets/drop-and-fusion/square_monos/keycap_6.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"2294734d-7bb8-4781-bb7b-ef3820abf3d0",sfxPitch:2,img:"/client-assets/drop-and-fusion/square_monos/keycap_5.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"ea8a61af-e350-45f7-ba6a-366fcd65692a",sfxPitch:2.5,img:"/client-assets/drop-and-fusion/square_monos/keycap_4.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"d0c74815-fc1c-4fbe-9953-c92e4b20f919",sfxPitch:3,img:"/client-assets/drop-and-fusion/square_monos/keycap_3.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"d8fbd70e-611d-402d-87da-1a7fd8cd2c8d",sfxPitch:3.5,img:"/client-assets/drop-and-fusion/square_monos/keycap_2.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12},{id:"35e476ee-44bd-4711-ad42-87be245d3efd",sfxPitch:4,img:"/client-assets/drop-and-fusion/square_monos/keycap_1.png",imgSizeX:256,imgSizeY:256,spriteScale:1.12}],p=[{id:"77f724c0-88be-4aeb-8e1a-a00ed18e3844",sfxPitch:.25,img:"/client-assets/drop-and-fusion/sweets_monos/shortcake_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"f3468ef4-2e1e-4906-8795-f147f39f7e1f",sfxPitch:.5,img:"/client-assets/drop-and-fusion/sweets_monos/pancakes_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"bcb41129-6f2d-44ee-89d3-86eb2df564ba",sfxPitch:.75,img:"/client-assets/drop-and-fusion/sweets_monos/shaved_ice_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"f058e1ad-1981-409b-b3a7-302de0a43744",sfxPitch:1,img:"/client-assets/drop-and-fusion/sweets_monos/soft_ice_cream_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"d22cfe38-5a3b-4b9c-a1a6-907930a3d732",sfxPitch:1.5,img:"/client-assets/drop-and-fusion/sweets_monos/doughnut_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"79867083-a073-427e-ae82-07a70d9f3b4f",sfxPitch:2,img:"/client-assets/drop-and-fusion/sweets_monos/custard_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"2e152a12-a567-4100-b4d4-d15d81ba47b1",sfxPitch:2.5,img:"/client-assets/drop-and-fusion/sweets_monos/chocolate_bar_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"12250376-2258-4716-8eec-b3a7239461fc",sfxPitch:3,img:"/client-assets/drop-and-fusion/sweets_monos/lollipop_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"4d4f2668-4be7-44a3-aa3a-856df6e25aa6",sfxPitch:3.5,img:"/client-assets/drop-and-fusion/sweets_monos/candy_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1},{id:"c9984b40-4045-44c3-b260-d47b7b4625b2",sfxPitch:4,img:"/client-assets/drop-and-fusion/sweets_monos/cookie_color.svg",imgSizeX:32,imgSizeY:32,spriteScale:1}],d=L,ae=i,N=xs(()=>d.gameMode==="normal"?a:d.gameMode==="square"?n:d.gameMode==="yen"?r:d.gameMode==="sweets"?p:d.gameMode==="space"?a:[]);function h(o){return o==="normal"||o==="square"?"pt":o==="yen"?"円":o==="sweets"?"kcal":""}function E(o){const e=N.value.find(c=>c.id===o.id);return{sprite:{texture:e.img,xScale:o.sizeX/e.imgSizeX*e.spriteScale,yScale:o.sizeY/e.imgSizeY*e.spriteScale}}}let H=1,$=Date.now().toString(),x=null,ne=null,Xe=0,W=null,F=null,le={},K={},ie=null,t=new ge({seed:$,gameMode:d.gameMode,getMonoRenderOptions:E});Ee();const Pe=Qe("containerEl"),V=Qe("canvasEl"),Fe=k(0),B=Ge(null),Ce=Ge([]),ve=Ge(null),T=k(0),_e=k(0),re=k(0),he=k(0),de=k(!0),q=k(!1),ye=k(!1),J=k("ready"),Z=k(null),te=k(null),Me=k(!1),I=k(!1),M=k(1),Oe=k(0),be=k(oe.s["game.dropAndFusion"].bgmVolume),O=k(oe.s["game.dropAndFusion"].sfxVolume);Te(M,o=>{t.replayPlaybackRate=o}),Te(be,o=>{W&&(W.gainNode.gain.value=d.mute?0:o)});function De(o){return y.Render.create({engine:o.engine,canvas:V.value,options:{width:o.GAME_WIDTH,height:o.GAME_HEIGHT,background:"transparent",wireframeBackground:"transparent",wireframes:!1,showSleeping:!1,pixelRatio:Math.max(2,window.devicePixelRatio)}})}function Le(){async function o(e){if(F==null||F.textures[e.img])return;let c=e.img;if(K[e.img])c=K[e.img];else if(le[e.img])c=URL.createObjectURL(le[e.img]),K[e.img]=c;else{const w=await(await window.fetch(e.img)).blob();le[e.img]=w,c=URL.createObjectURL(w),K[e.img]=c}const G=new Image;G.src=c,F.textures[e.img]=G}return Promise.all(N.value.map(e=>o(e)))}function xe(o){const e=N.value.find(c=>c.id===o.id);if(K[e.img])return K[e.img];if(le[e.img]){const c=URL.createObjectURL(le[e.img]);return K[e.img]=c,c}else return e.img}function He(){t.tick()?ie=window.requestAnimationFrame(He):ie=null}function Be(){let o;for(let e=0;e<M.value;e++){const c=ne.find(G=>G.frame===t.frame);if(c)switch(c.operation){case"drop":{t.drop(c.x);break}case"hold":{t.hold();break}case"surrender":{t.surrender();break}}if(o=t.tick(),Oe.value=t.frame,!o)break}o?ie=window.requestAnimationFrame(Be):ie=null}async function Ne(){F=De(t),await Le(),y.Render.lookAt(F,{min:{x:0,y:0},max:{x:t.GAME_WIDTH,y:t.GAME_HEIGHT}}),y.Render.run(F),t.start(),window.requestAnimationFrame(He),ye.value=!0,window.setTimeout(()=>{J.value="go",window.setTimeout(()=>{J.value=null},1e3)},1500)}function ls(o){if(!x||I.value)return;const e=(o.clientX-x.left)/H;t.drop(e)}function rs(o){if(!x||I.value)return;const e=(o.changedTouches[0].clientX-x.left)/H;t.drop(e)}function ds(o){if(!x)return;const e=o.clientX-x.left;Ue(x,e)}function cs(o){if(!x)return;const e=o.touches[0].clientX-x.left;Ue(x,e)}function Ue(o,e){Fe.value=Math.min(o.width*((t.GAME_WIDTH-t.PLAYAREA_MARGIN)/t.GAME_WIDTH),Math.max(o.width*(t.PLAYAREA_MARGIN/t.GAME_WIDTH),e))}function ms(){t.hold()}async function us(){const{canceled:o}=await Ps({type:"warning",text:"Weet je het zeker?"});o||t.surrender()}async function fs(){ps(),t=new ge({seed:$,gameMode:d.gameMode,getMonoRenderOptions:E}),Ee(),await Ne()}function ps(){ce(),$=Date.now().toString(),q.value=!1,I.value=!1,M.value=1,B.value=null,de.value=!0,Ce.value=[],ve.value=null,T.value=0,_e.value=0,re.value=0,he.value=0,ye.value=!1,J.value=null}function ce(){t.dispose(),F&&y.Render.stop(F),ie&&window.cancelAnimationFrame(ie)}function gs(){ae("end")}function vs(){I.value=!0,ce(),t=new ge({seed:$,gameMode:d.gameMode,getMonoRenderOptions:E}),Ee(),ss(Le(),async()=>{F=De(t),y.Render.lookAt(F,{min:{x:0,y:0},max:{x:t.GAME_WIDTH,y:t.GAME_HEIGHT}}),y.Render.run(F),t.start(),window.requestAnimationFrame(Be)})}function $e(){I.value=!1,ce()}function _s(){if(!ne)return;const o=JSON.stringify({v:t.GAME_VERSION,m:d.gameMode,s:$,d:new Date().toISOString(),l:ge.serializeLogs(ne)});Fs(o)}function We(o,e){const c={};c[o]=e,oe.commit("game.dropAndFusion",{...oe.s["game.dropAndFusion"],...c})}function Ve(o){return new Promise(e=>{const c=new Image;c.src=o,c.addEventListener("load",()=>{e(c)})})}function hs(){return new Promise(o=>{const e=window.document.createElement("canvas");e.width=t.GAME_WIDTH,e.height=t.GAME_HEIGHT;const c=e.getContext("2d");if(!c||!V.value)return o(null);Promise.all([Ve("/client-assets/drop-and-fusion/frame-light.svg"),Ve("/client-assets/drop-and-fusion/logo.png")]).then(G=>{const[l,w]=G;c.fillStyle="#fff",c.fillRect(0,0,t.GAME_WIDTH,t.GAME_HEIGHT),c.drawImage(l,0,0,t.GAME_WIDTH,t.GAME_HEIGHT),c.drawImage(V.value,0,0,t.GAME_WIDTH,t.GAME_HEIGHT),c.fillStyle="#000",c.font="16px bold sans-serif",c.textBaseline="top",c.fillText(`SCORE: ${T.value.toLocaleString()}${h(d.gameMode)}`,10,10),c.globalAlpha=.7,c.drawImage(w,t.GAME_WIDTH*.55,6,t.GAME_WIDTH*.45,t.GAME_WIDTH*.45*(w.height/w.width)),c.globalAlpha=1,e.toBlob(Y=>{if(!Y||is==null)return o(null);const R=new FormData;R.append("file",Y),R.append("name",`bubble-game-${Date.now()}.png`),R.append("isSensitive","false"),R.append("i",is.token),oe.s.uploadFolder&&R.append("folderId",oe.s.uploadFolder),window.fetch(Us+"/drive/files/create",{method:"POST",body:R}).then(j=>j.json()).then(j=>{o(j)})},"image/png"),e.remove()})})}async function ys(){const o=hs();ss(o);const e=await o;e&&Os({initialText:`#BubbleGame (${d.gameMode})
SCORE: ${T.value.toLocaleString()}${h(d.gameMode)}`,initialFiles:[e],instant:!0})}function Ee(){t.addListener("changeScore",l=>{T.value=l}),t.addListener("changeCombo",l=>{l===0?re.value=_e.value:re.value=l,he.value=Math.max(he.value,l),_e.value=l}),t.addListener("changeStock",l=>{B.value=JSON.parse(JSON.stringify(l[0])),Ce.value=JSON.parse(JSON.stringify(l.slice(1)))}),t.addListener("changeHolding",l=>{ve.value=l,d.mute||U("/client-assets/drop-and-fusion/hold.mp3",{volume:.5*O.value,playbackRate:M.value})}),t.addListener("dropped",l=>{if(!d.mute){const w=l-t.PLAYAREA_MARGIN,Y=t.GAME_WIDTH-t.PLAYAREA_MARGIN-t.PLAYAREA_MARGIN,R=(w/Y-.5)*2;d.gameMode==="yen"?U("/client-assets/drop-and-fusion/drop_yen.mp3",{volume:O.value,pan:R,playbackRate:M.value}):U("/client-assets/drop-and-fusion/drop.mp3",{volume:O.value,pan:R,playbackRate:M.value})}I.value||(de.value=!1,window.setTimeout(()=>{q.value||(de.value=!0)},t.frameToMs(t.DROP_COOLTIME)))}),t.addListener("fusioned",(l,w,Y,R)=>{if(!V.value)return;const j=V.value.getBoundingClientRect(),Se=j.left+l*H,me=j.top+w*H,ue=h(d.gameMode);{const{dispose:fe}=Ze(Is,{x:Se,y:me},{end:()=>fe()})}{const{dispose:fe}=Ze($s,{x:Se,y:me,value:R+(ue==="pt"?"":ue)},{end:()=>fe()})}if(Y){const fe=N.value.find(Ie=>Ie.id===Y.id);if(!d.mute){const Ie=l-t.PLAYAREA_MARGIN,bs=t.GAME_WIDTH-t.PLAYAREA_MARGIN-t.PLAYAREA_MARGIN,qe=(Ie/bs-.5)*2,je=fe.sfxPitch;d.gameMode==="yen"?U("/client-assets/drop-and-fusion/fusion_yen.mp3",{volume:.25*O.value,pan:qe,playbackRate:je/4*M.value}):U("/client-assets/drop-and-fusion/fusion.mp3",{volume:O.value,pan:qe,playbackRate:je*M.value})}}else d.mute});const o=2.5,e=9,c=4,G=.5;t.addListener("collision",(l,w,Y)=>{if(!d.mute&&l>o){const R=Math.min(e,l-o)/e/4,j=w.label==="_wall_"?Y.position.x-t.PLAYAREA_MARGIN:Y.label==="_wall_"?w.position.x-t.PLAYAREA_MARGIN:(w.position.x+Y.position.x)/2-t.PLAYAREA_MARGIN,Se=t.GAME_WIDTH-t.PLAYAREA_MARGIN-t.PLAYAREA_MARGIN,me=(j/Se-.5)*2,ue=G+(c-G)*(1-Math.min(10,l)/10);d.gameMode==="yen"?U("/client-assets/drop-and-fusion/collision_yen.mp3",{volume:R*O.value,pan:me,playbackRate:Math.max(1,ue)*M.value}):U("/client-assets/drop-and-fusion/collision.mp3",{volume:R*O.value,pan:me,playbackRate:ue*M.value})}}),t.addListener("monoAdded",l=>{I.value||l.level===10&&(es("bubbleGameExplodingHead"),t.getActiveMonos().filter(Y=>Y.level===10).length>=2&&es("bubbleGameDoubleExplodingHead"))}),t.addListener("gameOver",()=>{if(d.mute||(d.gameMode==="yen"?U("/client-assets/drop-and-fusion/gameover_yen.mp3",{volume:.5*O.value}):U("/client-assets/drop-and-fusion/gameover.mp3",{volume:O.value})),I.value){$e();return}ne=t.getLogs(),Xe=t.frame,B.value=null,de.value=!1,q.value=!0,pe("bubble-game/register",{seed:$,score:T.value,gameMode:d.gameMode,gameVersion:t.GAME_VERSION,logs:ge.serializeLogs(ne)}),d.gameMode==="yen"&&(te.value=(te.value??0)+T.value,pe("i/registry/set",{scope:["dropAndFusionGame"],key:"yenTotal",value:te.value})),T.value>(Z.value??0)&&(Z.value=T.value,pe("i/registry/set",{scope:["dropAndFusionGame"],key:"highScore:"+d.gameMode,value:Z.value}))})}return Gs(()=>{if(!V.value)return;const o=V.value.getBoundingClientRect().width;o!==0&&(H=o/t.GAME_WIDTH,x=Pe.value?.getBoundingClientRect()??null)},1e3,{immediate:!1,afterMounted:!0}),Ss(async()=>{try{Z.value=await pe("i/registry/get",{scope:["dropAndFusionGame"],key:"highScore:"+d.gameMode})}catch{Z.value=null}if(d.gameMode==="yen")try{te.value=await pe("i/registry/get",{scope:["dropAndFusionGame"],key:"yenTotal"})}catch(e){if(e.code!=="NO_SUCH_KEY"){Rs({type:"error",text:"Unable to load"});return}}await Ne();const o=await Ts("/client-assets/drop-and-fusion/bgm_1.mp3");o&&(W=Ys(o,{volume:d.mute?0:be.value}),W&&(W.soundSource.loop=!0,W.soundSource.start()))}),zs(()=>{ce(),W?.soundSource.stop()}),As(()=>{ce(),W?.soundSource.stop()}),ns(()=>({title:"Bubble Game",icon:"ti ti-apple"})),(o,e)=>{const c=we("MkEllipsis"),G=we("I18n");return f(),g("div",si,[s("div",{class:"xEKi2"},[ye.value?C("",!0):(f(),g("div",{key:0,class:"xzQYe"},[s("div",null,[_(u("Loading"),1),v(c)])],2)),Ke(s("div",ii,[J.value==="ready"?(f(),g("div",{key:0,class:"xw98m"},null,2)):C("",!0),v(Ae,{enterActiveClass:"x1hnn",leaveActiveClass:"xCnuA",enterFromClass:"x4rl1",leaveToClass:"xc1Ct",moveClass:"xsVlS",mode:"default"},{default:b(()=>[J.value==="ready"?(f(),g("div",{key:0,class:"xF2Qy"},[s("img",{src:Ws,class:"xsuPS"},null,2)],2)):J.value==="go"?(f(),g("div",{key:1,class:"xtoSh"},[s("img",{src:Vs,class:"xsuPS"},null,2)],2)):C("",!0)]),_:1},8,["enterActiveClass","leaveActiveClass","enterFromClass","leaveToClass","moveClass"]),s("div",{class:"xzsJ6"},[s("div",{class:"_woodenFrame xDCpg"},[s("div",ti,[s("b",null,u("Bubble Game"),1),s("div",null,"- "+u(L.gameMode.toUpperCase())+" -",1)])],2),s("div",oi,[s("div",ai,[v(D,{inline:"",small:"",onClick:ms},{default:b(()=>[_(u("Hold"),1)]),_:1}),ve.value?(f(),g("img",{key:0,src:xe(ve.value.mono),style:{width:"32px","margin-left":"8px","vertical-align":"bottom"}},null,8,ni)):C("",!0)]),s("div",{class:"_woodenFrameInner xkQPp",style:{"text-align":"center"}},[v(ws,{enterActiveClass:"x2xb8",leaveActiveClass:"xjlWU",enterFromClass:"xEzD1",leaveToClass:"x9vKF",moveClass:"xji25"},{default:b(()=>[(f(!0),g(ke,null,Ye(Ce.value,l=>(f(),g("img",{key:l.id,src:xe(l.mono),style:{width:"32px","vertical-align":"bottom"}},null,8,li))),128))]),_:1},8,["enterActiveClass","leaveActiveClass","enterFromClass","leaveToClass","moveClass"])],2)])],2),s("div",{ref_key:"containerEl",ref:Pe,class:ks(["xWrlX",{xDEcp:q.value&&!I.value}]),onContextmenu:e[0]||(e[0]=Re(()=>{},["stop","prevent"])),onClick:Re(ls,["stop","prevent"]),onTouchmove:Re(cs,["stop","prevent"]),onTouchend:rs,onMousemove:ds},[P(Xs).s.darkMode?(f(),g("img",{key:0,src:qs,class:"xngwC"},null,2)):(f(),g("img",{key:1,src:js,class:"xngwC"},null,2)),s("canvas",{ref_key:"canvasEl",ref:V,class:"x8W2t"},null,2),v(Ae,{enterActiveClass:"x5elE",leaveActiveClass:"xfdJa",enterFromClass:"xiULI",leaveToClass:"xhCw3",moveClass:"xeDIB"},{default:b(()=>[Ke(s("div",{class:"xyxJp",style:ze({fontSize:`${100+(re.value-2)*15}%`})},u(re.value)+" Chain!",7),[[Je,_e.value>1]])]),_:1},8,["enterActiveClass","leaveActiveClass","enterFromClass","leaveToClass","moveClass"]),!q.value&&!I.value&&J.value!=="ready"?(f(),g("div",{key:2,class:"xygUw",style:ze({left:Fe.value+"px"})},[v(Ae,{enterActiveClass:"x8OGv",leaveActiveClass:"x5CPu",enterFromClass:"xtqH6",leaveToClass:"xyMj7",moveClass:"xktms",mode:"out-in"},{default:b(()=>[B.value?(f(),g("img",{key:B.value.id,src:xe(B.value.mono),class:"xsAFy",style:ze({marginBottom:-(B.value?.mono.sizeY*P(H)/2)+"px",left:-(B.value?.mono.sizeX*P(H)/2)+"px",width:`${B.value?.mono.sizeX*P(H)}px`})},null,14,ri)):C("",!0)]),_:1},8,["enterActiveClass","leaveActiveClass","enterFromClass","leaveToClass","moveClass"]),de.value&&B.value?(f(),g(ke,{key:0},[s("img",{src:Qs,class:"xwENW"},null,2),s("div",{class:"xlctT"},null,2)],64)):C("",!0)],6)):C("",!0),q.value&&!I.value?(f(),g("div",{key:3,class:"x5fg7"},[s("div",di,[e[8]||(e[8]=s("img",{src:Ks,style:{width:"200px","max-width":"100%",display:"block",margin:"auto","margin-bottom":"-5px"}},null,-1)),s("div",null,[_(u("Score")+": ",1),v(ee,{value:T.value},null,8,["value"]),_(u(h(L.gameMode)),1)]),s("div",null,[_(u("Maximum number of chains")+": ",1),v(ee,{value:he.value},null,8,["value"])]),L.gameMode==="yen"?(f(),g("div",ci,[_(u("Amount of money earned")+": ",1),v(G,{src:"{yen} Yen",tag:"b"},{yen:b(()=>[v(ee,{value:te.value??T.value},null,8,["value"])]),_:1},8,["src"])])):C("",!0),L.gameMode==="sweets"?(f(),se(G,{key:1,src:"{onigiriQtyWithUnit} Onigiri",tag:"div"},{onigiriQtyWithUnit:b(()=>[v(G,{src:"{qty} Pieces",tag:"b"},{qty:b(()=>[v(ee,{value:T.value/130},null,8,["value"])]),_:1},8,["src"])]),_:1},8,["src"])):C("",!0)])],2)):C("",!0),I.value?(f(),g("div",{key:4,class:"xuxz0"},[s("span",{class:"xvU4G"},[e[9]||(e[9]=s("i",{class:"ti ti-player-play"},null,-1)),_(" "+u("Showing replay"),1)],2)],2)):C("",!0)],34),I.value?(f(),g("div",mi,[s("div",ui,[s("div",fi,[s("div",{style:ze([{height:"10px",background:"var(--MI_THEME-accent)","will-change":"width"},{width:`${Oe.value/P(Xe)*100}%`}])},null,4)])]),s("div",pi,[s("div",gi,[v(D,{onClick:$e},{default:b(()=>[e[10]||(e[10]=s("i",{class:"ti ti-player-stop"},null,-1)),_(" "+u("Exit Replay"),1)]),_:1}),v(D,{primary:M.value===4,onClick:e[1]||(e[1]=l=>M.value=M.value===4?1:4)},{default:b(()=>[...e[11]||(e[11]=[s("i",{class:"ti ti-player-track-next"},null,-1),_(" x4",-1)])]),_:1},8,["primary"]),v(D,{primary:M.value===16,onClick:e[2]||(e[2]=l=>M.value=M.value===16?1:16)},{default:b(()=>[...e[12]||(e[12]=[s("i",{class:"ti ti-player-track-next"},null,-1),_(" x16",-1)])]),_:1},8,["primary"])])])])):C("",!0),q.value?(f(),g("div",vi,[s("div",_i,[s("div",hi,[v(D,{primary:"",rounded:"",onClick:gs},{default:b(()=>[_(u("Go back to title"),1)]),_:1}),v(D,{primary:"",rounded:"",onClick:vs},{default:b(()=>[_(u("View Replay"),1)]),_:1}),v(D,{primary:"",rounded:"",onClick:ys},{default:b(()=>[_(u("Delen"),1)]),_:1}),v(D,{rounded:"",onClick:_s},{default:b(()=>[_(u("Copy replay data"),1)]),_:1})])])])):C("",!0),s("div",yi,[s("div",bi,[s("div",xi,[s("div",null,[_(u("Score")+": ",1),v(ee,{value:T.value},null,8,["value"]),_(u(h(L.gameMode)),1)]),s("div",null,[_(u("High score")+": ",1),Z.value?(f(),g("b",Si,[v(ee,{value:Z.value},null,8,["value"]),_(u(h(L.gameMode)),1)])):(f(),g("b",zi,"-"))]),L.gameMode==="yen"?(f(),g("div",Ai,[_(u("Amount of money earned")+": ",1),v(G,{src:"{yen} Yen",tag:"b"},{yen:b(()=>[v(ee,{value:te.value??T.value},null,8,["value"])]),_:1},8,["src"])])):C("",!0)])]),s("div",ki,[s("div",wi,[s("div",{onClick:e[3]||(e[3]=l=>Me.value=!Me.value)},[...e[13]||(e[13]=[s("i",{class:"ti ti-settings"},null,-1)])])])])]),Me.value?(f(),g("div",Ci,[s("div",Mi,[s("div",Ei,[v(ts,{modelValue:be.value,"onUpdate:modelValue":e[4]||(e[4]=l=>be.value=l),min:0,max:1,step:.01,textConverter:l=>`${Math.floor(l*100)}%`,continuousUpdate:!0,onDragEnded:e[5]||(e[5]=l=>We("bgmVolume",l))},{label:b(()=>[_("BGM "+u("Volume"),1)]),_:1},8,["modelValue","textConverter"]),v(ts,{modelValue:O.value,"onUpdate:modelValue":e[6]||(e[6]=l=>O.value=l),min:0,max:1,step:.01,textConverter:l=>`${Math.floor(l*100)}%`,continuousUpdate:!0,onDragEnded:e[7]||(e[7]=l=>We("sfxVolume",l))},{label:b(()=>[_(u("Sound Effects")+" "+u("Volume"),1)]),_:1},8,["modelValue","textConverter"])])])])):C("",!0),s("div",Ii,[s("div",Gi,[e[15]||(e[15]=s("div",null,"FUSION RECIPE",-1)),s("div",null,[(f(!0),g(ke,null,Ye(P(t).monoDefinitions.sort((l,w)=>l.level-w.level),(l,w)=>(f(),g("div",{key:l.id,style:{display:"inline-block"}},[s("img",{src:xe(l),style:{width:"32px","vertical-align":"bottom"}},null,8,Ri),w<P(t).monoDefinitions.length-1?(f(),g("div",Ti,[...e[14]||(e[14]=[s("i",{class:"ti ti-arrow-big-right"},null,-1)])])):C("",!0)]))),128))])])]),s("div",Yi,[s("div",Xi,[!q.value&&!I.value?(f(),se(D,{key:0,full:"",danger:"",onClick:us},{default:b(()=>[_(u("Cancel"),1)]),_:1})):(f(),se(D,{key:1,full:"",onClick:fs},{default:b(()=>[_(u("Retry"),1)]),_:1}))])])],512),[[Je,ye.value]])],2)])}}});const Fi={key:0,class:"_spacer",style:{"--MI_SPACER-w":"800px"}},Oi={class:"_gaps"},Di={class:"_woodenFrame",style:{"text-align":"center"}},Li={class:"_woodenFrameInner"},Hi={class:"_gaps",style:{padding:"16px"}},Bi={class:"_woodenFrameInner"},Ni={class:"_gaps",style:{padding:"16px"}},Ui={style:{"font-size":"90%"}},$i={class:"_woodenFrame"},Wi={class:"_woodenFrameInner"},Vi={class:"_gaps_s",style:{padding:"16px"}},qi={key:0,class:"_gaps_s"},ji={style:{"margin-left":"auto"}},Qi={key:1},Ki={class:"_woodenFrame"},Ji={class:"_woodenFrameInner",style:{padding:"16px"}},Zi={style:{"font-weight":"bold"}},pt=as({__name:"drop-and-fusion",setup(L){const{model:i,def:a}=Ds({items:[{label:"NORMAL",value:"normal"},{label:"SQUARE",value:"square"},{label:"YEN",value:"yen"},{label:"SWEETS",value:"sweets"}],initialValue:"normal"}),r=k(!1),n=k(!1),p=k(null);Te(i,async()=>{p.value=await Bs("bubble-game/ranking",{gameMode:i.value})},{immediate:!0});function d(h){return h==="normal"||h==="square"?"pt":h==="yen"?"円":h==="sweets"?"kcal":h==="space"?"pt":""}async function ae(){r.value=!0}function N(){r.value=!1}return ns(()=>({title:"Bubble Game",icon:"ti ti-device-gamepad"})),(h,E)=>{const H=we("MkAvatar"),$=we("MkUserName");return f(),se(Ae,{enterActiveClass:"xrKik",leaveActiveClass:"xlBdU",enterFromClass:"xn05N",leaveToClass:"xmcui",moveClass:"xUBnX",mode:"out-in"},{default:b(()=>[r.value?(f(),se(Pi,{key:1,gameMode:P(i),mute:n.value,onEnd:N},null,8,["gameMode","mute"])):(f(),g("div",Fi,[s("div",{class:"xl0WF"},[s("div",Oi,[E[3]||(E[3]=s("div",{class:"_woodenFrame",style:{"text-align":"center"}},[s("div",{class:"_woodenFrameInner"},[s("img",{src:Ms,style:{display:"block","max-width":"100%","max-height":"200px",margin:"auto"}})])],-1)),s("div",Di,[s("div",Li,[s("div",Hi,[v(Ls,{modelValue:P(i),"onUpdate:modelValue":E[0]||(E[0]=x=>Cs(i)?i.value=x:null),items:P(a)},null,8,["modelValue","items"]),v(D,{primary:"",gradate:"",large:"",rounded:"",inline:"",onClick:ae},{default:b(()=>[_(u("Aan de slag"),1)]),_:1})])]),s("div",Bi,[s("div",Ni,[s("div",Ui,[E[2]||(E[2]=s("i",{class:"ti ti-music"},null,-1)),_(" "+u("Sound will be played"),1)]),v(Hs,{modelValue:n.value,"onUpdate:modelValue":E[1]||(E[1]=x=>n.value=x)},{label:b(()=>[_(u("Dempen"),1)]),_:1},8,["modelValue"])])])]),s("div",$i,[s("div",Wi,[s("div",Vi,[s("div",null,[s("b",null,u((({n})=>("Last "+n+" days"))({n:7}))+" "+u("Ranking"),1),_(" ("+u(P(i).toUpperCase())+")",1)]),p.value?(f(),g("div",qi,[(f(!0),g(ke,null,Ye(p.value,x=>(f(),g("div",{key:x.id,class:"xEHc8"},[x.user?(f(),se(H,{key:0,link:!0,style:{width:"24px",height:"24px","margin-right":"4px"},user:x.user},null,8,["user"])):C("",!0),x.user?(f(),se($,{key:1,user:x.user,nowrap:!0},null,8,["user"])):C("",!0),s("b",ji,u(x.score.toLocaleString())+" "+u(d(P(i))),1)],2))),128))])):(f(),g("div",Qi,u("Loading"),1))])])]),s("div",Ki,[s("div",Ji,[s("div",Zi,u("How to play"),1),s("ol",null,[s("li",null,u("Adjust the position and drop the object into the box."),1),s("li",null,u("When two objects of the same type touch each other, they will change into a different object and you score points."),1),s("li",null,u("The game is over when objects overflow from the box. Aim for a high score by fusing objects together while you avoid overflowing the box!"),1)])])]),E[4]||(E[4]=s("div",{class:"_woodenFrame"},[s("div",{class:"_woodenFrameInner"},[s("div",{class:"_gaps_s",style:{padding:"16px"}},[s("div",null,[s("b",null,"Credit")]),s("div",null,[s("div",null,"Ai-chan illustration: @poteriri@misskey.io"),s("div",null,"BGM: @ys@misskey.design")])])])],-1))])],2)]))]),_:1},8,["enterActiveClass","leaveActiveClass","enterFromClass","leaveToClass","moveClass"])}}});export{pt as default};
